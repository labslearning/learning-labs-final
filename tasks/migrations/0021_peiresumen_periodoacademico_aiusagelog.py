# Generated by Django 5.2 on 2025-12-17 18:11

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('tasks', '0020_securitylog'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='PEIResumen',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('version', models.CharField(help_text='Ej: v2025.1 - Actualizaci贸n Manual Convivencia', max_length=50, unique=True)),
                ('fecha_creacion', models.DateTimeField(auto_now_add=True)),
                ('activo', models.BooleanField(default=True, help_text="Solo una versi贸n del PEI es la 'Verdad Absoluta' a la vez.")),
                ('contenido_estructurado', models.JSONField(default=dict, help_text='JSON estructurado con Misi贸n, Visi贸n, Ejes, Evaluaci贸n y Convivencia.')),
                ('comentarios_cambio', models.TextField(blank=True, help_text='Justificaci贸n de los cambios en esta versi贸n (Auditor铆a).')),
            ],
            options={
                'verbose_name': 'Conocimiento PEI (JSON)',
                'verbose_name_plural': 'Versiones del PEI',
                'ordering': ['-fecha_creacion'],
            },
        ),
        migrations.CreateModel(
            name='PeriodoAcademico',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre', models.CharField(help_text='Ej: 2025-1, A帽o Lectivo 2025, Trimestre 2', max_length=100, unique=True)),
                ('fecha_inicio', models.DateField(help_text='Fecha oficial de inicio del periodo acad茅mico')),
                ('fecha_fin', models.DateField(help_text='Fecha oficial de finalizaci贸n del periodo acad茅mico')),
                ('activo', models.BooleanField(default=False, help_text=' CRTICO: Solo un periodo puede estar activo. Al activar este, se desactivan los dem谩s.')),
                ('limite_intentos_profesor', models.IntegerField(default=10, help_text='Intentos de IA profunda (DeepSeek) permitidos por periodo para docentes.')),
                ('limite_intentos_estudiante', models.IntegerField(default=2, help_text='Intentos de IA profunda permitidos por periodo para estudiantes.')),
                ('limite_intentos_acudiente', models.IntegerField(default=1, help_text='Intentos de IA para orientaci贸n familiar por periodo.')),
                ('limite_intentos_staff', models.IntegerField(default=50, help_text='Intentos para Staff (Psicolog铆a/Coord) para an谩lisis institucional.')),
                ('creado_en', models.DateTimeField(auto_now_add=True)),
                ('cerrado_en', models.DateTimeField(blank=True, help_text='Fecha en que el periodo fue cerrado institucionalmente', null=True)),
            ],
            options={
                'verbose_name': 'Periodo Acad茅mico (Governance)',
                'verbose_name_plural': 'Periodos Acad茅micos (Governance)',
                'ordering': ['-fecha_inicio'],
            },
        ),
        migrations.CreateModel(
            name='AIUsageLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('fecha', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('rol_usado', models.CharField(choices=[('DOCENTE', 'DOCENTE'), ('ESTUDIANTE', 'ESTUDIANTE'), ('ACUDIENTE', 'ACUDIENTE'), ('STAFF', 'STAFF'), ('ADMINISTRADOR', 'ADMINISTRADOR')], help_text='El rol con el que el usuario firm贸 la petici贸n (Docente, Estudiante, etc).', max_length=50)),
                ('accion', models.CharField(choices=[('mejoras_estudiante', 'mejoras_estudiante'), ('orientacion_curso', 'orientacion_curso'), ('chat_socratico', 'chat_socratico'), ('analisis_convivencia', 'analisis_convivencia'), ('cumplimiento_pei', 'cumplimiento_pei')], help_text='La intenci贸n pedag贸gica (Intents).', max_length=50)),
                ('modelo_utilizado', models.CharField(default='deepseek-chat', max_length=50)),
                ('tokens_entrada', models.IntegerField(default=0, help_text='Contexto + Prompt (Lo que enviamos)')),
                ('tokens_salida', models.IntegerField(default=0, help_text='Respuesta generada (Lo que recibimos)')),
                ('tiempo_ejecucion', models.FloatField(default=0.0, help_text='Segundos que tard贸 la respuesta')),
                ('exitoso', models.BooleanField(default=True)),
                ('error_mensaje', models.TextField(blank=True, help_text='Si fall贸, aqu铆 guardamos el stacktrace o mensaje de error de la API.', null=True)),
                ('metadata_tecnica', models.JSONField(blank=True, default=dict, help_text='Datalles t茅cnicos: pei_version, razon_fallo, intentos_restantes, costo_estimado_usd.')),
                ('usuario', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='ai_logs', to=settings.AUTH_USER_MODEL)),
                ('periodo', models.ForeignKey(help_text='Periodo acad茅mico activo durante la consulta.', null=True, on_delete=django.db.models.deletion.PROTECT, to='tasks.periodoacademico')),
            ],
            options={
                'verbose_name': 'Log de Uso IA',
                'verbose_name_plural': 'Auditor铆a de IA',
                'ordering': ['-fecha'],
                'indexes': [models.Index(fields=['usuario', 'periodo'], name='tasks_aiusa_usuario_00c5b6_idx'), models.Index(fields=['rol_usado', 'fecha'], name='tasks_aiusa_rol_usa_4fd858_idx')],
            },
        ),
    ]
