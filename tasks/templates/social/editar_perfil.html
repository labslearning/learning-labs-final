{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<style>
    /* --- Estilos Académicos y Profesionales --- */
    :root {
        --bg-body: #f4f6f9;
        --card-border: #e9ecef;
        --text-primary: #343a40;
        --text-muted: #6c757d;
        --edu-primary: #0d6efd;
    }

    body {
        background-color: var(--bg-body);
    }

    /* Cabecera */
    .edit-profile-header {
        background: white;
        border-bottom: 1px solid var(--card-border);
        padding: 1.5rem 0;
        margin-bottom: 2rem;
    }

    /* Tarjetas */
    .form-section-card {
        background: white;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .section-title {
        color: var(--text-primary);
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #f0f2f5;
        padding-bottom: 10px;
        display: flex;
        align-items: center;
    }

    .section-title i {
        color: var(--edu-primary);
        margin-right: 10px;
        background: rgba(13, 110, 253, 0.1);
        padding: 8px;
        border-radius: 6px;
    }

    /* --- Previsualización e Inputs de Archivo Personalizados --- */
    .cover-upload-wrapper {
        position: relative;
        margin-bottom: 15px;
    }

    .cover-upload-preview {
        width: 100%;
        height: 160px;
        background-color: #e9ecef;
        border-radius: 8px;
        object-fit: cover;
        border: 2px dashed #ced4da;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #adb5bd;
    }

    /* Botón personalizado para subir portada */
    .btn-upload-cover {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0,0,0,0.6);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background 0.2s;
    }
    
    .btn-upload-cover:hover {
        background: rgba(0,0,0,0.8);
    }

    /* Ocultar el input file real pero mantenerlo funcional */
    .hidden-file-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 10; /* Asegura que esté por encima para recibir el clic */
    }


    /* Avatar Styles */
    .avatar-wrapper {
        text-align: center;
        margin-top: -50px;
        margin-bottom: 15px;
        position: relative;
        display: inline-block;
        left: 50%;
        transform: translateX(-50%);
    }

    .avatar-upload-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        background-color: white;
        display: block;
    }

    .avatar-placeholder {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background-color: #6c757d;
        color: white;
        font-size: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Botón pequeño de cámara para el avatar */
    .btn-upload-avatar {
        position: absolute;
        bottom: 0;
        right: 0;
        background: var(--edu-primary);
        color: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        cursor: pointer;
        z-index: 11; /* Encima del input del avatar */
        pointer-events: none; /* Dejamos que el clic pase al input que pondremos encima */
    }

    .avatar-file-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        opacity: 0;
        cursor: pointer;
        z-index: 12;
    }

    .form-label {
        font-weight: 600;
        font-size: 0.9rem;
        color: #495057;
    }
    
    .form-text {
        font-size: 0.8rem;
        color: var(--text-muted);
    }
    
    /* Inputs de texto estilo Bootstrap */
    .form-control {
        border-radius: 6px;
        border-color: #ced4da;
    }
    .form-control:focus {
        border-color: var(--edu-primary);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }
</style>

<div class="edit-profile-header">
    <div class="container">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h2 class="fw-bold mb-1">Configuración de Perfil</h2>
                <p class="text-muted mb-0">Personaliza tu identidad digital y académica.</p>
            </div>
            <a href="{% url 'ver_perfil_social' username=user.username %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver al Perfil
            </a>
        </div>
    </div>
</div>

<div class="container pb-5">
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-lg-4">
                
                <div class="form-section-card pt-0 px-0 overflow-hidden">
                    <div class="p-3 bg-light border-bottom mb-3">
                        <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-images me-2"></i>Imágenes</h5>
                    </div>
                    
                    <div class="px-4 pb-4 position-relative">
                        
                        <div class="mb-1">
                            <label class="form-label small text-muted">Foto de Portada</label>
                            <div class="cover-upload-wrapper">
                                {% if user.perfil.foto_portada %}
                                    <img src="{{ user.perfil.foto_portada.url }}" class="cover-upload-preview" id="coverPreview" alt="Portada">
                                {% else %}
                                    <div class="cover-upload-preview" id="coverPreviewContainer">
                                        <div class="text-center">
                                            <i class="fas fa-image fa-2x mb-2"></i><br>Sin portada
                                        </div>
                                    </div>
                                {% endif %}
                                
                                <span class="btn-upload-cover">
                                    <i class="fas fa-camera me-1"></i> Cambiar
                                </span>

                                {{ profile_form.foto_portada|add_class:"hidden-file-input"|attr:"onchange:previewImage(this, 'coverPreview')" }}
                            </div>
                        </div>

                        <div class="avatar-wrapper">
                            {% if user.perfil.foto_perfil %}
                                <img src="{{ user.perfil.foto_perfil.url }}" class="avatar-upload-preview" id="avatarPreview" alt="Avatar">
                            {% else %}
                                <div class="avatar-placeholder" id="avatarPreviewContainer">
                                    {{ user.username|slice:":1"|upper }}
                                </div>
                            {% endif %}
                            
                            <div class="btn-upload-avatar">
                                <i class="fas fa-camera small"></i>
                            </div>

                            {{ profile_form.foto_perfil|add_class:"avatar-file-input"|attr:"onchange:previewImage(this, 'avatarPreview')" }}
                        </div>
                        
                        <div class="text-center">
                            <small class="text-muted">Haz clic en la imagen para cambiarla.</small>
                        </div>
                    </div>
                </div>

                <div class="form-section-card">
                    <h5 class="section-title"><i class="fas fa-user-shield"></i> Datos de Cuenta</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        {{ user_form.first_name|add_class:"form-control" }}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Apellido</label>
                        {{ user_form.last_name|add_class:"form-control" }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Correo Electrónico</label>
                        {{ user_form.email|add_class:"form-control" }}
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                
                <div class="form-section-card">
                    <h5 class="section-title"><i class="fas fa-pen-fancy"></i> Presentación Personal</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Biografía</label>
                        {{ profile_form.biografia|add_class:"form-control"|attr:"rows:3" }}
                        <div class="form-text">Comparte una breve descripción sobre quién eres.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Mis Hobbies</label>
                        {{ profile_form.hobbies|add_class:"form-control"|attr:"rows:2" }}
                        <div class="form-text">Ej: Fútbol, Pintura, Programación...</div>
                    </div>
                </div>

                <div class="form-section-card">
                    <h5 class="section-title"><i class="fas fa-heart"></i> Intereses y Metas</h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-music me-1 text-muted"></i> Música Favorita</label>
                            {{ profile_form.gustos_musicales|add_class:"form-control"|attr:"rows:2" }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-book me-1 text-muted"></i> Libros Favoritos</label>
                            {{ profile_form.libros_favoritos|add_class:"form-control"|attr:"rows:2" }}
                        </div>
                        
                        <div class="col-12"><hr class="my-3 text-muted"></div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-graduation-cap me-1 text-muted"></i> Materia Favorita</label>
                            {{ profile_form.materia_favorita|add_class:"form-control" }}
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label"><i class="fas fa-bullseye me-1 text-muted"></i> Metas para este Año</label>
                            {{ profile_form.metas_anio|add_class:"form-control"|attr:"rows:2" }}
                            <div class="form-text">Define tus objetivos académicos o personales para este ciclo escolar.</div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-3 mt-4">
                    <a href="{% url 'ver_perfil_social' username=user.username %}" class="btn btn-outline-secondary px-4">Cancelar</a>
                    <button type="submit" class="btn btn-primary px-5 fw-bold shadow-sm">
                        <i class="fas fa-save me-2"></i> Guardar Cambios
                    </button>
                </div>

                {% if user_form.errors or profile_form.errors %}
                    <div class="alert alert-danger mt-4 shadow-sm border-0">
                        <h5 class="alert-heading fs-6 fw-bold"><i class="fas fa-exclamation-circle me-2"></i>Atención:</h5>
                        <ul class="mb-0 small ps-3">
                            {% for field in user_form %}
                                {% for error in field.errors %}<li>{{ field.label }}: {{ error }}</li>{% endfor %}
                            {% endfor %}
                            {% for field in profile_form %}
                                {% for error in field.errors %}<li>{{ field.label }}: {{ error }}</li>{% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

            </div>
        </div>
    </form>
</div>

<script>
    function previewImage(input, previewId) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var preview = document.getElementById(previewId);
                // Si existía un placeholder en lugar de img, lo reemplazamos o actualizamos
                // (Para simplificar, este script asume que ya hay una etiqueta <img> o que se recarga la página)
                // Una mejora real sería reemplazar el div placeholder con un img dinámicamente.
                if(preview && preview.tagName === 'IMG') {
                     preview.src = e.target.result;
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>
{% endblock %}