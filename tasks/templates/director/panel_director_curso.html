{% extends 'base.html' %}
{% load dict_filters %}

{% block content %}
<div class="container py-5">
    <div class="card p-4 shadow-lg animate__animated animate__fadeInUp">
        <div class="card-header bg-primary text-white p-4 rounded-top-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0 fw-bold"><i class="fas fa-user-tie me-3"></i>Panel de Dirección</h2>
                    <p class="mb-0 fs-5">Gestión de Curso: {{ curso.nombre }}</p>
                </div>
                <a href="{% url 'dashboard_director' %}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-1"></i> Volver al Dashboard
                </a>
            </div>
        </div>
        <div class="card-body p-4">
            <h3 class="mb-4 text-center text-dark">Notas Finales y Convivencia</h3>
            {% if estudiantes %}
            <form action="{% url 'guardar_convivencia' curso.id %}" method="post">
                {% csrf_token %}
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="thead-dark">
                            <tr class="bg-primary text-white text-center">
                                <th rowspan="2" class="align-middle">Estudiante</th>
                                <th colspan="{{ materias|length }}" class="align-middle">Notas Finales por Materia (Promedio)</th>
                                <th rowspan="2" class="align-middle bg-warning text-dark">Nota de Convivencia</th>
                            </tr>
                            <tr class="bg-light text-dark text-center">
                                {% for materia in materias %}
                                <th>{{ materia.nombre }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for estudiante in estudiantes %}
                            <tr>
                                <td class="fw-bold">{{ estudiante.get_full_name|default:estudiante.username }}</td>
                                {% for materia in materias %}
                                <td class="text-center">
                                    {% with notas_materia_periodos=notas_finales_data|get_item:estudiante.id|get_item:materia.id %}
                                        {% if notas_materia_periodos %}
                                            {% for periodo, valor in notas_materia_periodos.items %}
                                                <span class="d-block {% if valor >= 3.0 %}text-success{% else %}text-danger{% endif %}" data-bs-toggle="tooltip" title="{{ periodo.nombre }}">{{ valor|floatformat:2|default:"-" }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="d-block">-</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                {% endfor %}
                                <td class="text-center bg-warning-light">
                                    {% for periodo in periodos %}
                                        <div class="p-1 mb-1 border rounded" style="background-color: white;">
                                            <label for="convivencia-{{ periodo.id }}-{{ estudiante.id }}" class="form-label mb-1 fw-bold">{{ periodo.nombre }}</label>
                                            <input type="number"
                                                   id="convivencia-{{ periodo.id }}-{{ estudiante.id }}"
                                                   name="convivencia_{{ periodo.id }}_{{ estudiante.id }}"
                                                   value="{{ convivencias_data|get_item:estudiante.id|get_item:periodo.id|get_item:'valor'|default:'' }}"
                                                   class="form-control form-control-sm text-center mb-1"
                                                   step="0.1" min="0.0" max="5.0" placeholder="0.0">
                                            <textarea name="comentario_convivencia_{{ periodo.id }}_{{ estudiante.id }}"
                                                      class="form-control form-control-sm"
                                                      placeholder="Comentario..."
                                                      rows="2">{{ convivencias_data|get_item:estudiante.id|get_item:periodo.id|get_item:'comentario'|default:'' }}</textarea>
                                        </div>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-success btn-lg"><i class="fas fa-save me-2"></i>Guardar Notas de Convivencia</button>
                </div>
            </form>
            {% else %}
            <div class="alert alert-info text-center" role="alert">
                <i class="fas fa-info-circle me-2"></i> No hay estudiantes matriculados en este curso.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .bg-primary { background-color: #4361ee !important; }
    .text-dark { color: #212529 !important; }
    .bg-warning { background-color: #ffc107 !important; }
    .bg-warning-light { background-color: #fff3cd !important; }
    .table-responsive { border-radius: 0.5rem; overflow: hidden; }
    .card-header.rounded-top-4 { border-top-left-radius: 1rem !important; border-top-right-radius: 1rem !important; }
    .form-control:focus { border-color: #4361ee; box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25); }
</style>
<script>
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% endblock %}
