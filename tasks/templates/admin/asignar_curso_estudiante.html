{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
<div class="card p-5">
<h1 class="text-center mb-4">Asignar Curso a Estudiante</h1>

<form method="POST" class="mb-4">
    {% csrf_token %}
    <div class="row">
    <div class="col-md-5">
        <label for="estudiante_select" class="form-label">Seleccionar Estudiante</label>
        <select name="estudiante" id="estudiante_select" class="form-select" required>
            <option value="">Seleccionar estudiante</option>
            {# Usamos la nueva variable 'todos_los_estudiantes' para el men칰 #}
            {% for estudiante in todos_los_estudiantes %}
                <option value="{{ estudiante.id }}">{{ estudiante.get_full_name|default:estudiante.username }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-5">
        <label for="curso_select" class="form-label">Seleccionar Curso</label>
        <select name="curso" id="curso_select" class="form-select" required>
            <option value="">Seleccionar curso</option>
            {% for curso in cursos %}
                <option value="{{ curso.id }}">{{ curso.nombre }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-success w-100">Asignar</button>
    </div>
    </div>
</form>

<h3 class="mt-5">Estudiantes y sus Cursos</h3>
<div class="table-responsive">
    <table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Estudiante</th>
            <th>Usuario (Est.)</th>
            <th>Acudiente</th>
            <th>Usuario (Acud.)</th>
            <th>Curso Actual</th>
            <th>Rol</th>
            <th>Bolet칤n (PDF)</th> 
            <th>Acceso Acudiente</th>
            <th class="text-center">Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for item in estudiantes_con_curso %}
        <tr>
            <td>{{ item.user.get_full_name|default:item.user.username }}</td>
            <td><code>{{ item.user.username }}</code></td> {# 游녣 A침ad칤 <code> para consistencia #}
            <td>{{ item.acudiente_nombre }}</td>
            <td><code>{{ item.acudiente_username }}</code></td>
            <td>{{ item.curso.nombre|default:"Sin asignar" }}</td>
            <td>{{ item.rol }}</td>
            <td>
                <a href="{% url 'panel_generar_boletin' item.user.id %}" class="btn btn-sm btn-info" target="_blank" title="Generar PDF">
                    <i class="fas fa-file-pdf"></i>
                </a>
                </td>
            <td>
                {% if item.matricula %}
                <div class="form-check form-switch">
                    <input class="form-check-input toggle-boletin" type="checkbox" 
                           data-estudiante-id="{{ item.user.id }}" 
                           {% if item.matricula.puede_generar_boletin %}checked{% endif %}>
                    <label class="form-check-label small" id="label-boletin-{{ item.user.id }}">
                        {% if item.matricula.puede_generar_boletin %}Disponible{% else %}Bloqueado{% endif %}
                    </label>
                </div>
                {% else %}
                <span class="badge bg-secondary">Sin Matr칤cula</span>
                {% endif %}
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-danger btn-retirar"
                        data-bs-toggle="modal"
                        data-bs-target="#modalRetirarEstudiante"
                        data-estudiante-id="{{ item.user.id }}"
                        data-estudiante-nombre="{{ item.user.get_full_name|default:item.user.username }}">
                    <i class="fas fa-user-minus me-1"></i> Retirar
                </button>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="9" class="text-center">No hay estudiantes matriculados para mostrar.</td>
            </tr>
        {% endfor %}
    </tbody>
    </table>
</div>

<div class="text-center mt-4">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">Volver al Dashboard</a>
</div>
</div>
</div>


<div class="modal fade" id="modalRetirarEstudiante" tabindex="-1" aria-labelledby="modalRetirarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="modalRetirarLabel">
            <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Retiro de Estudiante
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Est치s a punto de **retirar** (desactivar) al estudiante:</p>
        <h4 class="text-center fw-bold" id="nombreEstudianteModal"></h4>
        
        <div class="alert alert-warning mt-3">
            <strong>춰Esto es un "Borrado Suave" profesional!</strong>
            <ul class="mb-0 mt-2">
                <li>El estudiante ser치 movido al archivo de "Ex Alumnos".</li>
                <li>Se generar치 un **respaldo en PDF** de su bolet칤n por cada a침o cursado.</li>
                <li>Su cuenta y la de su acudiente (si no tiene m치s estudiantes) ser치n desactivadas.</li>
            </ul>
        </div>
        <p class="mt-3">쮼st치s seguro de que deseas continuar?</p>
        </div>
      <div class="modal-footer">
        <form method="POST" action="{% url 'panel_eliminar_estudiante' %}">
        {% csrf_token %}
            <input type="hidden" name="estudiante_id" id="idEstudianteRetirar">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger">S칤, Retirar Estudiante</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- L칩gica de Toggle (Existente) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    const toggles = document.querySelectorAll('.toggle-boletin');
    
    toggles.forEach(switchEl => {
        switchEl.addEventListener('change', async function(e) {
            const estudianteId = e.target.dataset.estudianteId;
            const nuevoEstado = e.target.checked;
            const label = document.getElementById(`label-boletin-${estudianteId}`);
            
            label.textContent = 'Actualizando...';
            
            try {
                const response = await fetch(`{% url 'panel_api_toggle_boletin_permiso' %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        'estudiante_id': estudianteId,
                        'estado': nuevoEstado
                    })
                });

                const data = await response.json();

                if (response.ok && data.status === 'ok') {
                    label.textContent = data.nuevo_estado_texto;
                } else {
                    e.target.checked = !nuevoEstado;
                    label.textContent = nuevoEstado ? 'Bloqueado' : 'Disponible';
                    alert('Error: ' + (data.message || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error en fetch:', error);
                e.target.checked = !nuevoEstado;
                label.textContent = nuevoEstado ? 'Bloqueado' : 'Disponible';
                alert('Error de conexi칩n al actualizar el permiso.');
            }
        });
    });

    // --- L칩gica de Modal de Retiro (Nueva) ---
    const modalRetirarEstudiante = document.getElementById('modalRetirarEstudiante');
    if (modalRetirarEstudiante) {
        modalRetirarEstudiante.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const estudianteId = button.dataset.estudianteId;
            const estudianteNombre = button.dataset.estudianteNombre;
            
            const modalNombre = modalRetirarEstudiante.querySelector('#nombreEstudianteModal');
            const modalInputId = modalRetirarEstudiante.querySelector('#idEstudianteRetirar');
            
            modalNombre.textContent = estudianteNombre;
            modalInputId.value = estudianteId;
        });
    }

});
</script>

{% endblock %}