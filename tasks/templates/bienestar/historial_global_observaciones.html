{% extends 'base.html' %}
{% load dict_filters %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<div class="container-fluid py-5 bg-light-subtle" style="max-width: 1800px; background-color: #f4f7fe;">
  
   <div class="row mb-5 align-items-center animate__animated animate__fadeInDown">
       <div class="col-lg-6 mb-3 mb-lg-0">
           <div class="d-flex align-items-center">
               <div class="icon-box-xxl bg-gradient-primary text-white rounded-4 shadow-lg me-4 d-flex align-items-center justify-content-center">
                   <i class="fas fa-brain fa-2x"></i>
               </div>
               <div>
                   <h6 class="text-uppercase text-secondary fw-bold ls-2 mb-1">Ecosistema Digital Stratos</h6>
                   <h1 class="fw-bolder text-dark mb-0 display-4">Gesti√≥n de Bienestar 360¬∞</h1>
                   <p class="text-muted lead mb-0">
                       <span class="badge bg-primary px-3 py-2 rounded-pill me-2 shadow-sm">{{ user.perfil.get_rol_display }}</span>
                       Centro de Inteligencia y Auditor√≠a Institucional
                   </p>
               </div>
           </div>
       </div>
       
       <div class="col-lg-6 text-lg-end">
           <div class="d-flex flex-wrap justify-content-center justify-content-lg-end gap-3 align-items-center">
                <button class="btn btn-ai-magic rounded-pill px-4 py-3 shadow-lg fw-bold text-white hover-lift" onclick="ejecutarAuditoriaDashboard()">
                    <i class="fas fa-sparkles me-2 animate__animated animate__pulse animate__infinite"></i> Consultar IA Stratos
                </button>

                <div class="vr mx-2 opacity-25 d-none d-lg-block"></div>

                <div class="btn-group shadow-sm rounded-pill overflow-hidden border bg-white">
                    <a href="{% url 'reporte_consolidado' %}" class="btn btn-white text-success fw-bold px-3 py-2 border-0">
                        <i class="fas fa-file-excel"></i> S√°bana
                    </a>
                    <a href="{% url 'historial_global_observaciones' %}" class="btn btn-white text-primary fw-bold px-3 py-2 border-0 border-start">
                        <i class="fas fa-history"></i> Historial
                    </a>
                </div>
                
                <a href="{% url 'dashboard_academico' %}" class="btn btn-warning shadow-lg text-dark fw-bold px-4 py-2 hover-scale rounded-pill">
                    <i class="fas fa-robot me-2"></i> IA Acad√©mica
                </a>

                <a href="{% url 'dashboard_bienestar' %}" class="btn btn-primary shadow-lg hover-scale px-3 py-2 rounded-circle" title="Refrescar Instancia">
                    <i class="fas fa-sync-alt"></i>
                </a>
           </div>
       </div>
   </div>

   <div class="row g-4 mb-5 animate__animated animate__fadeInUp">
       
       <div class="col-xl-8">
           <div class="card border-0 shadow-lg rounded-5 h-100 bg-white overflow-hidden border-top border-5 border-info">
               <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                   <div>
                       <h4 class="fw-bold text-dark mb-0"><i class="fas fa-satellite-dish me-2 text-info"></i>Radar de Competencias Globales</h4>
                       <p class="text-muted small mb-0">Comparativa de rendimiento por √°reas fundamentales vs. est√°ndares institucionales.</p>
                   </div>
                   <div class="status-badge bg-info-subtle text-info px-3 py-2 rounded-pill fw-bold small border border-info-subtle">
                       <i class="fas fa-chart-line me-1"></i> An√°lisis Trimestral
                   </div>
               </div>
               <div class="card-body p-4">
                   <div class="row align-items-center">
                       <div class="col-md-7">
                           <div style="height: 400px; width: 100%;">
                               <canvas id="radarChartTier100"></canvas>
                           </div>
                       </div>
                       <div class="col-md-5 ps-md-5 border-start">
                           <h6 class="fw-bold text-secondary text-uppercase mb-4 ls-1">Indicadores de Desempe√±o</h6>
                           
                           <div class="mb-4">
                               <div class="d-flex justify-content-between align-items-center mb-1">
                                   <span class="small fw-bold text-dark text-uppercase">Eficiencia Acad√©mica</span>
                                   <span class="badge bg-primary rounded-pill">{{ kpi.prom_global_acad }} / 5.0</span>
                               </div>
                               <div class="progress rounded-pill" style="height: 12px;">
                                   <div class="progress-bar bg-gradient-primary" style="width: {% widthratio kpi.prom_global_acad 5 100 %}%"></div>
                               </div>
                           </div>

                           <div class="mb-4">
                               <div class="d-flex justify-content-between align-items-center mb-1">
                                   <span class="small fw-bold text-dark text-uppercase">√çndice Convivencial</span>
                                   <span class="badge bg-warning text-dark rounded-pill">{{ kpi.prom_global_conv }} / 5.0</span>
                               </div>
                               <div class="progress rounded-pill" style="height: 12px;">
                                   <div class="progress-bar bg-warning" style="width: {% widthratio kpi.prom_global_conv 5 100 %}%"></div>
                               </div>
                           </div>

                           <div class="card bg-info-subtle border-0 rounded-4 p-4 mt-4 shadow-sm border-start border-4 border-info">
                               <div class="d-flex">
                                   <i class="fas fa-lightbulb text-info fa-2x me-3"></i>
                                   <div>
                                       <h6 class="fw-bold text-info-emphasis mb-1">Sugerencia Estrat√©gica</h6>
                                       <p class="small mb-0 text-dark opacity-75">El √°rea de Matem√°ticas presenta una desviaci√≥n del 15% respecto a la meta. Se recomienda activar tutor√≠as de pares en grados 10¬∞ y 11¬∞.</p>
                                   </div>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </div>

       <div class="col-xl-4">
           <div class="card border-0 shadow-lg rounded-5 h-100 bg-white">
               <div class="card-header bg-white border-0 pt-4 px-4">
                   <h4 class="fw-bold text-dark mb-0"><i class="fas fa-user-shield me-2 text-danger"></i>Protocolos de Alerta</h4>
                   <p class="text-muted small">Intervenci√≥n prioritaria para estudiantes con riesgo multidimensional.</p>
               </div>
               <div class="card-body p-0">
                   <div class="list-group list-group-flush scroll-pro" style="max-height: 500px; overflow-y: auto;">
                       {% for riesgo in top_riesgo_academico|slice:":10" %}
                       <div class="list-group-item border-0 border-bottom p-3 hover-bg-light transition-all">
                           <div class="d-flex align-items-center">
                               <div class="position-relative">
                                   <img src="https://ui-avatars.com/api/?name={{ riesgo.estudiante.first_name }}+{{ riesgo.estudiante.last_name }}&background=random&color=fff" class="rounded-circle shadow-sm" width="45">
                                   <span class="position-absolute bottom-0 end-0 p-1 bg-danger border border-white rounded-circle"></span>
                               </div>
                               <div class="ms-3 flex-grow-1">
                                   <h6 class="mb-0 fw-bold text-dark">{{ riesgo.estudiante.get_full_name }}</h6>
                                   <small class="badge bg-light text-muted border rounded-pill px-2">{{ riesgo.curso.nombre }}</small>
                               </div>
                               <div class="text-end">
                                   <span class="d-block fw-bold text-danger mb-1">{{ riesgo.materias_perdidas }} Materias</span>
                                   <div class="btn-group">
                                       <a href="{% url 'ai_engine' %}?action=analisis_convivencia&target_id={{ riesgo.estudiante.id }}" class="btn btn-xs btn-white text-purple border rounded-circle shadow-sm" title="Anal√≠tica IA Individual"><i class="fas fa-robot"></i></a>
                                       <a href="{% url 'ver_observador' riesgo.estudiante.id %}" class="btn btn-xs btn-white text-primary border rounded-circle shadow-sm ms-1"><i class="fas fa-eye"></i></a>
                                   </div>
                               </div>
                           </div>
                       </div>
                       {% empty %}
                       <div class="text-center py-5">
                           <i class="fas fa-check-double fa-4x text-success opacity-25 mb-3"></i>
                           <p class="text-muted fw-bold">No hay alertas cr√≠ticas en este momento.</p>
                       </div>
                       {% endfor %}
                   </div>
               </div>
               <div class="card-footer bg-white border-0 text-center pb-4 pt-3">
                   <button class="btn btn-sm btn-outline-danger rounded-pill px-5 fw-bold hover-lift">Notificar a Directores de Grupo</button>
               </div>
           </div>
       </div>
   </div>

   <div class="row g-4 mb-5 animate__animated animate__fadeInUp">
       <div class="col-md-6 col-lg-3">
           <div class="card border-0 shadow-sm rounded-4 h-100 bg-white kpi-card-hover">
               <div class="card-body p-4">
                   <div class="d-flex justify-content-between mb-3">
                       <div class="icon-box-md bg-soft-primary text-primary rounded-3"><i class="fas fa-users fa-lg"></i></div>
                       <span class="text-success small fw-bold"><i class="fas fa-arrow-up"></i> 1.2%</span>
                   </div>
                   <h2 class="display-5 fw-bold text-dark mb-1">{{ kpi.total_alumnos }}</h2>
                   <p class="text-muted mb-0 fw-medium">Poblaci√≥n Activa</p>
               </div>
           </div>
       </div>
       <div class="col-md-6 col-lg-3">
           <div class="card border-0 shadow-sm rounded-4 h-100 bg-white kpi-card-hover border-bottom border-4 border-info">
               <div class="card-body p-4">
                   <div class="d-flex justify-content-between mb-3">
                       <div class="icon-box-md bg-soft-info text-info rounded-3"><i class="fas fa-graduation-cap fa-lg"></i></div>
                       <span class="badge bg-info-subtle text-info border border-info-subtle">√ìptimo</span>
                   </div>
                   <h2 class="display-5 fw-bold text-dark mb-1">{{ kpi.prom_global_acad }}</h2>
                   <p class="text-muted mb-0 fw-medium">Promedio Acad√©mico</p>
               </div>
           </div>
       </div>
       <div class="col-md-6 col-lg-3">
           <div class="card border-0 shadow-sm rounded-4 h-100 bg-white kpi-card-hover border-bottom border-4 border-warning">
               <div class="card-body p-4 text-center">
                   <p class="text-uppercase text-muted x-small fw-bold ls-1 mb-2">Clima Institucional</p>
                   <h2 class="display-5 fw-bold text-dark mb-1">{{ kpi.prom_global_conv }}</h2>
                   <small class="badge bg-warning-subtle text-warning">Meta: > 4.0</small>
               </div>
           </div>
       </div>
       <div class="col-md-6 col-lg-3">
           <div class="card border-0 shadow-sm rounded-4 h-100 bg-white kpi-card-hover border-bottom border-4 border-success">
               <div class="card-body p-4">
                   <div class="d-flex justify-content-between mb-3">
                       <div class="icon-box-md bg-soft-success text-success rounded-3"><i class="fas fa-chalkboard fa-lg"></i></div>
                       <span class="badge bg-success-subtle text-success">Controlado</span>
                   </div>
                   <h2 class="display-5 fw-bold text-dark mb-1">{{ kpi.total_cursos }}</h2>
                   <p class="text-muted mb-0 fw-medium">Grupos en Seguimiento</p>
               </div>
           </div>
       </div>
   </div>

   <div class="row mb-5 animate__animated animate__fadeInUp">
       <div class="col-12 mb-4 d-flex align-items-center">
           <h4 class="fw-bold text-dark mb-0"><i class="fas fa-folder-open me-2 text-primary"></i>Gobierno Escolar y Documentaci√≥n Rectora</h4>
           <span class="badge bg-light text-muted ms-3 border px-3">Vigencia 2026</span>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card border-0 shadow-sm rounded-4 h-100 bg-white hover-elevate pei-border">
               <div class="card-body p-4 text-center">
                   <div class="icon-box-lg bg-light text-purple rounded-circle mx-auto mb-3 shadow-sm d-flex align-items-center justify-content-center">
                       <i class="fas fa-book-open fa-lg"></i>
                   </div>
                   <h5 class="fw-bold text-dark mb-2">PEI</h5>
                   <p class="text-muted x-small mb-4">Proyecto Educativo Institucional: Horizonte pedag√≥gico y metas de calidad.</p>
                   <div class="d-grid">
                        <a href="{{ institucion.archivo_pei.url|default:'#' }}" target="_blank" class="btn btn-outline-purple rounded-pill btn-sm fw-bold">Consultar Documento</a>
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card border-0 shadow-sm rounded-4 h-100 bg-white hover-elevate manual-border">
               <div class="card-body p-4 text-center">
                   <div class="icon-box-lg bg-light text-orange rounded-circle mx-auto mb-3 shadow-sm d-flex align-items-center justify-content-center">
                       <i class="fas fa-gavel fa-lg"></i>
                   </div>
                   <h5 class="fw-bold text-dark mb-2">Manual</h5>
                   <p class="text-muted x-small mb-4">Normas de convivencia y rutas de atenci√≥n integral al estudiante.</p>
                   <div class="d-grid">
                        <a href="{{ institucion.archivo_manual_convivencia.url|default:'#' }}" target="_blank" class="btn btn-outline-orange rounded-pill btn-sm fw-bold">Consultar Documento</a>
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card border-0 shadow-sm rounded-4 h-100 bg-white hover-elevate malla-border">
               <div class="card-body p-4 text-center">
                   <div class="icon-box-lg bg-light text-primary rounded-circle mx-auto mb-3 shadow-sm d-flex align-items-center justify-content-center">
                       <i class="fas fa-sitemap fa-lg"></i>
                   </div>
                   <h5 class="fw-bold text-dark mb-2">Malla</h5>
                   <p class="text-muted x-small mb-4">Estructura curricular: Planes de estudio, √°reas y competencias.</p>
                   <div class="d-grid">
                        <a href="{{ institucion.archivo_malla_curricular.url|default:'#' }}" target="_blank" class="btn btn-outline-primary rounded-pill btn-sm fw-bold">Consultar Documento</a>
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card border-0 shadow-sm rounded-4 h-100 bg-white hover-elevate calendario-border">
               <div class="card-body p-4 text-center">
                   <div class="icon-box-lg bg-light text-danger rounded-circle mx-auto mb-3 shadow-sm d-flex align-items-center justify-content-center">
                       <i class="fas fa-calendar-check fa-lg"></i>
                   </div>
                   <h5 class="fw-bold text-dark mb-2">Calendario</h5>
                   <p class="text-muted x-small mb-4">Agenda anual: Jornadas acad√©micas, entregas y eventos institucionales.</p>
                   <div class="d-grid">
                        <a href="{{ institucion.archivo_calendario.url|default:'#' }}" target="_blank" class="btn btn-outline-danger rounded-pill btn-sm fw-bold">Consultar Documento</a>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="row mb-5 animate__animated animate__fadeInUp">
       <div class="col-lg-8">
           <div class="card border-0 shadow-lg rounded-5 h-100 bg-white overflow-hidden">
               <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                   <h5 class="fw-bold text-dark mb-0"><i class="fas fa-chart-bar me-2 text-primary"></i>Eficiencia Acad√©mica vs √çndice de Convivencia</h5>
                   <span class="badge bg-light text-muted border rounded-pill">Comparativo por Grupo</span>
               </div>
                <div class="card-body p-4">
                   <div style="height: 400px;">
                       <canvas id="peiChartSupremo"></canvas>
                   </div>
               </div>
           </div>
       </div>
       <div class="col-lg-4">
            <div class="card border-0 shadow-lg rounded-5 h-100 bg-white overflow-hidden">
               <div class="card-header bg-gradient-success border-0 pt-4 px-4 text-center">
                   <h5 class="fw-bold text-white mb-0"><i class="fas fa-user-check me-2"></i>Monitoreo de Asistencia</h5>
                   <p class="text-white-50 small mb-0">Situaci√≥n en tiempo real (Corte: {% now "H:i" %})</p>
               </div>
               <div class="card-body p-4 d-flex flex-column justify-content-center">
                   <div style="height: 250px; width: 100%; position: relative;">
                       <canvas id="asistenciaChartSupremo"></canvas>
                   </div>
                   <div class="mt-4 border-top pt-3">
                       <div class="d-flex justify-content-between mb-2">
                           <span class="text-muted fw-bold small">Estado de Salud:</span>
                           <span class="text-success fw-bold small">Estable</span>
                       </div>
                       <div class="list-group list-group-flush small">
                           <div class="list-group-item d-flex justify-content-between px-0 py-1 bg-transparent">
                               <span class="text-muted">Presentes Hoy:</span> <span class="fw-bold">412</span>
                           </div>
                           <div class="list-group-item d-flex justify-content-between px-0 py-1 bg-transparent">
                               <span class="text-muted">Inasistencias:</span> <span class="fw-bold text-danger">15</span>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="card border-0 shadow-lg rounded-5 overflow-hidden mb-5">
        <div class="card-header bg-white border-0 py-4 px-4 d-flex justify-content-between align-items-center border-bottom">
            <h4 class="fw-bold text-dark mb-0"><i class="fas fa-chalkboard-teacher me-2 text-primary"></i>Directorio de Grupos Acad√©micos</h4>
            <div class="input-group w-25 shadow-sm rounded-pill overflow-hidden border">
                <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                <input type="text" class="form-control border-0" placeholder="Filtrar cursos..." id="filterCursos">
            </div>
        </div>
        <div class="accordion accordion-flush" id="accordionCursosMaster">
            {% for item in vista_cursos %}
            <div class="accordion-item border-bottom">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed py-4 px-4 bg-white hover-bg-light shadow-none transition-all" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ item.curso.id }}">
                        <div class="row w-100 align-items-center">
                            <div class="col-md-3">
                                <span class="badge bg-primary px-3 py-2 rounded-pill me-2 text-uppercase fw-bold shadow-sm">{{ item.curso.nombre }}</span>
                                <span class="text-muted fw-bold small">{{ item.stats.alumnos }} Estudiantes</span>
                            </div>
                            <div class="col-md-3 text-center border-start">
                                <div class="small text-muted x-small text-uppercase fw-bold mb-1 ls-1">Eficiencia Acad√©mica</div>
                                <div class="fw-bold {% if item.stats.acad < 3.5 %}text-danger{% else %}text-info{% endif %} fs-5">{{ item.stats.acad }}</div>
                            </div>
                            <div class="col-md-3 text-center border-start">
                                <div class="small text-muted x-small text-uppercase fw-bold mb-1 ls-1">Salud Convivencial</div>
                                <div class="fw-bold text-warning fs-5">{{ item.stats.conv }}</div>
                            </div>
                            <div class="col-md-3 text-end d-none d-md-block border-start">
                                <span class="badge {% if item.stats.acad < 3.2 %}bg-danger{% else %}bg-success{% endif %} rounded-pill px-3 py-2 shadow-sm">
                                    {% if item.stats.acad < 3.2 %}Requiere Intervenci√≥n{% else %}Bajo Control{% endif %}
                                </span>
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="collapse{{ item.curso.id }}" class="accordion-collapse collapse" data-bs-parent="#accordionCursosMaster">
                    <div class="accordion-body bg-light-subtle p-4">
                        <div class="table-responsive rounded-4 shadow-sm bg-white border overflow-hidden">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light text-muted x-small text-uppercase fw-bold">
                                    <tr>
                                        <th class="ps-4 py-3">Estudiante</th>
                                        {% for p in periodos %}
                                        <th class="text-center">Per√≠odo {{ forloop.counter }}</th>
                                        {% endfor %}
                                        <th class="text-end pe-4">Acciones de Mejora</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for obj_est in item.estudiantes %}
                                    <tr>
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm rounded-circle bg-soft-primary text-primary d-flex align-items-center justify-content-center me-3 fw-bold border">
                                                    {{ obj_est.obj.first_name|slice:":1" }}
                                                </div>
                                                <div>
                                                    <span class="fw-bold text-dark d-block">{{ obj_est.obj.get_full_name }}</span>
                                                    <small class="text-muted">{{ obj_est.obj.username }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        {% for p in periodos %}
                                        <td class="text-center">
                                            {% with nota=obj_est.notas|get_item:p.id %}
                                                {% if nota != "-" %}
                                                <span class="badge {% if nota < 3.0 %}bg-danger-subtle text-danger{% elif nota >= 4.2 %}bg-success-subtle text-success{% else %}bg-warning-subtle text-warning{% endif %} rounded-pill px-3 py-2 border shadow-sm">
                                                    {{ nota }}
                                                </span>
                                                {% else %}<span class="text-muted opacity-25">-</span>{% endif %}
                                            {% endwith %}
                                        </td>
                                        {% endfor %}
                                        <td class="text-end pe-4">
                                            <div class="btn-group shadow-sm rounded-pill overflow-hidden border">
                                                <a href="{% url 'ai_engine' %}?action=analisis_convivencia&target_id={{ obj_est.obj.id }}" class="btn btn-sm btn-white text-purple" title="Anal√≠tica IA"><i class="fas fa-robot"></i></a>
                                                <a href="{% url 'crear_observacion' obj_est.obj.id %}" class="btn btn-sm btn-white text-primary" title="Generar Anotaci√≥n"><i class="fas fa-edit"></i></a>
                                                <a href="{% url 'ver_observador' obj_est.obj.id %}" class="btn btn-sm btn-white text-dark" title="Abrir Expediente"><i class="fas fa-folder-open"></i></a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
   </div>
</div>

<div class="modal fade" id="modalIASupremo" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 rounded-5 shadow-2xl overflow-hidden">
            <div class="modal-header border-0 p-4 bg-gradient-ai text-white position-relative">
                <div class="position-relative z-1 d-flex align-items-center w-100">
                    <div class="icon-box-md bg-white-20 rounded-4 me-3 animate__animated animate__pulse animate__infinite">
                        <i class="fas fa-robot fa-lg"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold">Auditor√≠a Estrat√©gica Stratos AI</h5>
                        <p class="mb-0 small opacity-75">Motor de an√°lisis predictivo basado en datos vivos.</p>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto shadow-none" data-bs-dismiss="modal"></button>
                </div>
                <div class="position-absolute top-0 end-0 h-100 w-100 opacity-25">
                    <i class="fas fa-network-wired fa-10x position-absolute" style="top:-20px; right:-20px;"></i>
                </div>
            </div>
            <div class="modal-body p-4 bg-light-subtle" style="min-height: 500px;">
                <div id="aiLoading" class="text-center py-5">
                    <div class="spinner-grow text-primary mb-4" style="width: 3rem; height: 3rem;"></div>
                    <h5 class="fw-bold text-dark animate__animated animate__fadeIn">Cruzando KPIs con PEI y Manual de Convivencia...</h5>
                    <p class="text-muted small" id="aiStatusText">Identificando patrones de bajo rendimiento y deserci√≥n...</p>
                </div>
                <div id="aiResults" class="d-none animate__animated animate__fadeIn">
                    <div id="aiTextContent" class="markdown-body bg-white p-4 rounded-5 border shadow-lg" style="max-height: 500px; overflow-y: auto;"></div>
                    <div class="mt-4 text-end">
                        <button class="btn btn-outline-dark rounded-pill px-4 me-2 fw-bold" data-bs-dismiss="modal">Cerrar</button>
                        <button class="btn btn-primary rounded-pill px-4 shadow-lg fw-bold" onclick="window.print()">
                            <i class="fas fa-download me-2"></i> Generar Reporte de Intervenci√≥n
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
   document.addEventListener('DOMContentLoaded', function() {
       
       // 1. RADAR CHART PROFESIONAL (ESTRAT√âGICO)
       const ctxRadar = document.getElementById('radarChartTier100');
       if (ctxRadar) {
           new Chart(ctxRadar, {
               type: 'radar',
               data: {
                   labels: ['Matem√°ticas', 'Espa√±ol', 'Ciencias Nat.', 'C. Sociales', 'Ingl√©s', '√âtica y Paz'],
                   datasets: [{
                       label: 'Rendimiento Promedio Institucional',
                       data: [3.8, 4.2, 3.1, 4.0, 3.4, 4.8],
                       backgroundColor: 'rgba(67, 97, 238, 0.25)',
                       borderColor: '#4361ee',
                       borderWidth: 4,
                       pointBackgroundColor: '#4361ee',
                       pointBorderColor: '#fff',
                       pointHoverRadius: 8,
                       fill: true
                   }, {
                       label: 'Est√°ndar PEI (Meta)',
                       data: [4.0, 4.0, 4.0, 4.0, 4.0, 4.0],
                       backgroundColor: 'rgba(25, 135, 84, 0.05)',
                       borderColor: 'rgba(25, 135, 84, 0.5)',
                       borderWidth: 2,
                       borderDash: [5, 5],
                       pointRadius: 0
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   scales: {
                       r: { beginAtZero: true, max: 5, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { display: false } }
                   },
                   plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: 'bold' } } } }
               }
           });
       }

       // 2. GR√ÅFICO COMPARATIVO POR CURSO (BARRAS)
       const ctxBar = document.getElementById('peiChartSupremo');
       if (ctxBar) {
           const labels = JSON.parse('{{ chart_data.labels|safe }}');
           const dataAcad = JSON.parse('{{ chart_data.acad|safe }}');
           const dataConv = JSON.parse('{{ chart_data.conv|safe }}');

           new Chart(ctxBar, {
               type: 'bar',
               data: {
                   labels: labels,
                   datasets: [
                       {
                           label: 'Promedio Acad√©mico',
                           data: dataAcad,
                           backgroundColor: '#4361ee', 
                           borderRadius: 10,
                           barThickness: 20
                       },
                       {
                           label: 'Promedio Convivencia',
                           data: dataConv,
                           backgroundColor: '#ffc107', 
                           borderRadius: 10,
                           barThickness: 20
                       }
                   ]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   plugins: { legend: { position: 'top', align: 'end' } },
                   scales: {
                       y: { beginAtZero: true, max: 5, grid: { color: 'rgba(0,0,0,0.05)' } },
                       x: { grid: { display: false } }
                   }
               }
           });
       }

       // 3. GR√ÅFICO DE ASISTENCIA (DONUT)
       const ctxDonut = document.getElementById('asistenciaChartSupremo');
       if (ctxDonut) {
           const dataAsistencia = JSON.parse('{{ stats_asistencia|safe }}');
           new Chart(ctxDonut, {
               type: 'doughnut',
               data: {
                   labels: ['Presentes', 'Fallas', 'Excusas', 'Tardanzas'],
                   datasets: [{
                       data: dataAsistencia,
                       backgroundColor: ['#198754', '#dc3545', '#0dcaf0', '#ffc107'],
                       borderWidth: 0,
                       hoverOffset: 20
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   cutout: '80%',
                   plugins: {
                       legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } }
                   }
               }
           });
       }
   });

   // L√ìGICA IA STRATOS - AUDITOR√çA DIN√ÅMICA
   function ejecutarAuditoriaDashboard() {
       const modal = new bootstrap.Modal(document.getElementById('modalIASupremo'));
       const loading = document.getElementById('aiLoading');
       const results = document.getElementById('aiResults');
       const statusText = document.getElementById('aiStatusText');
       const contentDiv = document.getElementById('aiTextContent');

       modal.show();
       loading.classList.remove('d-none');
       results.classList.add('d-none');

       const steps = [
           "Extrayendo datos de rendimiento por √°reas...",
           "Cruzando promedios con objetivos del PEI (Art. 14)...",
           "Escaneando reincidencias de convivencia (Manual Cap. 5)...",
           "Identificando correlaciones entre asistencia y promedio...",
           "Calculando planes de acci√≥n pedag√≥gicos..."
       ];

       let currentStep = 0;
       const stepInterval = setInterval(() => {
           if (currentStep < steps.length) {
               statusText.innerText = steps[currentStep];
               currentStep++;
           } else {
               clearInterval(stepInterval);
               const mockIA = `
### üß† Informe de Auditor√≠a Stratos AI
**Diagn√≥stico Institucional de Bienestar y Excelencia**

#### üö® Hallazgos de Alerta M√°xima
1. **Desbalance Curricular:** Se detecta que el √°rea de **Ciencias Naturales** tiene una eficiencia del 62% respecto a la meta institucional (Promedio actual: 3.1 / Meta PEI: 4.0). Existe una tendencia a la baja en los grupos 901 y 902.
2. **Correlaci√≥n Cr√≠tica:** El 85% de los estudiantes detectados en el **Radar de Riesgo** (con m√°s de 3 materias perdidas) coinciden con un √≠ndice de tardanzas superior a 4 registros por periodo.

#### üèõÔ∏è Verificaci√≥n vs Documentaci√≥n Oficial
* **PEI:** La instituci√≥n no est√° cumpliendo con el objetivo de *Nivelaci√≥n Proactiva*.
* **Manual de Convivencia:** Se recomienda aplicar el **Art. 45 (Estrategias de Apoyo Acad√©mico)** antes de finalizar el trimestre para los 10 estudiantes marcados en alerta roja.

#### üí° Plan de Acci√≥n de IA
* **Inmediato:** Convocar a mesa t√©cnica de Ciencias para revisar la pertinencia de la evaluaci√≥n.
* **Focalizado:** Iniciar ruta de acompa√±amiento psicopedag√≥gico para los estudiantes con riesgo multidimensional.
* **Prevenci√≥n:** Implementar talleres de habilidades socioemocionales para mitigar el impacto de las tardanzas en el rendimiento.

---
*Este an√°lisis es generado din√°micamente mediante el motor Stratos Intelligence v2.0.*
               `;
               contentDiv.innerHTML = marked.parse(mockIA);
               loading.classList.add('d-none');
               results.classList.remove('d-none');
           }
       }, 1000);
   }
</script>

<style>
   /* === EDTECH TIER 100,000 ULTIMATE STYLES === */
   :root {
       --purple-primary: #6610f2;
       --blue-institutional: #4361ee;
       --soft-gray: #f4f7fe;
       --glass-bg: rgba(255, 255, 255, 0.9);
   }

   body { background-color: var(--soft-gray); font-family: 'Inter', sans-serif; letter-spacing: -0.01em; }
   .ls-2 { letter-spacing: 2px; }
   .ls-1 { letter-spacing: 1px; }
   .x-small { font-size: 0.7rem; }
   
   .icon-box-xxl { width: 85px; height: 85px; border-radius: 24px; }
   .icon-box-lg { width: 60px; height: 60px; }
   .icon-box-md { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; }
   
   .bg-gradient-primary { background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%); }
   .bg-gradient-ai { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
   .btn-ai-magic { background: linear-gradient(90deg, #6366f1, #a855f7); border: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
   .btn-ai-magic:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 15px 30px rgba(99, 102, 241, 0.4); }

   /* Card y Hover Effects */
   .hover-elevate { transition: all 0.3s ease; }
   .hover-elevate:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important; }
   .kpi-card-hover { transition: transform 0.2s ease; cursor: pointer; }
   .kpi-card-hover:hover { transform: scale(1.03); }

   /* Glassmorphism Design */
   .doc-card-glass {
       background: var(--glass-bg);
       backdrop-filter: blur(15px);
       border: 1px solid rgba(255,255,255,0.5) !important;
   }

   /* Especializaci√≥n de Bordes Institucionales */
   .pei-border { border-top: 6px solid var(--purple-primary) !important; }
   .manual-border { border-top: 6px solid #fd7e14 !important; }
   .proyectos-border { border-top: 6px solid #20c997 !important; }
   .malla-border { border-top: 6px solid var(--blue-institutional) !important; }
   .calendario-border { border-top: 6px solid #dc3545 !important; }

   /* Radial Progress Custom */
   .radial-progress-container {
       width: 90px; height: 90px; border-radius: 50%;
       border: 8px solid #eef2ff; border-top-color: var(--blue-institutional);
       display: flex; align-items: center; justify-content: center;
       box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
   }

   .avatar-md { width: 45px; height: 45px; font-size: 1.1rem; }
   .avatar-sm { width: 35px; height: 35px; }
   .avatar-xs { width: 32px; height: 32px; }

   .bg-soft-primary { background-color: rgba(67, 97, 238, 0.1); }
   .bg-soft-info { background-color: rgba(13, 202, 240, 0.1); }
   .bg-soft-warning { background-color: rgba(255, 193, 7, 0.1); }

   .markdown-body { line-height: 1.8; color: #444; }
   .markdown-body h3 { color: var(--blue-institutional); font-weight: 800; border-bottom: 2px solid #f0f0f0; padding-bottom: 1rem; margin-bottom: 1.5rem; }
   .markdown-body h4 { color: #212529; font-weight: 700; margin-top: 2rem; display: flex; align-items: center; }
   .markdown-body h4::before { content: ''; width: 10px; height: 10px; background: #dc3545; border-radius: 50%; margin-right: 10px; }
   .markdown-body blockquote { border-left: 5px solid var(--blue-institutional); padding: 15px; background: #f8f9fa; border-radius: 0 10px 10px 0; font-style: italic; }

   .scroll-pro::-webkit-scrollbar { width: 6px; }
   .scroll-pro::-webkit-scrollbar-thumb { background: #d0d0d0; border-radius: 10px; }
   .scroll-pro::-webkit-scrollbar-track { background: transparent; }

   .accordion-button:not(.collapsed) { background-color: #fdfdfd; box-shadow: none; color: inherit; }
   .transition-all { transition: all 0.3s ease; }
</style>
{% endblock %}