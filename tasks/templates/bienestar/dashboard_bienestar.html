{% extends 'base.html' %}
{% load dict_filters %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<div class="container-fluid py-5 bg-light-subtle" style="max-width: 1800px; min-height: 100vh;">
  
   <div class="row mb-5 align-items-center animate__animated animate__fadeInDown">
       <div class="col-lg-5 mb-3 mb-lg-0">
           <div class="d-flex align-items-center justify-content-center justify-content-lg-start">
               <div class="icon-box-xl bg-gradient-primary text-white rounded-circle shadow-lg me-4 d-flex align-items-center justify-content-center transition-all hover-scale">
                   <i class="fas fa-chart-pie fa-3x"></i>
               </div>
               <div class="text-center text-lg-start">
                   <h6 class="text-uppercase text-secondary fw-bold ls-2 mb-1">Ecosistema Digital Stratos</h6>
                   <h1 class="fw-bolder text-dark mb-0 display-5">Gestión & Bienestar</h1>
                   <p class="text-muted lead mb-0">
                       <span class="badge bg-soft-primary text-primary me-2 px-3 py-2 rounded-pill shadow-sm border">
                           <i class="fas fa-user-shield me-1"></i> {{ user.perfil.get_rol_display }}
                       </span>
                       Centro de Control Institucional
                   </p>
               </div>
           </div>
       </div>
       
       <div class="col-lg-7">
           <div class="d-flex flex-wrap justify-content-center justify-content-lg-end gap-3 align-items-center">
                <button class="btn btn-ai-magic rounded-pill px-4 py-2 shadow-lg fw-bold text-white hover-lift" onclick="iniciarAnalisisIA()">
                    <i class="fas fa-sparkles me-2 animate__animated animate__pulse animate__infinite"></i> Consultar IA Stratos
                </button>

                <div class="vr mx-2 opacity-25 d-none d-lg-block"></div>

                <a href="{% url 'reporte_consolidado' %}" class="btn btn-white border shadow-sm text-success fw-bold hover-scale px-4 py-2" title="Descargar Sábana Excel">
                    <i class="fas fa-file-excel me-2"></i>Sábana
                </a>

                <a href="{% url 'historial_global_observaciones' %}" class="btn btn-white border shadow-sm text-primary fw-bold hover-scale px-4 py-2" title="Ver Historial de Procesos">
                    <i class="fas fa-history me-2"></i>Historial
                </a>

                <a href="{% url 'ai_engine' %}?action=cumplimiento_pei" class="btn btn-white border shadow-sm text-purple fw-bold hover-scale px-4 py-2" title="Analizar PEI con IA">
                    <i class="fas fa-robot me-2"></i>Auditoría IA
                </a>
                
                <a href="{% url 'dashboard_academico' %}" class="btn btn-warning shadow-lg text-dark fw-bold hover-scale px-4 py-2">
                    <i class="fas fa-brain me-2"></i>IA Académica
                </a>

                <a href="{% url 'dashboard_bienestar' %}" class="btn btn-primary shadow-lg hover-scale px-3 py-2" title="Recargar Datos">
                    <i class="fas fa-sync-alt"></i>
                </a>
           </div>
           
           <div class="text-center text-lg-end mt-3">
               <div class="d-inline-flex align-items-center bg-white border px-3 py-1 rounded-pill shadow-sm">
                   <span class="dot bg-success me-2"></span>
                   <small class="text-muted fw-bold ls-1 text-uppercase">Sincronización Stratos: <span class="text-dark">{% now "d M, Y - H:i" %}</span></small>
               </div>
           </div>
       </div>
   </div>

   <div class="card border-0 shadow-lg rounded-5 overflow-hidden mb-5 animate__animated animate__fadeInUp">
       <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
           <div>
               <h4 class="fw-bold text-dark mb-1">
                   <i class="fas fa-satellite-dish me-2 text-danger animate__animated animate__flash animate__infinite animate__slow"></i>
                   Radar de Riesgo Académico Institucional
               </h4>
               <p class="text-muted small mb-0">Priorización automática de estudiantes con bajo rendimiento por volumen de asignaturas perdidas.</p>
           </div>
           <div class="d-flex gap-2">
               <span class="badge bg-danger-subtle text-danger border border-danger-subtle px-3 py-2 rounded-pill fw-bold shadow-sm">
                   <i class="fas fa-bell me-2"></i>Fallas Académicas Críticas
               </span>
               <span class="badge bg-dark text-white px-3 py-2 rounded-pill fw-bold shadow-sm">
                   {{ top_riesgo_academico|length }} Casos en Seguimiento
               </span>
           </div>
       </div>
       <div class="card-body p-4">
           <div class="row g-4">
               <div class="col-lg-3">
                   <div class="d-flex flex-column gap-3 h-100">
                       <div class="card bg-soft-danger border-0 p-4 shadow-sm rounded-4 flex-grow-1 transition-all hover-lift border-start border-5 border-danger">
                           <div class="text-center py-2">
                               <h6 class="text-uppercase text-danger fw-bold x-small mb-2 ls-1">Materias Perdidas (Colegio)</h6>
                               <h2 class="display-3 fw-black text-danger mb-0">{{ kpi.total_materias_perdidas|default:"0" }}</h2>
                               <div class="mt-2">
                                   <small class="text-danger fw-bold"><i class="fas fa-exclamation-circle me-1"></i>Impacto Curricular</small>
                               </div>
                           </div>
                       </div>
                       <div class="card bg-soft-info border-0 p-4 shadow-sm rounded-4 flex-grow-1 transition-all hover-lift border-start border-5 border-info">
                           <div class="text-center py-2">
                               <h6 class="text-uppercase text-info fw-bold x-small mb-2 ls-1">Promedio Institucional</h6>
                               <h2 class="display-3 fw-black text-info mb-0">{{ kpi.prom_global_acad|default:"0.0" }}</h2>
                               <div class="progress mt-3 mx-auto shadow-sm" style="height: 10px; width: 80%; border-radius: 10px;">
                                   <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                                        role="progressbar" 
                                        style="width: {% widthratio kpi.prom_global_acad 5 100 %}%"></div>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>

               <div class="col-lg-4">
                   <div class="card border bg-white p-4 rounded-5 h-100 shadow-sm d-flex flex-column justify-content-center align-items-center border-0">
                       <h6 class="text-center text-secondary x-small fw-bold text-uppercase mb-4">
                           <i class="fas fa-chart-line me-2"></i>Mapa de Calor Académico (Real)
                       </h6>
                       <div style="height: 350px; width: 100%;">
                           <canvas id="radarChartPro"></canvas>
                       </div>
                       <p class="small text-muted mt-3 text-center px-4">Análisis institucional basado en la materia Convivencia vs Academia.</p>
                   </div>
               </div>

               <div class="col-lg-5">
                   <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                        <h6 class="text-secondary x-small fw-bold text-uppercase mb-0">Listado de Reprobación Crítica</h6>
                        <span class="x-small text-muted fw-bold"><i class="fas fa-sort-amount-down me-1"></i>Mayor Riesgo Primero</span>
                   </div>
                   
                   <div class="scroll-pro pe-2" style="max-height: 480px; overflow-y: auto;">
                       <div class="list-group list-group-flush gap-3">
                           {% for riesgo in top_riesgo_academico %}
                           <div class="card border-0 shadow-sm rounded-4 mb-2 hover-elevate transition-all border-start border-5 {% if riesgo.materias_perdidas > 3 %}border-danger{% else %}border-warning{% endif %}">
                               <div class="card-body p-3">
                                   <div class="d-flex align-items-start">
                                       <div class="position-relative me-3">
                                           <div class="avatar-md rounded-circle {% if riesgo.materias_perdidas > 3 %}bg-danger{% else %}bg-warning{% endif %} text-white d-flex align-items-center justify-content-center fw-black shadow-lg">
                                               {{ riesgo.estudiante.first_name|slice:":1" }}{{ riesgo.estudiante.last_name|slice:":1" }}
                                           </div>
                                           <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark border border-white">
                                               #{{ forloop.counter }}
                                           </span>
                                       </div>
                                       <div class="flex-grow-1 overflow-hidden">
                                           <h6 class="mb-1 fw-bold text-dark">{{ riesgo.estudiante.get_full_name }}</h6>
                                           <span class="badge bg-light text-muted border px-2 py-1 rounded-pill x-small">
                                               <i class="fas fa-graduation-cap me-1"></i> {{ riesgo.curso.nombre }}
                                           </span>
                                           
                                           <div class="mt-3 p-2 bg-light rounded-3 shadow-inner">
                                               <p class="x-small fw-bold text-uppercase text-danger mb-1"><i class="fas fa-book-dead me-1"></i> Materias Reprobadas:</p>
                                               <div class="d-flex flex-wrap gap-1">
                                                   {% for materia_name in riesgo.materias_nombres %}
                                                   <span class="badge bg-danger text-white x-small rounded-pill">{{ materia_name }}</span>
                                                   {% empty %}
                                                   <span class="x-small text-muted">Sin datos de materias.</span>
                                                   {% endfor %}
                                               </div>
                                           </div>
                                       </div>
                                       <div class="text-end ms-2">
                                           <div class="display-6 fw-black text-danger mb-0">{{ riesgo.materias_perdidas }}</div>
                                           <small class="text-uppercase text-muted fw-bold" style="font-size: 0.5rem;">Asignaturas</small>
                                           <div class="mt-3">
                                               <a href="{% url 'ver_observador' riesgo.estudiante.id %}" class="btn btn-sm btn-primary rounded-circle shadow-sm">
                                                   <i class="fas fa-search-plus"></i>
                                               </a>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           </div>
                           {% empty %}
                           <div class="text-center p-5 text-muted bg-white rounded-5 shadow-inner border border-dashed">
                               <i class="fas fa-check-double fa-4x mb-3 text-success opacity-25"></i>
                               <p class="mb-0 fw-bold">Ecosistema sin Alertas de Reprobación</p>
                               <small>Todos los estudiantes cumplen satisfactoriamente el PEI.</small>
                           </div>
                           {% endfor %}
                       </div>
                   </div>
                   
                   <div class="mt-4 bg-primary bg-opacity-10 p-3 rounded-4 border border-primary border-dashed text-center">
                       <p class="x-small text-primary fw-bold mb-0">
                           <i class="fas fa-shield-alt me-1"></i> 
                           El sistema analiza en tiempo real las notas finales de cada asignatura.
                       </p>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="row mb-5 animate__animated animate__fadeIn">
       <div class="col-12 mb-4 d-flex align-items-center border-bottom pb-3">
           <h4 class="fw-bold text-dark mb-0"><i class="fas fa-folder-tree me-3 text-secondary"></i>Gobierno Institucional</h4>
           <span class="badge bg-light text-muted ms-3 border py-2 px-3 rounded-pill fw-bold">Archivo Maestro</span>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card h-100 border-0 shadow-sm hover-elevate card-doc pei-border rounded-5">
               <div class="card-body p-4 d-flex flex-column">
                   <div class="d-flex justify-content-between align-items-start mb-4">
                       <div class="icon-box-lg bg-purple-soft rounded-4 d-flex align-items-center justify-content-center text-purple shadow-sm">
                           <i class="fas fa-university fa-lg"></i>
                       </div>
                       {% if institucion.archivo_pei %}
                           <span class="badge bg-success-subtle text-success border border-success rounded-pill px-3">Vigente</span>
                       {% else %}
                           <span class="badge bg-warning-subtle text-warning border border-warning rounded-pill px-3">Pendiente</span>
                       {% endif %}
                   </div>
                   <h5 class="fw-bold text-dark mb-2">Proyecto Educativo (PEI)</h5>
                   <p class="text-muted small">Marco pedagógico y horizonte institucional que rige el modelo de aprendizaje.</p>
                   <div class="mt-auto pt-3 d-grid gap-2">
                       {% if institucion.archivo_pei %}
                           <a href="{{ institucion.archivo_pei.url }}" target="_blank" class="btn btn-sm btn-outline-purple rounded-pill fw-bold py-2 shadow-sm">
                               <i class="fas fa-external-link-alt me-2"></i> Consultar PDF
                           </a>
                       {% endif %}
                       {% if user.perfil.rol in 'ADMINISTRADOR,COORD_ACADEMICO' %}
                           <button class="btn btn-sm btn-light text-muted rounded-pill py-2" type="button" data-bs-toggle="collapse" data-bs-target="#uploadPEI">
                               <i class="fas fa-cloud-upload-alt me-2"></i> Actualizar
                           </button>
                           <div class="collapse mt-2" id="uploadPEI">
                               <form method="POST" enctype="multipart/form-data" class="p-3 bg-white rounded-4 border shadow-sm">{% csrf_token %}
                                   <input type="file" name="pei_file" class="form-control form-control-sm mb-2" accept=".pdf" required>
                                   <button type="submit" class="btn btn-purple btn-sm w-100 fw-bold rounded-pill">Subir a Nube</button>
                               </form>
                           </div>
                       {% endif %}
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card h-100 border-0 shadow-sm hover-elevate card-doc manual-border rounded-5">
               <div class="card-body p-4 d-flex flex-column">
                   <div class="d-flex justify-content-between align-items-start mb-4">
                       <div class="icon-box-lg bg-orange-soft rounded-4 d-flex align-items-center justify-content-center text-orange shadow-sm">
                           <i class="fas fa-gavel fa-lg"></i>
                       </div>
                       {% if institucion.archivo_manual_convivencia %}
                           <span class="badge bg-success-subtle text-success border border-success rounded-pill px-3">Activo</span>
                       {% else %}
                           <span class="badge bg-danger-subtle text-danger border border-danger rounded-pill px-3">Requerido</span>
                       {% endif %}
                   </div>
                   <h5 class="fw-bold text-dark mb-2">Manual Convivencial</h5>
                   <p class="text-muted small">Normas, derechos y deberes que rigen la vida comunitaria y ruta integral.</p>
                   <div class="mt-auto pt-3 d-grid gap-2">
                       {% if institucion.archivo_manual_convivencia %}
                           <a href="{{ institucion.archivo_manual_convivencia.url }}" target="_blank" class="btn btn-sm btn-outline-orange rounded-pill fw-bold py-2">
                               <i class="fas fa-eye me-2"></i> Ver Normativa
                           </a>
                       {% endif %}
                       {% if user.perfil.rol in 'ADMINISTRADOR,COORD_CONVIVENCIA' %}
                           <button class="btn btn-sm btn-light text-muted rounded-pill py-2" type="button" data-bs-toggle="collapse" data-bs-target="#uploadManual">
                               <i class="fas fa-upload me-2"></i> Actualizar
                           </button>
                           <div class="collapse mt-2" id="uploadManual">
                               <form method="POST" enctype="multipart/form-data" class="p-3 bg-white rounded-4 border shadow-sm">{% csrf_token %}
                                   <input type="file" name="manual_file" class="form-control form-control-sm mb-2" accept=".pdf" required>
                                   <button type="submit" class="btn btn-warning btn-sm w-100 fw-bold text-white rounded-pill">Sincronizar</button>
                               </form>
                           </div>
                       {% endif %}
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card h-100 border-0 shadow-sm hover-elevate card-doc malla-border rounded-5">
               <div class="card-body p-4 d-flex flex-column">
                   <div class="d-flex justify-content-between align-items-start mb-4">
                       <div class="icon-box-lg bg-teal-soft rounded-4 d-flex align-items-center justify-content-center text-teal shadow-sm">
                           <i class="fas fa-scroll fa-lg"></i>
                       </div>
                       <span class="badge bg-success-subtle text-success border border-success rounded-pill px-3">DBA Estructurado</span>
                   </div>
                   <h5 class="fw-bold text-dark mb-2">Malla Curricular</h5>
                   <p class="text-muted small">Contenidos programáticos, competencias y estándares por nivel académico.</p>
                   <div class="mt-auto pt-3 d-grid gap-2">
                       {% if institucion.archivo_malla_curricular %}
                           <a href="{{ institucion.archivo_malla_curricular.url }}" target="_blank" class="btn btn-sm btn-outline-teal rounded-pill fw-bold py-2">
                               <i class="fas fa-th-list me-2"></i> Ver Planes
                           </a>
                       {% endif %}
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card h-100 border-0 shadow-sm hover-elevate card-doc calendario-border rounded-5">
               <div class="card-body p-4 d-flex flex-column">
                   <div class="d-flex justify-content-between align-items-start mb-4">
                       <div class="icon-box-lg bg-danger-soft rounded-4 d-flex align-items-center justify-content-center text-danger shadow-sm">
                           <i class="fas fa-calendar-alt fa-lg"></i>
                       </div>
                       <span class="badge bg-success-subtle text-success border border-success rounded-pill px-3">2026 Activo</span>
                   </div>
                   <h5 class="fw-bold text-dark mb-2">Cronograma Anual</h5>
                   <p class="text-muted small">Agenda de actividades, evaluaciones institucionales y jornadas pedagógicas.</p>
                   <div class="mt-auto pt-3 d-grid gap-2">
                       {% if institucion.archivo_calendario %}
                           <a href="{{ institucion.archivo_calendario.url }}" target="_blank" class="btn btn-sm btn-outline-danger rounded-pill fw-bold py-2">
                               <i class="fas fa-clock me-2"></i> Ver Agenda
                           </a>
                       {% endif %}
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="row g-4 mb-5 animate__animated animate__fadeIn">
       <div class="col-md-6 col-lg-3">
           <div class="card border-0 shadow-lg h-100 bg-white overflow-hidden hover-elevate border-start border-5 border-primary rounded-4">
               <div class="card-body p-4">
                   <div class="d-flex justify-content-between align-items-center">
                       <div>
                           <p class="text-uppercase fw-bold text-muted x-small ls-1 mb-1">Matrícula Total</p>
                            <h2 class="fw-black text-dark mb-0">{{ kpi.total_alumnos }}</h2>
                           <small class="text-success fw-bold"><i class="fas fa-check-circle me-1"></i>Estudiantes Activos</small>
                       </div>
                       <div class="bg-soft-primary rounded-4 p-3 text-primary shadow-sm">
                           <i class="fas fa-users fa-2x"></i>
                       </div>
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3">
           <div class="card border-0 shadow-lg h-100 bg-white overflow-hidden hover-elevate border-start border-5 border-info rounded-4">
               <div class="card-body p-4">
                   <div class="d-flex justify-content-between align-items-center">
                       <div>
                           <p class="text-uppercase fw-bold text-muted x-small ls-1 mb-1">Rendimiento Global</p>
                            <h2 class="fw-black text-info mb-0">{{ kpi.prom_global_acad }}</h2>
                           <small class="text-muted fw-bold">GPA Institucional</small>
                       </div>
                       <div class="radial-progress-kpi">
                           <span class="fw-bold text-info" style="font-size: 0.8rem;">META</span>
                       </div>
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3">
           <div class="card border-0 shadow-lg h-100 bg-white overflow-hidden hover-elevate border-start border-5 border-warning rounded-4">
                <div class="card-body p-4">
                   <div class="d-flex justify-content-between align-items-center">
                       <div>
                           <p class="text-uppercase fw-bold text-muted x-small ls-1 mb-1">Clima Escolar Real</p>
                           <h2 class="fw-black text-dark mb-0">{{ kpi.prom_global_conv }}</h2>
                           <small class="text-muted fw-bold">Materia Convivencia</small>
                       </div>
                       <div class="bg-soft-warning rounded-4 p-3 text-warning shadow-sm">
                           <i class="fas fa-smile-beam fa-2x"></i>
                        </div>
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3">
           <div class="card border-0 shadow-lg h-100 bg-white overflow-hidden hover-elevate border-start border-5 border-success rounded-4">
               <div class="card-body p-4">
                   <div class="d-flex justify-content-between align-items-center">
                       <div>
                           <p class="text-uppercase fw-bold text-muted x-small ls-1 mb-1">Gestión de Cursos</p>
                           <h2 class="fw-black text-dark mb-0">{{ kpi.total_cursos }}</h2>
                           <small class="text-success fw-bold">Grupos Académicos</small>
                       </div>
                        <div class="bg-soft-success rounded-4 p-3 text-success shadow-sm">
                           <i class="fas fa-layer-group fa-2x"></i>
                       </div>
                   </div>
               </div>
           </div>
        </div>
   </div>

   <div class="row mb-5 animate__animated animate__fadeInUp">
       <div class="col-lg-8 mb-4 mb-lg-0">
           <div class="card border-0 shadow-lg h-100 bg-white rounded-5 overflow-hidden">
               <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                   <h5 class="fw-bold text-dark mb-0"><i class="fas fa-chart-bar me-3 text-primary"></i>Desempeño Comparativo Grupal (Real)</h5>
                   <div class="btn-group shadow-sm border rounded-pill overflow-hidden">
                       <button class="btn btn-xs btn-light px-3 py-1 fw-bold border-0">GPA</button>
                       <button class="btn btn-xs btn-primary px-3 py-1 fw-bold shadow-none">Analítica</button>
                   </div>
               </div>
                <div class="card-body p-4">
                   <div style="height: 400px; width: 100%;">
                       <canvas id="peiChartSupremo"></canvas>
                   </div>
               </div>
           </div>
       </div>
       
       <div class="col-lg-4">
            <div class="card border-0 shadow-lg h-100 bg-white rounded-5 overflow-hidden">
               <div class="card-header bg-gradient-success border-0 pt-4 px-4 text-center">
                   <h5 class="fw-bold text-white mb-0"><i class="fas fa-user-clock me-2"></i>Monitor de Asistencia</h5>
                   <small class="text-white-50">Reporte Diario Institucional</small>
               </div>
               <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center">
                   <div style="height: 280px; width: 100%; position: relative;">
                       <canvas id="asistenciaChartSupremo"></canvas>
                       <div class="chart-center-label">
                           <h4 class="mb-0 fw-black text-success">92%</h4>
                           <small class="text-muted fw-bold">Efectividad</small>
                       </div>
                   </div>
                   <div class="mt-4 w-100 border-top pt-4 text-center">
                       <div class="row">
                           <div class="col-6 border-end">
                               <h6 class="mb-0 fw-bold text-dark">Estable</h6>
                               <small class="text-muted">Estado Red</small>
                           </div>
                           <div class="col-6">
                               <h6 class="mb-0 fw-bold text-success">-2.4%</h6>
                               <small class="text-muted">Deserción Prev.</small>
                           </div>
                       </div>
                   </div>
               </div>
            </div>
       </div>
   </div>

   <div class="row mb-5 animate__animated animate__fadeInUp">
       <div class="col-lg-6 mb-4 mb-lg-0">
           <div class="card border-0 shadow-lg h-100 bg-white rounded-5 overflow-hidden">
               <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                   <div>
                       <h5 class="fw-bold text-danger mb-0"><i class="fas fa-user-times me-2"></i>Alertas de Ausentismo Crítico</h5>
                       <p class="text-muted x-small mb-0">Estudiantes con inasistencia superior al umbral establecido.</p>
                   </div>
                   <a href="{% url 'historial_asistencia' %}" class="btn btn-xs btn-outline-danger rounded-pill px-3 fw-bold">Gestionar</a>
               </div>
               <div class="card-body p-0">
                   <div class="table-responsive">
                       <table class="table table-hover align-middle mb-0">
                           <thead class="bg-light text-muted x-small text-uppercase fw-bold border-bottom">
                               <tr>
                                   <th class="ps-4">Identidad del Alumno</th>
                                   <th class="text-center">Fallas Totales</th>
                                   <th class="text-end pe-4">Acción</th>
                               </tr>
                           </thead>
                           <tbody>
                               {% for alerta in top_fallas %}
                               <tr>
                                   <td class="ps-4 py-3">
                                       <div class="d-flex align-items-center">
                                           <div class="avatar-xs rounded-circle bg-danger-subtle text-danger d-flex align-items-center justify-content-center me-3 fw-bold shadow-sm">
                                               {{ alerta.estudiante__first_name|slice:":1" }}
                                           </div>
                                           <div>
                                               <div class="fw-bold text-dark small">{{ alerta.estudiante__first_name }} {{ alerta.estudiante__last_name }}</div>
                                               <small class="text-muted x-small">{{ alerta.curso__nombre }}</small>
                                           </div>
                                       </div>
                                   </td>
                                   <td class="text-center">
                                       <span class="badge bg-danger rounded-pill px-3 py-2 shadow-sm fw-bold">{{ alerta.total }}</span>
                                   </td>
                                   <td class="text-end pe-4">
                                       <a href="{% url 'ver_observador' alerta.estudiante__id %}" class="btn btn-sm btn-light text-primary border rounded-circle shadow-sm"><i class="fas fa-eye"></i></a>
                                   </td>
                               </tr>
                               {% empty %}
                               <tr><td colspan="3" class="text-center py-5 text-muted fst-italic">Sin alertas críticas de inasistencia.</td></tr>
                               {% endfor %}
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </div>

       <div class="col-lg-6">
           <div class="card border-0 shadow-lg h-100 bg-white rounded-5 overflow-hidden">
               <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                   <div>
                       <h5 class="fw-bold text-dark mb-0"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Zonas de Riesgo Convivencial</h5>
                       <p class="text-muted x-small mb-0">Estudiantes con calificación de convivencia inferior a 3.5.</p>
                   </div>
               </div>
               <div class="card-body p-0">
                   <div class="table-responsive">
                       <table class="table table-hover align-middle mb-0">
                           <thead class="bg-light text-muted x-small text-uppercase fw-bold border-bottom">
                               <tr>
                                   <th class="ps-4">Identidad del Alumno</th>
                                   <th class="text-center">Nota Promedio</th>
                                   <th class="text-end pe-4">Intervenir</th>
                               </tr>
                           </thead>
                           <tbody>
                               {% for alerta in alertas_convivencia %}
                               <tr>
                                   <td class="ps-4 py-3">
                                       <div class="d-flex align-items-center">
                                           <div class="avatar-xs rounded-circle bg-warning-subtle text-warning d-flex align-items-center justify-content-center me-3 fw-bold border border-warning-subtle shadow-sm">
                                               {{ alerta.estudiante__first_name|slice:":1" }}
                                           </div>
                                           <div>
                                               <div class="fw-bold text-dark small">{{ alerta.estudiante__first_name }} {{ alerta.estudiante__last_name }}</div>
                                               <small class="text-muted x-small">{{ alerta.materia__curso__nombre }}</small>
                                           </div>
                                       </div>
                                   </td>
                                   <td class="text-center">
                                       <span class="badge bg-warning text-dark border border-warning rounded-pill px-3 py-2 fw-black shadow-sm">{{ alerta.nota_promedio|floatformat:2 }}</span>
                                   </td>
                                   <td class="text-end pe-4">
                                       <a href="{% url 'ver_observador' alerta.estudiante__id %}" class="btn btn-sm btn-light text-primary border rounded-circle transition-all"><i class="fas fa-pen-nib"></i></a>
                                   </td>
                               </tr>
                               {% empty %}
                               <tr><td colspan="3" class="text-center py-5 text-muted fst-italic">No hay alertas convivenciales de baja calificación.</td></tr>
                               {% endfor %}
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="card border-0 shadow-lg mb-5 overflow-hidden rounded-5" style="background-color: #ffffff;">
       <div class="card-body p-5 text-center bg-gradient-light-subtle">
           <h3 class="fw-black mb-2 text-dark">Búsqueda Maestra Stratos</h3>
           <p class="text-muted mb-4 lead">Acceda instantáneamente a observador, notas y analítica del alumno.</p>
           <form method="GET" action="">
               <div class="input-group input-group-lg shadow-2xl rounded-pill overflow-hidden border w-75 mx-auto transition-all focus-within-scale border-primary-subtle">
                   <span class="input-group-text bg-white border-0 ps-4"><i class="fas fa-search text-muted"></i></span>
                   <input type="text" name="q" class="form-control bg-white border-0 py-4 shadow-none"
                          placeholder="Ingrese nombre, código de matrícula o ID..."
                          value="{{ query|default:'' }}">
                    <button class="btn btn-primary px-5 fw-bold text-uppercase" type="submit">Ejecutar Búsqueda</button>
               </div>
           </form>
       </div>
   </div>

   {% if query %}
       <div class="mb-5 animate__animated animate__fadeIn px-2">
           <h5 class="fw-bold text-secondary mb-4 px-3 d-flex align-items-center">
               <i class="fas fa-list-ul me-3 text-primary"></i>
               Coincidencias detectadas para: <span class="text-primary ms-2">"{{ query }}"</span>
           </h5>
            {% if estudiantes %}
               <div class="row g-4">
                   {% for estudiante in estudiantes %}
                   <div class="col-md-6 col-lg-4 col-xl-3">
                       <div class="card h-100 border-0 shadow-sm hover-elevate rounded-5 overflow-hidden">
                           <div class="card-body d-flex align-items-center p-3">
                               <div class="avatar-md me-3 bg-primary-subtle text-primary d-flex align-items-center justify-content-center rounded-circle fw-black shadow-sm">
                                   {{ estudiante.first_name|slice:":1" }}{{ estudiante.last_name|slice:":1" }}
                               </div>
                               <div class="flex-grow-1 overflow-hidden">
                                   <h6 class="fw-bold mb-0 text-dark text-truncate">{{ estudiante.get_full_name }}</h6>
                                    <small class="text-muted">ID: {{ estudiante.username }}</small>
                               </div>
                               <div class="d-flex flex-column gap-1">
                                   <a href="{% url 'ver_observador' estudiante.id %}" class="btn btn-sm btn-primary rounded-circle shadow-sm">
                                       <i class="fas fa-folder-open"></i>
                                   </a>
                                   <a href="{% url 'ai_engine' %}?action=analisis_convivencia&target_id={{ estudiante.id }}" class="btn btn-sm btn-purple rounded-circle shadow-sm">
                                       <i class="fas fa-robot"></i>
                                   </a>
                               </div>
                           </div>
                       </div>
                   </div>
                   {% endfor %}
                </div>
           {% else %}
               <div class="alert alert-warning border-0 shadow-lg p-4 rounded-5 text-center">
                   <i class="fas fa-user-slash fa-3x mb-3 opacity-25"></i>
                   <p class="mb-0 fw-bold">No se han detectado registros asociados en la base de datos.</p>
               </div>
           {% endif %}
       </div>
   {% endif %}

   <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-4 px-2">
       <h4 class="fw-bold text-dark mb-0 d-flex align-items-center">
           <div class="bg-primary rounded-3 p-2 me-3 text-white shadow-sm transition-all hover-scale"><i class="fas fa-chalkboard-teacher"></i></div>
           Rendimiento Académico por Grupos
       </h4>
       <div class="d-flex gap-2">
           <span class="badge bg-soft-primary text-primary px-4 py-2 rounded-pill fw-bold border border-primary-subtle shadow-sm">Cursos Activos: {{ vista_cursos|length }}</span>
       </div>
    </div>

   <div class="accordion shadow-sm rounded-5 overflow-hidden border-0" id="accordionProMaster">
       {% for item in vista_cursos %}
       <div class="accordion-item border-0 mb-4 shadow-lg rounded-5 overflow-hidden">
           <h2 class="accordion-header">
               <button class="accordion-button collapsed py-4 bg-white text-dark fw-bold shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ item.curso.id }}">
                   <div class="row w-100 align-items-center">
                       <div class="col-md-3 d-flex align-items-center">
                            <span class="badge bg-primary px-4 py-2 me-3 shadow-lg rounded-pill">{{ item.curso.nombre }}</span>
                           <span class="small text-muted fw-bold">{{ item.stats.alumnos }} Matrículas</span>
                       </div>
                       <div class="col-md-3 text-center d-none d-md-block border-start">
                           <small class="text-muted text-uppercase fw-bold ls-1" style="font-size: 0.65rem;">Promedio Grupo</small>
                           <div class="fw-black text-info fs-4">{{ item.stats.acad }}</div>
                       </div>
                       <div class="col-md-3 text-center d-none d-md-block border-start">
                           <small class="text-muted text-uppercase fw-bold ls-1" style="font-size: 0.65rem;">Índice Convivencia (Real)</small>
                            <div class="fw-black text-warning fs-4">{{ item.stats.conv }}</div>
                       </div>
                       <div class="col-md-3 text-end d-none d-md-block border-start">
                           <span class="badge {% if item.stats.acad < 3.2 %}bg-danger animate__animated animate__pulse animate__infinite{% else %}bg-success{% endif %} px-4 py-2 rounded-pill shadow-sm">
                               {% if item.stats.acad < 3.2 %}Acción Prioritaria{% else %}Óptimo{% endif %}
                           </span>
                       </div>
                   </div>
               </button>
           </h2>
           <div id="collapse{{ item.curso.id }}" class="accordion-collapse collapse" data-bs-parent="#accordionProMaster">
               <div class="accordion-body p-0 bg-light-subtle">
                   {% if item.top_10_academico %}
                   <div class="p-4 bg-white border-bottom shadow-inner">
                       <div class="card border-0 shadow-lg rounded-5 overflow-hidden">
                           <div class="card-header bg-gradient-success text-white py-3 d-flex justify-content-between align-items-center border-0">
                               <h6 class="mb-0 fw-bold"><i class="fas fa-award me-2 text-warning"></i>Excelencia Académica (Top 10)</h6>
                               <span class="badge bg-white text-success rounded-pill fw-bold border px-3">2026-A</span>
                           </div>
                           <div class="card-body p-0">
                               <div class="table-responsive">
                                   <table class="table table-sm table-striped mb-0 small text-center align-middle">
                                       <thead class="text-secondary bg-light text-uppercase fw-bold" style="font-size: 0.65rem;">
                                           <tr>
                                               <th style="width: 100px;">Ranking</th>
                                               <th class="text-start ps-5">Nombre del Alumno</th>
                                               <th style="width: 200px;">GPA Definitivo</th>
                                           </tr>
                                       </thead>
                                       <tbody>
                                           {% for top_est in item.top_10_academico %}
                                           <tr>
                                               <td class="fw-bold py-3 text-center">
                                                   {% if forloop.counter == 1 %}<div class="rank-circle rank-gold mx-auto">1</div>
                                                   {% elif forloop.counter == 2 %}<div class="rank-circle rank-silver mx-auto">2</div>
                                                   {% elif forloop.counter == 3 %}<div class="rank-circle rank-bronze mx-auto">3</div>
                                                   {% else %}<span class="text-muted fw-black">#{{ forloop.counter }}</span>{% endif %}
                                               </td>
                                               <td class="text-start ps-5 fw-bold text-dark fs-6">{{ top_est.nombre }}</td>
                                               <td><div class="d-inline-block px-3 py-1 bg-success bg-opacity-10 text-success rounded-pill fw-black shadow-sm">{{ top_est.promedio }}</div></td>
                                           </tr>
                                           {% endfor %}
                                       </tbody>
                                   </table>
                               </div>
                           </div>
                       </div>
                   </div>
                   {% endif %}

                   <div class="table-responsive p-4">
                       <table class="table table-hover align-middle mb-0 bg-white rounded-5 shadow-sm border overflow-hidden">
                            <thead class="bg-dark text-white small text-uppercase fw-bold border-0">
                               <tr>
                                   <th class="ps-4 py-4">Información del Estudiante</th>
                                   {% for p in periodos %}
                                       <th class="text-center">Periodo {{ forloop.counter }}</th>
                                   {% endfor %}
                                   <th class="text-end pe-5">Gestión Individual</th>
                               </tr>
                           </thead>
                           <tbody>
                               {% for obj_est in item.estudiantes %}
                               <tr>
                                   <td class="ps-4 py-3">
                                       <div class="d-flex align-items-center">
                                           <div class="avatar-xs rounded-circle bg-soft-primary text-primary d-flex align-items-center justify-content-center me-3 border border-primary-subtle fw-black shadow-sm">
                                               {{ obj_est.obj.first_name|slice:":1" }}
                                           </div>
                                           <div>
                                               <span class="fw-bold text-dark d-block mb-0">{{ obj_est.obj.get_full_name }}</span>
                                               <small class="text-muted x-small fw-bold">Matrícula: {{ obj_est.obj.username }}</small>
                                           </div>
                                       </div>
                                   </td>
                                   {% for nota in obj_est.notas %}
                                       <td class="text-center">
                                           {% if nota != "-" %}
                                               <div class="nota-bubble {% if nota < 3.0 %}nota-fail{% elif nota >= 4.0 %}nota-success{% else %}nota-warning{% endif %}">
                                                   {{ nota }}
                                               </div>
                                           {% else %}
                                               <span class="text-muted opacity-25 x-small"><i class="fas fa-minus"></i></span>
                                           {% endif %}
                                       </td>
                                   {% endfor %}
                                   <td class="text-end pe-5">
                                       <div class="btn-group btn-group-sm shadow-sm rounded-pill overflow-hidden border">
                                           <a href="{% url 'ver_observador' obj_est.obj.id %}" class="btn btn-white text-dark" title="Abrir Historial"><i class="fas fa-folder-open"></i></a>
                                       </div>
                                   </td>
                               </tr>
                               {% endfor %}
                           </tbody>
                       </table>
                   </div>
                </div>
           </div>
       </div>
       {% endfor %}
    </div>
</div>

<div class="card card-premium overflow-hidden animate__animated animate__fadeInUp" style="animation-delay: 0.3s; margin-top: 3rem;">
    <div class="card-header bg-transparent border-bottom py-4 px-4">
        <h5 class="fw-bold text-dark mb-1">Registro Maestro de Casos</h5>
        <p class="text-muted x-small mb-0">Base de datos unificada de todas las interacciones y reportes estudiantiles.</p>
    </div>
    <div class="table-responsive">
        <table class="table align-middle mb-0 custom-table">
            <thead>
                <tr>
                    <th class="ps-4">Estudiante</th>
                    <th>Categoría</th>
                    <th>Detalles</th>
                    <th>Autoridad</th>
                    <th>Fecha</th>
                    <th class="text-end pe-4">Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for obs in observaciones %}
                <tr>
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <div class="avatar-md rounded-circle gradient-avatar d-flex align-items-center justify-content-center text-white fw-bold" style="width: 42px; height: 42px;">
                                {{ obs.estudiante.first_name|slice:":1" }}
                            </div>
                            <div class="ms-3">
                                <div class="fw-bold text-dark">{{ obs.estudiante.get_full_name }}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-soft-primary text-primary rounded-pill px-3 py-2">{{ obs.tipo }}</span></td>
                    <td class="text-muted small">{{ obs.descripcion|truncatechars:100 }}</td>
                    <td class="small fw-semibold">{{ obs.autor.get_full_name }}</td>
                    <td class="small">{{ obs.fecha_creacion|date:"d M, Y" }}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-light btn-sm rounded-circle border" type="button" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-4">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalSeguimiento" onclick="prepararSeguimiento('{{ obs.estudiante.id }}', '{{ obs.estudiante.get_full_name|escapejs }}')">📝 Reportar Seguimiento</a></li>
                        </ul>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="historial-seguimientos-section" class="historial-seguimientos animate__animated animate__fadeInUp" style="margin-top: 3rem;">
    <div class="historial-header">
        <h3 class="historial-title"><i class="fas fa-history me-2"></i>Historial de Seguimientos</h3>
        <button class="btn-generar-pdf" onclick="window.print()"><i class="fas fa-print me-2"></i>Imprimir Reporte General</button>
    </div>
    <div class="table-responsive">
        <table class="historial-table">
            <thead>
                <tr><th>Estudiante</th><th>Tipo</th><th>Fecha</th><th>Profesional</th><th>Detalles</th><th>Acciones</th></tr>
            </thead>
            <tbody>
                {% for seguimiento in historial_seguimientos %}
                <tr>
                    <td>{{ seguimiento.estudiante.get_full_name }}</td>
                    <td><span class="badge bg-soft-info text-info rounded-pill px-3">{{ seguimiento.get_tipo_display }}</span></td>
                    <td>{{ seguimiento.fecha|date:"d/m/Y" }}</td>
                    <td>{{ seguimiento.profesional.get_full_name }}</td>
                    <td>{{ seguimiento.descripcion|truncatechars:50 }}</td>
                    <td><a href="{% url 'generar_seguimiento_pdf' seguimiento.id %}" class="btn btn-sm btn-outline-primary rounded-pill" target="_blank">PDF</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalSeguimiento" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 rounded-4 shadow-2xl overflow-hidden">
            <div class="modal-header border-0 p-4 bg-gradient-success text-white">
                <div class="d-flex align-items-center w-100">
                    <div class="icon-box bg-white-20 rounded-circle me-3"><i class="fas fa-clipboard-list fa-lg"></i></div>
                    <div>
                        <h5 class="modal-title fw-bold">Nuevo Seguimiento Documental</h5>
                        <p class="mb-0 small opacity-75">Generación de Actas y Compromisos Institucionales</p>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-4 bg-light-subtle">
                <form id="formSeguimiento">
                    {% csrf_token %}
                    <div class="mb-4 text-center">
                        <h6 class="text-muted text-uppercase x-small fw-bold ls-1 mb-2">Estudiante Seleccionado</h6>
                        <h3 class="fw-black text-dark mb-0" id="nombreEstudianteModal">Cargando...</h3>
                        <input type="hidden" id="idEstudianteModal" name="estudiante_id">
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-check-label w-100">
                                <input type="radio" name="tipo_documento" value="CONVIVENCIA" class="btn-check" checked>
                                <div class="card card-premium text-center p-3 cursor-pointer">
                                    <h6 class="fw-bold mb-1">Acta Convivencia</h6>
                                </div>
                            </label>
                        </div>
                        <div class="col-md-4">
                            <label class="form-check-label w-100">
                                <input type="radio" name="tipo_documento" value="PSICOLOGIA" class="btn-check">
                                <div class="card card-premium text-center p-3 cursor-pointer">
                                    <h6 class="fw-bold mb-1">Seguimiento Psico</h6>
                                </div>
                            </label>
                        </div>
                        <div class="col-md-4">
                            <label class="form-check-label w-100">
                                <input type="radio" name="tipo_documento" value="ACADEMICO" class="btn-check">
                                <div class="card card-premium text-center p-3 cursor-pointer">
                                    <h6 class="fw-bold mb-1">Compromiso Acad.</h6>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small">Detalles del Seguimiento (Principal)</label>
                        <textarea id="contenidoSeguimiento" name="descripcion" class="form-control border-0 bg-white shadow-sm p-3" rows="4" placeholder="Describa los acuerdos principales..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small">Observaciones Adicionales</label>
                        <textarea id="observacionesAdicionales" name="observaciones_adicionales" class="form-control border-0 bg-white shadow-sm p-3" rows="3" placeholder="Compromisos extras o notas de más para el reporte..."></textarea>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-outline-dark rounded-pill px-4 me-2" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success rounded-pill px-5 shadow-lg fw-bold" onclick="procesarSeguimiento(event)">
                            <i class="fas fa-file-pdf me-2"></i>Guardar y Generar PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalIA" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 rounded-5 shadow-2xl overflow-hidden">
            <div class="modal-header border-0 p-4 bg-gradient-ai text-white position-relative">
                <div class="d-flex align-items-center w-100">
                    <div class="icon-box-md bg-white-20 rounded-4 me-3"><i class="fas fa-robot fa-lg"></i></div>
                    <div><h5 class="modal-title fw-black fs-4">Consultoría Stratos AI</h5></div>
                    <button type="button" class="btn-close btn-close-white ms-auto shadow-none" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-5 bg-light-subtle" style="min-height: 400px;">
                <div id="aiLoading" class="text-center py-5"><div class="spinner-grow text-primary mb-4" style="width: 4rem; height: 4rem;"></div><h5>Sincronizando con base de datos...</h5></div>
                <div id="aiResults" class="d-none animate__animated animate__fadeIn"><div id="aiTextContent" class="markdown-body bg-white p-5 rounded-5 border shadow-xl"></div></div>
            </div>
        </div>
    </div>
</div>

<script>
   function prepararSeguimiento(id, nombre) {
       document.getElementById('idEstudianteModal').value = id;
       document.getElementById('nombreEstudianteModal').textContent = nombre;
       document.getElementById('contenidoSeguimiento').value = "";
       document.getElementById('observacionesAdicionales').value = ""; // Limpiar campo extra
   }

   async function procesarSeguimiento(event) {
       if (event) event.preventDefault();
       const idEstudiante = document.getElementById('idEstudianteModal').value;
       const descripcion = document.getElementById('contenidoSeguimiento').value;
       const obsAdicionales = document.getElementById('observacionesAdicionales').value;
       const tipoDoc = document.querySelector('input[name="tipo_documento"]:checked').value;

       if (!descripcion.trim()) { alert("⚠️ Ingrese detalles."); return; }

       const url = "{% url 'guardar_seguimiento' %}";
       const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
       const formData = new FormData();
       formData.append('estudiante_id', idEstudiante);
       formData.append('tipo', tipoDoc);
       formData.append('descripcion', descripcion);
       formData.append('observaciones_adicionales', obsAdicionales); // ENVIAR A LA BD

       try {
           const response = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: formData });
           const data = await response.json();
           if (data.success) {
               window.open(`/seguimiento/pdf/${data.id}/`, '_blank');
               location.reload();
           }
       } catch (error) { console.error(error); }
   }

   document.addEventListener('DOMContentLoaded', function() {
       // --- DATOS REALES CORREGIDOS SIN INVENTOS ---
       const labelsGrados = JSON.parse('{{ chart_data.labels|safe|default:"[]" }}');
       const dataAcadReal = JSON.parse('{{ chart_data.acad|safe|default:"[]" }}');
       const dataConvReal = JSON.parse('{{ chart_data.conv|safe|default:"[]" }}');
       const radarLabels = JSON.parse('{{ chart_data.radar_labels|safe|default:"[]" }}');
       const radarValues = JSON.parse('{{ chart_data.radar_values|safe|default:"[]" }}');

       // 1. MAPA DE CALOR (RADAR) REAL POR FAMILIAS
       const ctxRadar = document.getElementById('radarChartPro');
       if (ctxRadar) {
           new Chart(ctxRadar, {
               type: 'radar',
               data: {
                   labels: radarLabels,
                   datasets: [{
                       label: 'Promedio Real Institucional',
                       data: radarValues,
                       backgroundColor: 'rgba(67, 97, 238, 0.25)',
                       borderColor: '#4361ee',
                       borderWidth: 4,
                       fill: true
                   }]
               },
               options: {
                   responsive: true, maintainAspectRatio: false,
                   scales: { r: { beginAtZero: true, max: 5, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { display: false } } }
               }
           });
       }

       // 2. COMPARATIVA REAL POR GRADO (BARRAS)
       const ctxBar = document.getElementById('peiChartSupremo');
       if (ctxBar) {
           new Chart(ctxBar, {
               type: 'bar',
               data: {
                   labels: labelsGrados,
                   datasets: [
                       { label: 'Academia', data: dataAcadReal, backgroundColor: '#4361ee', borderRadius: 12 },
                       { label: 'Convivencia (Materia)', data: dataConvReal, backgroundColor: '#ffc107', borderRadius: 12 }
                   ]
               },
               options: {
                   responsive: true, maintainAspectRatio: false,
                   scales: { y: { beginAtZero: true, max: 5, grid: { color: 'rgba(0,0,0,0.05)' } } }
               }
           });
       }

       // 3. ASISTENCIA
       const ctxDonut = document.getElementById('asistenciaChartSupremo');
       if (ctxDonut) {
           const dataAsistencia = JSON.parse('{{ stats_asistencia|safe }}');
           new Chart(ctxDonut, {
               type: 'doughnut',
               data: {
                   labels: ['Asistió', 'Falla', 'Excusa', 'Tarde'],
                   datasets: [{ data: dataAsistencia, backgroundColor: ['#198754', '#dc3545', '#0dcaf0', '#ffc107'], borderWidth: 8 }]
               },
               options: { responsive: true, maintainAspectRatio: false, cutout: '80%' }
           });
       }
   });

   async function iniciarAnalisisIA() {
       const modal = new bootstrap.Modal(document.getElementById('modalIA'));
       modal.show();
       const response = await fetch("{% url 'ai_engine' %}?action=analisis_global_bienestar", {
           method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
           body: JSON.stringify({ instruccion: "Analiza el panorama institucional." })
       });
       const data = await response.json();
       if (data.success) { document.getElementById('aiTextContent').innerHTML = marked.parse(data.content); document.getElementById('aiLoading').classList.add('d-none'); document.getElementById('aiResults').classList.remove('d-none'); }
   }
</script>

<style>
    :root { --purple-primary: #6610f2; --blue-institutional: #4361ee; --soft-gray: #f4f7fe; }
    body { background-color: var(--soft-gray); font-family: 'Inter', sans-serif; }
    .bg-gradient-primary { background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%); }
    .bg-gradient-ai { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
    .bg-gradient-success { background: linear-gradient(135deg, #0f9d58 0%, #20c997 100%); }
    .fw-black { font-weight: 900; }
    .icon-box-xl { width: 95px; height: 95px; border-radius: 50%; }
    .hover-elevate { transition: all 0.3s ease-out; }
    .hover-elevate:hover { transform: translateY(-12px); box-shadow: 0 25px 50px rgba(0,0,0,0.1) !important; }
    .card-doc { border-top-width: 8px !important; }
    .pei-border { border-top: 8px solid var(--purple-primary) !important; }
    .manual-border { border-top: 8px solid #fd7e14 !important; }
    .bg-soft-primary { background-color: #eef2ff; }
    .bg-soft-danger { background-color: #fff5f5; }
    .nota-bubble { display: inline-block; padding: 6px 14px; border-radius: 50px; font-weight: 800; font-size: 0.85rem; }
    .nota-fail { background: #fff1f2; color: #e11d48; }
    .nota-success { background: #f0fdf4; color: #16a34a; }
    .scroll-pro::-webkit-scrollbar { width: 8px; }
    .scroll-pro::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; }
    .chart-center-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    .historial-seguimientos { background: white; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    .historial-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 1rem; }
    .historial-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .historial-table th { background: #f8f9fa; padding: 1rem; text-align: left; }
    .historial-table td { padding: 1rem; border-bottom: 1px solid #eee; }
    .btn-generar-pdf { background: var(--blue-institutional); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 50px; font-weight: 600; }
    .gradient-avatar { background: linear-gradient(135deg, #4361ee, #7209b7); }
</style>
{% endblock %}