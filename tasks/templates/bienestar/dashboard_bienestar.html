{% extends 'base.html' %}
{% load dict_filters %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
        --success-gradient: linear-gradient(135deg, #0f9d58 0%, #20c997 100%);
        --danger-gradient: linear-gradient(135deg, #e63946 0%, #d00000 100%);
        --warning-gradient: linear-gradient(135deg, #f8961e 0%, #f9c74f 100%);
        --info-gradient: linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%);
        --glass-bg: rgba(255, 255, 255, 0.95);
        --glass-border: 1px solid rgba(255, 255, 255, 0.5);
        --shadow-soft: 0 10px 30px -10px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
        --radius-xl: 1.5rem;
        --font-main: 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
        background-color: #f0f2f5;
        font-family: var(--font-main);
        background-image: radial-gradient(circle at 10% 20%, rgba(67, 97, 238, 0.03) 0%, transparent 40%),
                          radial-gradient(circle at 90% 80%, rgba(32, 201, 151, 0.03) 0%, transparent 40%);
        background-attachment: fixed;
    }

    /* TARJETAS PREMIUM */
    .card-premium {
        background: var(--glass-bg);
        border: var(--glass-border);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-soft);
        transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        overflow: hidden;
    }
    
    .card-premium:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-hover);
    }

    /* BOTONES FLOTANTES */
    .btn-float {
        border-radius: 50px;
        font-weight: 700;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .btn-float:hover {
        transform: scale(1.05);
        filter: brightness(1.1);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }
    
    /* ICON BOXES */
    .icon-box-xl {
        width: 90px; height: 90px;
        border-radius: 24px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
    }
    .icon-box-lg { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 16px; }
    .icon-box-md { width: 50px; height: 50px; }

    /* CHARTS */
    .chart-container-responsive {
        min-height: 350px;
    }
    @media (max-width: 768px) {
        .chart-container-responsive {
            min-height: 400px;
        }
        .display-5 { font-size: 2rem; }
    }

    /* TEXTOS Y BADGES */
    .fw-black { font-weight: 900; }
    .ls-1 { letter-spacing: 1px; }
    .x-small { font-size: 0.75rem; }
    
    .badge-pill-soft {
        padding: 0.5em 1em;
        border-radius: 50rem;
        font-weight: 700;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }

    /* SCROLLBAR */
    .scroll-pro::-webkit-scrollbar { width: 6px; }
    .scroll-pro::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .scroll-pro::-webkit-scrollbar-track { background: transparent; }

    /* AI MAGIC BUTTON */
    .btn-ai-magic {
        background: linear-gradient(90deg, #6366f1, #8b5cf6, #d946ef);
        background-size: 200% 200%;
        animation: gradientMove 3s ease infinite;
        border: none;
        box-shadow: 0 10px 25px rgba(124, 58, 237, 0.4);
    }
    @keyframes gradientMove { 0% {background-position: 0% 50%} 50% {background-position: 100% 50%} 100% {background-position: 0% 50%} }

    /* UTILIDADES DE COLOR */
    .bg-purple-soft { background-color: #f3e8ff; color: #7e22ce; }
    .bg-orange-soft { background-color: #fff7ed; color: #c2410c; }
    .bg-teal-soft { background-color: #f0fdfa; color: #0f766e; }
    .bg-danger-soft { background-color: #fef2f2; color: #b91c1c; }
    
    .text-purple { color: #7e22ce; }
    .text-orange { color: #c2410c; }
    .text-teal { color: #0f766e; }
</style>

<div class="container-fluid py-5" style="max-width: 1800px; min-height: 100vh;">
  
   <div class="row mb-5 align-items-center animate__animated animate__fadeInDown">
       <div class="col-xl-5 col-lg-6 mb-4 mb-lg-0">
           <div class="d-flex align-items-center justify-content-center justify-content-lg-start">
               <div class="icon-box-xl bg-gradient-primary text-white me-4 hover-lift">
                   <i class="fas fa-chart-pie fa-3x"></i>
               </div>
               <div class="text-center text-lg-start">
                   <h6 class="text-uppercase text-primary fw-bold ls-2 mb-1">Ecosistema Digital Stratos</h6>
                   <h1 class="fw-black text-dark mb-0 display-5">Gestión & Bienestar</h1>
                   <p class="text-muted lead mb-0 mt-1">
                       <span class="badge bg-soft-primary text-primary border border-primary-subtle rounded-pill px-3">
                           <i class="fas fa-user-shield me-1"></i> {{ user.perfil.get_rol_display }}
                       </span>
                       <span class="ms-2 small align-middle">Centro de Control</span>
                   </p>
               </div>
           </div>
       </div>
       
       <div class="col-xl-7 col-lg-6">
           <div class="d-flex flex-wrap justify-content-center justify-content-lg-end gap-3 align-items-center">
                <button class="btn btn-ai-magic btn-float rounded-pill px-4 py-3 fw-bold text-white" onclick="iniciarAnalisisIA()">
                    <i class="fas fa-sparkles me-2"></i> Consultar IA Stratos
                </button>

                <div class="vr mx-2 opacity-25 d-none d-xl-block" style="height: 40px;"></div>

                <a href="{% url 'reporte_consolidado' %}" class="btn btn-white btn-float shadow-sm text-success" title="Sábana Excel">
                    <i class="fas fa-file-excel fa-lg"></i>
                </a>

                <a href="{% url 'historial_global_observaciones' %}" class="btn btn-white btn-float shadow-sm text-primary" title="Historial">
                    <i class="fas fa-history fa-lg"></i>
                </a>

                <a href="{% url 'ai_engine' %}?action=cumplimiento_pei" class="btn btn-white btn-float shadow-sm text-purple" title="Auditoría IA">
                    <i class="fas fa-robot fa-lg"></i>
                </a>
                
                <a href="{% url 'dashboard_academico' %}" class="btn btn-warning btn-float shadow-lg text-dark px-4">
                    <i class="fas fa-brain me-2"></i>IA Académica
                </a>

                <a href="{% url 'dashboard_bienestar' %}" class="btn btn-primary btn-float shadow-lg px-3" title="Recargar">
                    <i class="fas fa-sync-alt"></i>
                </a>
           </div>
           
           <div class="text-center text-lg-end mt-3">
               <div class="d-inline-flex align-items-center bg-white border border-light px-3 py-1 rounded-pill shadow-sm">
                   <div class="spinner-grow spinner-grow-sm text-success me-2" role="status"></div>
                   <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">En Línea: <span class="text-dark">{% now "d M - H:i" %}</span></small>
               </div>
           </div>
       </div>
   </div>

   <div class="card card-premium mb-5 animate__animated animate__fadeInUp">
       <div class="card-header bg-white border-0 pt-4 px-4 pb-0 d-flex flex-wrap justify-content-between align-items-center">
           <div class="mb-3 mb-md-0">
               <h4 class="fw-black text-dark mb-1 d-flex align-items-center">
                   <i class="fas fa-satellite-dish me-3 text-danger"></i>
                   Radar de Riesgo Académico
               </h4>
               <p class="text-muted small mb-0 ms-1">Detección automática de anomalías en el rendimiento estudiantil.</p>
           </div>
           <div class="d-flex gap-2">
               <span class="badge-pill-soft bg-danger-subtle text-danger border border-danger-subtle">
                   <i class="fas fa-bell me-1"></i> Crítico
               </span>
               <span class="badge-pill-soft bg-dark text-white">
                   {{ top_riesgo_academico|length }} Casos Activos
               </span>
           </div>
       </div>
       <div class="card-body p-4">
           <div class="row g-4 align-items-stretch">
               <div class="col-lg-3">
                   <div class="d-flex flex-column gap-3 h-100">
                       <div class="card bg-danger-subtle border-0 p-4 rounded-4 flex-grow-1 position-relative overflow-hidden">
                           <div class="position-absolute top-0 end-0 opacity-10 p-3"><i class="fas fa-exclamation-triangle fa-5x text-danger"></i></div>
                           <div class="position-relative z-1">
                               <h6 class="text-uppercase text-danger fw-bold x-small ls-1">Materias Perdidas</h6>
                               <h2 class="display-3 fw-black text-danger mb-0">{{ kpi.total_materias_perdidas|default:"0" }}</h2>
                               <small class="text-danger fw-bold opacity-75">Total Institucional</small>
                           </div>
                       </div>
                       <div class="card bg-info-subtle border-0 p-4 rounded-4 flex-grow-1 position-relative overflow-hidden">
                           <div class="position-absolute top-0 end-0 opacity-10 p-3"><i class="fas fa-chart-line fa-5x text-info"></i></div>
                           <div class="position-relative z-1">
                               <h6 class="text-uppercase text-info fw-bold x-small ls-1">Promedio Global</h6>
                               <h2 class="display-3 fw-black text-info mb-0">{{ kpi.prom_global_acad|default:"0.0" }}</h2>
                               <div class="progress mt-2 bg-white bg-opacity-50" style="height: 6px;">
                                   <div class="progress-bar bg-info" style="width: {% widthratio kpi.prom_global_acad 5 100 %}%"></div>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>

               <div class="col-lg-4">
                   <div class="card border-0 bg-white p-2 rounded-4 h-100 shadow-none d-flex flex-column align-items-center">
                       <h6 class="text-secondary fw-bold text-uppercase mb-3 mt-2" style="font-size: 0.8rem;">
                           <i class="fas fa-crosshairs me-2 text-primary"></i>Mapa de Calor por Áreas
                       </h6>
                       <div class="chart-container-responsive w-100">
                           <canvas id="radarChartPro"></canvas>
                       </div>
                   </div>
               </div>

               <div class="col-lg-5">
                   <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                        <h6 class="text-secondary fw-bold text-uppercase mb-0" style="font-size: 0.8rem;">Top Reprobación Crítica</h6>
                        <span class="badge bg-light text-muted border">Prioridad Alta</span>
                   </div>
                   
                   <div class="scroll-pro pe-2" style="max-height: 400px; overflow-y: auto;">
                       <div class="d-flex flex-column gap-3">
                           {% for riesgo in top_riesgo_academico %}
                           <div class="card border-0 shadow-sm rounded-4 transition-all hover-translate-x" style="border-left: 5px solid {% if riesgo.materias_perdidas > 3 %}#dc3545{% else %}#ffc107{% endif %};">
                               <div class="card-body p-3">
                                   <div class="d-flex align-items-center">
                                       <div class="me-3 position-relative">
                                           <div class="avatar-sm rounded-circle bg-dark text-white fw-bold d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                               {{ riesgo.estudiante.first_name|slice:":1" }}
                                           </div>
                                           <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-white" style="font-size: 0.6rem;">{{ forloop.counter }}</span>
                                       </div>
                                       <div class="flex-grow-1 lh-1">
                                           <h6 class="mb-1 fw-bold text-dark">{{ riesgo.estudiante.get_full_name }}</h6>
                                           <small class="text-muted">{{ riesgo.curso.nombre }}</small>
                                       </div>
                                       <div class="text-end">
                                           <div class="badge bg-danger-subtle text-danger fs-6 fw-black mb-1">{{ riesgo.materias_perdidas }}</div>
                                           <div class="d-block">
                                               <a href="{% url 'ver_observador' riesgo.estudiante.id %}" class="btn btn-xs btn-light rounded-circle"><i class="fas fa-arrow-right"></i></a>
                                           </div>
                                       </div>
                                   </div>
                                   {% if riesgo.materias_nombres %}
                                   <div class="mt-2 pt-2 border-top border-light d-flex flex-wrap gap-1">
                                        {% for materia_name in riesgo.materias_nombres|slice:":3" %}
                                        <span class="badge bg-light text-secondary border fw-normal" style="font-size: 0.65rem;">{{ materia_name }}</span>
                                        {% endfor %}
                                        {% if riesgo.materias_nombres|length > 3 %}
                                        <span class="badge bg-light text-secondary border fw-normal" style="font-size: 0.65rem;">+{{ riesgo.materias_nombres|length|add:"-3" }}</span>
                                        {% endif %}
                                   </div>
                                   {% endif %}
                               </div>
                           </div>
                           {% empty %}
                           <div class="text-center p-5">
                               <i class="fas fa-check-circle fa-3x text-success mb-3 opacity-50"></i>
                               <p class="fw-bold text-muted">Sin alertas activas</p>
                           </div>
                           {% endfor %}
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="row mb-5 animate__animated animate__fadeIn">
       <div class="col-12 mb-4">
           <h5 class="fw-bold text-dark border-start border-5 border-primary ps-3">Gestión Documental Institucional</h5>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card card-premium h-100 position-relative">
               <div class="card-body p-4 text-center">
                   <div class="icon-box-xl bg-purple-soft mx-auto mb-3 rounded-circle">
                       <i class="fas fa-university fa-2x"></i>
                   </div>
                   <h5 class="fw-bold mb-1">Proyecto Educativo (PEI)</h5>
                   <p class="text-muted small mb-4">Carta de navegación pedagógica.</p>
                   
                   {% if institucion.archivo_pei %}
                       <a href="{{ institucion.archivo_pei.url }}" target="_blank" class="btn btn-outline-purple rounded-pill w-100 fw-bold">Ver Documento</a>
                   {% else %}
                       <button class="btn btn-light rounded-pill w-100 text-muted" disabled>No cargado</button>
                   {% endif %}

                   {% if user.perfil.rol in 'ADMINISTRADOR,COORD_ACADEMICO' %}
                   <button class="btn btn-link btn-sm text-muted mt-2 text-decoration-none" data-bs-toggle="collapse" data-bs-target="#uploadPEI">
                       <i class="fas fa-cloud-upload-alt"></i> Actualizar
                   </button>
                   <div class="collapse mt-2" id="uploadPEI">
                       <form method="POST" enctype="multipart/form-data" class="p-2 bg-light rounded-3 border">{% csrf_token %}
                           <input type="file" name="pei_file" class="form-control form-control-sm mb-2" accept=".pdf" required>
                           <button type="submit" class="btn btn-purple btn-xs w-100 rounded-pill">Subir</button>
                       </form>
                   </div>
                   {% endif %}
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card card-premium h-100">
               <div class="card-body p-4 text-center">
                   <div class="icon-box-xl bg-orange-soft mx-auto mb-3 rounded-circle">
                       <i class="fas fa-gavel fa-2x"></i>
                   </div>
                   <h5 class="fw-bold mb-1">Manual de Convivencia</h5>
                   <p class="text-muted small mb-4">Normativa y acuerdos escolares.</p>

                   {% if institucion.archivo_manual_convivencia %}
                       <a href="{{ institucion.archivo_manual_convivencia.url }}" target="_blank" class="btn btn-outline-orange rounded-pill w-100 fw-bold">Ver Documento</a>
                   {% else %}
                       <button class="btn btn-light rounded-pill w-100 text-muted" disabled>No cargado</button>
                   {% endif %}

                   {% if user.perfil.rol in 'ADMINISTRADOR,COORD_CONVIVENCIA' %}
                   <button class="btn btn-link btn-sm text-muted mt-2 text-decoration-none" data-bs-toggle="collapse" data-bs-target="#uploadManual">
                       <i class="fas fa-cloud-upload-alt"></i> Actualizar
                   </button>
                   <div class="collapse mt-2" id="uploadManual">
                       <form method="POST" enctype="multipart/form-data" class="p-2 bg-light rounded-3 border">{% csrf_token %}
                           <input type="file" name="manual_file" class="form-control form-control-sm mb-2" accept=".pdf" required>
                           <button type="submit" class="btn btn-warning text-white btn-xs w-100 rounded-pill">Subir</button>
                       </form>
                   </div>
                   {% endif %}
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card card-premium h-100">
               <div class="card-body p-4 text-center">
                   <div class="icon-box-xl bg-teal-soft mx-auto mb-3 rounded-circle">
                       <i class="fas fa-scroll fa-2x"></i>
                   </div>
                   <h5 class="fw-bold mb-1">Malla Curricular</h5>
                   <p class="text-muted small mb-4">Plan de estudios y competencias.</p>
                   {% if institucion.archivo_malla_curricular %}
                       <a href="{{ institucion.archivo_malla_curricular.url }}" target="_blank" class="btn btn-outline-teal rounded-pill w-100 fw-bold">Ver Documento</a>
                   {% else %}
                       <button class="btn btn-light rounded-pill w-100 text-muted" disabled>No disponible</button>
                   {% endif %}
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card card-premium h-100">
               <div class="card-body p-4 text-center">
                   <div class="icon-box-xl bg-danger-soft mx-auto mb-3 rounded-circle">
                       <i class="fas fa-calendar-alt fa-2x"></i>
                   </div>
                   <h5 class="fw-bold mb-1">Cronograma 2025</h5>
                   <p class="text-muted small mb-4">Agenda y fechas institucionales.</p>
                   {% if institucion.archivo_calendario %}
                       <a href="{{ institucion.archivo_calendario.url }}" target="_blank" class="btn btn-outline-danger rounded-pill w-100 fw-bold">Ver Documento</a>
                   {% else %}
                       <button class="btn btn-light rounded-pill w-100 text-muted" disabled>No disponible</button>
                   {% endif %}
               </div>
           </div>
       </div>
   </div>

   <div class="row g-4 mb-5 animate__animated animate__fadeIn">
       <div class="col-lg-3 col-md-6">
           <div class="card card-premium h-100 bg-white">
               <div class="card-body p-4 d-flex align-items-center justify-content-between">
                   <div>
                       <p class="text-uppercase text-muted x-small fw-bold mb-1">Población Activa</p>
                       <h2 class="fw-black text-dark mb-0">{{ kpi.total_alumnos }}</h2>
                   </div>
                   <div class="icon-box-md bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center">
                       <i class="fas fa-users fa-lg"></i>
                   </div>
               </div>
           </div>
       </div>
       <div class="col-lg-3 col-md-6">
           <div class="card card-premium h-100 bg-white">
               <div class="card-body p-4 d-flex align-items-center justify-content-between">
                   <div>
                       <p class="text-uppercase text-muted x-small fw-bold mb-1">Rendimiento GPA</p>
                       <h2 class="fw-black text-info mb-0">{{ kpi.prom_global_acad }}</h2>
                   </div>
                   <div class="icon-box-md bg-info-subtle text-info rounded-circle d-flex align-items-center justify-content-center">
                       <i class="fas fa-graduation-cap fa-lg"></i>
                   </div>
               </div>
           </div>
       </div>
       <div class="col-lg-3 col-md-6">
           <div class="card card-premium h-100 bg-white">
               <div class="card-body p-4 d-flex align-items-center justify-content-between">
                   <div>
                       <p class="text-uppercase text-muted x-small fw-bold mb-1">Clima Escolar</p>
                       <h2 class="fw-black text-warning mb-0">{{ kpi.prom_global_conv }}</h2>
                   </div>
                   <div class="icon-box-md bg-warning-subtle text-warning rounded-circle d-flex align-items-center justify-content-center">
                       <i class="fas fa-smile fa-lg"></i>
                   </div>
               </div>
           </div>
       </div>
       <div class="col-lg-3 col-md-6">
           <div class="card card-premium h-100 bg-white">
               <div class="card-body p-4 d-flex align-items-center justify-content-between">
                   <div>
                       <p class="text-uppercase text-muted x-small fw-bold mb-1">Cursos Activos</p>
                       <h2 class="fw-black text-success mb-0">{{ kpi.total_cursos }}</h2>
                   </div>
                   <div class="icon-box-md bg-success-subtle text-success rounded-circle d-flex align-items-center justify-content-center">
                       <i class="fas fa-chalkboard fa-lg"></i>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="row mb-5 animate__animated animate__fadeInUp">
       <div class="col-lg-8 mb-4 mb-lg-0">
           <div class="card card-premium h-100">
               <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                   <h5 class="fw-bold text-dark mb-0"><i class="fas fa-chart-bar me-2 text-primary"></i>Comparativa Grupal</h5>
                   <div class="btn-group btn-group-sm">
                       <button class="btn btn-outline-light text-dark border fw-bold active">General</button>
                       <button class="btn btn-outline-light text-dark border fw-bold">Detalle</button>
                   </div>
               </div>
                <div class="card-body p-4">
                   <div style="height: 380px; width: 100%;">
                       <canvas id="peiChartSupremo"></canvas>
                   </div>
               </div>
           </div>
       </div>
       
       <div class="col-lg-4">
            <div class="card card-premium h-100 overflow-hidden">
               <div class="card-header border-0 pt-5 pb-4 px-4 text-center text-white position-relative" 
                    style="background: linear-gradient(135deg, #157347 0%, #0d9668 100%) !important;">
                   <div class="position-absolute top-0 start-0 w-100 h-100 opacity-10" 
                        style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4yKSIvPjwvc3ZnPg==');"></div>
                   
                   <h4 class="fw-black text-white mb-1 position-relative z-1" style="color: #ffffff !important;">
                       <i class="fas fa-clock me-2"></i>Monitor de Asistencia
                   </h4>
                   <p class="mb-0 small position-relative z-1" style="color: rgba(255,255,255,0.95) !important;">
                       Reporte Diario en Tiempo Real
                   </p>
               </div>
               
               <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center bg-white">
                   <div style="height: 250px; width: 100%; position: relative;">
                       <canvas id="asistenciaChartSupremo"></canvas>
                       <div class="chart-center-label">
                           <h3 class="mb-0 fw-black text-success">92%</h3>
                           <small class="text-muted fw-bold text-uppercase" style="font-size: 0.65rem;">Efectividad</small>
                       </div>
                   </div>
                   <div class="row w-100 mt-4 text-center">
                       <div class="col-4 border-end">
                           <span class="d-block fw-bold text-dark">--</span>
                           <small class="text-muted x-small">Fallas</small>
                       </div>
                       <div class="col-4 border-end">
                           <span class="d-block fw-bold text-dark">--</span>
                           <small class="text-muted x-small">Tardes</small>
                       </div>
                       <div class="col-4">
                           <span class="d-block fw-bold text-success">OK</span>
                           <small class="text-muted x-small">Estado</small>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="row mb-5 animate__animated animate__fadeInUp">
       <div class="col-lg-6 mb-4 mb-lg-0">
           <div class="card card-premium h-100">
               <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                   <h5 class="fw-bold text-danger mb-0"><i class="fas fa-user-clock me-2"></i>Alertas de Asistencia</h5>
                   <a href="{% url 'historial_asistencia' %}" class="btn btn-xs btn-light text-danger fw-bold rounded-pill border">Ver Todo</a>
               </div>
               <div class="card-body p-0">
                   <div class="table-responsive">
                       <table class="table table-hover align-middle mb-0">
                           <thead class="bg-light text-muted x-small text-uppercase fw-bold">
                               <tr>
                                   <th class="ps-4">Estudiante</th>
                                   <th class="text-center">Fallas</th>
                                   <th class="text-end pe-4">Acción</th>
                               </tr>
                           </thead>
                           <tbody>
                               {% for alerta in top_fallas %}
                               <tr>
                                   <td class="ps-4 py-3">
                                       <div class="d-flex align-items-center">
                                            <div class="avatar-xs rounded-circle bg-danger-subtle text-danger fw-bold d-flex align-items-center justify-content-center me-3">
                                                {{ alerta.estudiante__first_name|slice:":1" }}
                                            </div>
                                            <div class="lh-1">
                                                <span class="fw-bold text-dark d-block mb-1">{{ alerta.estudiante__first_name }} {{ alerta.estudiante__last_name }}</span>
                                                <small class="text-muted x-small">{{ alerta.curso__nombre }}</small>
                                            </div>
                                       </div>
                                   </td>
                                   <td class="text-center">
                                       <span class="badge bg-danger rounded-pill">{{ alerta.total }}</span>
                                   </td>
                                   <td class="text-end pe-4">
                                       <a href="{% url 'ver_observador' alerta.estudiante__id %}" class="btn btn-sm btn-icon btn-light text-primary"><i class="fas fa-eye"></i></a>
                                   </td>
                               </tr>
                               {% empty %}
                               <tr><td colspan="3" class="text-center py-5 text-muted small">Sin alertas de asistencia.</td></tr>
                               {% endfor %}
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </div>

       <div class="col-lg-6">
           <div class="card card-premium h-100">
               <div class="card-header bg-white border-0 pt-4 px-4">
                   <h5 class="fw-bold text-dark mb-0"><i class="fas fa-exclamation-circle me-2 text-warning"></i>Riesgo Convivencial</h5>
                   <p class="text-muted x-small mb-0">Nota inferior a 3.5 en componente comportamental.</p>
               </div>
               <div class="card-body p-0">
                   <div class="table-responsive">
                       <table class="table table-hover align-middle mb-0">
                           <thead class="bg-light text-muted x-small text-uppercase fw-bold">
                               <tr>
                                   <th class="ps-4">Estudiante</th>
                                   <th class="text-center">Nota</th>
                                   <th class="text-end pe-4">Gestión</th>
                               </tr>
                           </thead>
                           <tbody>
                               {% for alerta in alertas_convivencia %}
                               <tr>
                                   <td class="ps-4 py-3">
                                       <div class="d-flex align-items-center">
                                            <div class="avatar-xs rounded-circle bg-warning-subtle text-warning fw-bold d-flex align-items-center justify-content-center me-3">
                                                {{ alerta.estudiante__first_name|slice:":1" }}
                                            </div>
                                            <div class="lh-1">
                                                <span class="fw-bold text-dark d-block mb-1">{{ alerta.estudiante__first_name }} {{ alerta.estudiante__last_name }}</span>
                                                <small class="text-muted x-small">{{ alerta.materia__curso__nombre }}</small>
                                            </div>
                                       </div>
                                   </td>
                                   <td class="text-center">
                                       <span class="badge bg-warning text-dark border border-warning-subtle rounded-pill px-3">
                                            {{ alerta.promedio|default:alerta.nota_convivencia|floatformat:1 }}
                                       </span>
                                   </td>
                                   <td class="text-end pe-4">
                                       <a href="{% url 'ver_observador' alerta.estudiante__id %}" class="btn btn-sm btn-icon btn-light text-dark"><i class="fas fa-pen"></i></a>
                                   </td>
                               </tr>
                               {% empty %}
                               <tr><td colspan="3" class="text-center py-5 text-muted small">Excelente clima escolar reportado.</td></tr>
                               {% endfor %}
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="card card-premium mb-5">
       <div class="card-body p-5 text-center bg-gradient-light-subtle">
           <form method="GET" action="">
               <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden border w-75 mx-auto">
                   <span class="input-group-text bg-white border-0 ps-4"><i class="fas fa-search text-muted"></i></span>
                   <input type="text" name="q" class="form-control bg-white border-0 shadow-none"
                          placeholder="Nombre, ID o Matrícula..." value="{{ query|default:'' }}">
                    <button class="btn btn-primary px-5 fw-bold" type="submit">Buscar</button>
               </div>
           </form>
       </div>
   </div>

   {% if query %}
       <div class="mb-5 animate__animated animate__fadeIn px-2">
           <h5 class="fw-bold text-secondary mb-4 px-3"><i class="fas fa-list me-2"></i>Resultados para: "{{ query }}"</h5>
            {% if estudiantes %}
               <div class="row g-4">
                   {% for estudiante in estudiantes %}
                   <div class="col-md-6 col-lg-4 col-xl-3">
                       <div class="card card-premium h-100">
                           <div class="card-body d-flex align-items-center p-3">
                               <div class="avatar-md me-3 bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center fw-bold">
                                   {{ estudiante.first_name|slice:":1" }}{{ estudiante.last_name|slice:":1" }}
                               </div>
                               <div class="flex-grow-1 overflow-hidden">
                                   <h6 class="fw-bold mb-0 text-truncate">{{ estudiante.get_full_name }}</h6>
                                    <small class="text-muted">{{ estudiante.username }}</small>
                               </div>
                               <a href="{% url 'ver_observador' estudiante.id %}" class="btn btn-sm btn-light rounded-circle"><i class="fas fa-chevron-right"></i></a>
                           </div>
                       </div>
                   </div>
                   {% endfor %}
                </div>
           {% else %}
               <div class="alert alert-light border shadow-sm text-center rounded-pill">No se encontraron estudiantes.</div>
           {% endif %}
       </div>
   {% endif %}
</div>

<div class="modal fade" id="modalIA" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 rounded-5 shadow-2xl overflow-hidden">
            <div class="modal-header border-0 p-4 bg-gradient-ai text-white position-relative">
                <div class="position-relative z-1 d-flex align-items-center w-100">
                    <div class="icon-box-md bg-white-20 rounded-4 me-3 animate__animated animate__pulse animate__infinite">
                        <i class="fas fa-robot fa-lg"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-black fs-4">Consultoría Stratos AI</h5>
                        <p class="mb-0 small opacity-75">Análisis heurístico institucional en tiempo real.</p>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto shadow-none" data-bs-dismiss="modal"></button>
                </div>
                <div class="position-absolute top-0 end-0 h-100 w-100 opacity-10">
                    <i class="fas fa-network-wired fa-12x position-absolute" style="top:-30px; right:-30px;"></i>
                </div>
            </div>
            <div class="modal-body p-5 bg-light-subtle" style="min-height: 600px;">
                <div id="aiLoading" class="text-center py-5">
                    <div class="spinner-grow text-primary mb-4" style="width: 4rem; height: 4rem;"></div>
                    <h5 class="fw-bold text-dark animate__animated animate__fadeIn">Escaneando Ecosistema Digital...</h5>
                    <p class="text-muted" id="aiStatusText">Conectando con motor de Inteligencia Artificial...</p>
                </div>
                <div id="aiResults" class="d-none animate__animated animate__fadeIn">
                    <div class="row">
                        <div class="col-lg-12">
                            <div id="aiTextContent" class="markdown-body bg-white p-5 rounded-5 border shadow-xl transition-all" style="max-height: 550px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="mt-4 d-flex justify-content-between align-items-center">
                        <span class="x-small text-muted fw-bold"><i class="fas fa-shield-alt me-1"></i> Análisis basado en PEI y Manual de Convivencia vigente.</span>
                        <div>
                            <button class="btn btn-outline-dark rounded-pill px-4 me-2 fw-bold" data-bs-dismiss="modal">Cerrar</button>
                            <button class="btn btn-primary rounded-pill px-5 shadow-lg fw-black" onclick="window.print()">
                                <i class="fas fa-file-pdf me-2"></i> Exportar Diagnóstico PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
   document.addEventListener('DOMContentLoaded', function() {
       
       // 1. CONFIGURACIÓN DEL RADAR CHART ESTRATÉGICO CON DATOS REALES
       const ctxRadar = document.getElementById('radarChartPro');
       if (ctxRadar) {
           new Chart(ctxRadar, {
               type: 'radar',
               data: {
                   labels: JSON.parse('{{ chart_data.labels|safe|escapejs }}'),
                   datasets: [{
                       label: 'Rendimiento Promedio Institucional',
                       data: JSON.parse('{{ chart_data.acad|safe|escapejs }}'),
                       backgroundColor: 'rgba(67, 97, 238, 0.25)',
                       borderColor: '#4361ee',
                       borderWidth: 3,
                       pointBackgroundColor: '#4361ee',
                       pointBorderColor: '#fff',
                       pointHoverRadius: 8,
                       fill: true
                   }, {
                       label: 'Meta Institucional (4.0)',
                       data: Array(JSON.parse('{{ chart_data.labels|safe|escapejs }}').length).fill(4.0),
                       backgroundColor: 'rgba(25, 135, 84, 0.05)',
                       borderColor: 'rgba(25, 135, 84, 0.4)',
                       borderWidth: 2,
                       borderDash: [5, 5],
                       pointRadius: 0
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   scales: {
                       r: { 
                           beginAtZero: true, 
                           max: 5, 
                           ticks: { stepSize: 1, display: false },
                           grid: { color: 'rgba(0,0,0,0.05)' },
                           angleLines: { color: 'rgba(0,0,0,0.05)' },
                           pointLabels: {
                               font: { size: 11, weight: 'bold', family: 'Inter' },
                               color: '#64748b'
                           }
                       }
                   },
                   plugins: { 
                       legend: { 
                           position: 'bottom', 
                           labels: { usePointStyle: true, font: { weight: 'bold', size: 11 }, padding: 20 } 
                       },
                       tooltip: {
                           backgroundColor: 'rgba(15, 23, 42, 0.9)',
                           padding: 12,
                           titleFont: { size: 13 },
                           bodyFont: { size: 13 },
                           cornerRadius: 8,
                           callbacks: {
                               label: function(context) {
                                   return context.dataset.label + ': ' + Number(context.raw).toFixed(2);
                               }
                           }
                       }
                   }
               }
           });
       }

       // 2. CONFIGURACIÓN GRÁFICO BARRA SUPREMO (PEI VS REAL)
       const ctxBar = document.getElementById('peiChartSupremo');
       if (ctxBar) {
           const labels = JSON.parse('{{ chart_data.labels|safe|escapejs }}');
           const dataAcad = JSON.parse('{{ chart_data.acad|safe|escapejs }}');
           const dataConv = JSON.parse('{{ chart_data.conv|safe|escapejs }}');

           new Chart(ctxBar, {
               type: 'bar',
               data: {
                   labels: labels,
                   datasets: [
                       {
                           label: 'Promedio Académico',
                           data: dataAcad,
                           backgroundColor: '#4361ee', 
                           borderRadius: 6,
                           barThickness: 18,
                           hoverBackgroundColor: '#3a0ca3'
                       },
                       {
                           label: 'Índice Convivencial',
                           data: dataConv,
                           backgroundColor: '#facc15', 
                           borderRadius: 6,
                           barThickness: 18,
                           hoverBackgroundColor: '#eab308'
                       }
                   ]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   plugins: { 
                       legend: { position: 'top', align: 'end', labels: { usePointStyle: true, font: { weight: 'bold', family: 'Inter' } } },
                       tooltip: { padding: 15, backgroundColor: 'rgba(15, 23, 42, 0.9)', titleFont: { size: 13, weight: 'bold' }, cornerRadius: 8 }
                   },
                   scales: {
                       y: { beginAtZero: true, max: 5, grid: { color: 'rgba(0,0,0,0.03)', drawBorder: false }, ticks: { font: { family: 'Inter' } } },
                       x: { grid: { display: false }, ticks: { font: { family: 'Inter', size: 11 } } }
                   }
               }
           });
       }

       // 3. CONFIGURACIÓN GRÁFICO ASISTENCIA (DONUT)
       const ctxDonut = document.getElementById('asistenciaChartSupremo');
       if (ctxDonut) {
           const dataAsistencia = JSON.parse('{{ stats_asistencia|safe|escapejs }}');
           new Chart(ctxDonut, {
               type: 'doughnut',
               data: {
                   labels: ['Presentes', 'Fallas', 'Excusas', 'Tardanzas'],
                   datasets: [{
                       data: dataAsistencia,
                       backgroundColor: ['#10b981', '#ef4444', '#3b82f6', '#f59e0b'],
                       borderWidth: 0,
                       hoverOffset: 15
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   cutout: '85%',
                   plugins: {
                       legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, font: { weight: 'bold', size: 11, family: 'Inter' } } }
                   }
               }
           });
       }
   });

   // MOTOR DE AUDITORÍA IA STRATOS - VERSIÓN FINAL
   async function iniciarAnalisisIA() {
       const modal = new bootstrap.Modal(document.getElementById('modalIA'));
       const loading = document.getElementById('aiLoading');
       const results = document.getElementById('aiResults');
       const statusText = document.getElementById('aiStatusText');
       const contentDiv = document.getElementById('aiTextContent');

       modal.show();
       loading.classList.remove('d-none');
       results.classList.add('d-none');

       // 1. RECOLECCIÓN DE DATOS
       const datosContexto = {
           tipo_reporte: "AUDITORIA_GLOBAL_INSTITUCIONAL",
           entidad_analizada: "COLEGIO COMPLETO (TODOS LOS ESTUDIANTES)",
           indicadores_globales: {
               total_alumnos: "{{ kpi.total_alumnos }}",
               promedio_academico_global: "{{ kpi.prom_global_acad }}",
               indice_convivencia_global: "{{ kpi.prom_global_conv }}",
               materias_reprobadas_totales: "{{ kpi.total_materias_perdidas }}",
               total_cursos_activos: "{{ kpi.total_cursos }}"
           },
           riesgos_criticos_detectados: [
               {% for riesgo in top_riesgo_academico %}
               {
                   nombre_estudiante: "{{ riesgo.estudiante.get_full_name|escapejs }}",
                   curso: "{{ riesgo.curso.nombre|escapejs }}",
                   materias_perdidas_cantidad: {{ riesgo.materias_perdidas }},
                   lista_materias: [{% for mat in riesgo.materias_nombres %}"{{ mat|escapejs }}",{% endfor %}]
               },
               {% endfor %}
           ],
           alertas_convivencia: [
               {% for alerta in alertas_convivencia %}
               {
                   nombre_estudiante: "{{ alerta.estudiante__first_name|escapejs }} {{ alerta.estudiante__last_name|escapejs }}",
                   curso: "{{ alerta.materia__curso__nombre|escapejs }}",
                   nota_conducta: "{{ alerta.nota_promedio|floatformat:2 }}"
               },
               {% endfor %}
           ],
           alertas_asistencia: [
               {% for alerta in top_fallas %}
               {
                   nombre_estudiante: "{{ alerta.estudiante__first_name|escapejs }} {{ alerta.estudiante__last_name|escapejs }}",
                   fallas_acumuladas: {{ alerta.total }},
                   curso: "{{ alerta.curso__nombre|escapejs }}"
               },
               {% endfor %}
           ],
           rendimiento_cursos: [
               {% for item in vista_cursos %}
               {
                   nombre_curso: "{{ item.curso.nombre|escapejs }}",
                   promedio_grupo: "{{ item.stats.acad }}",
                   indice_clima: "{{ item.stats.conv }}",
                   cantidad_alumnos: "{{ item.stats.alumnos }}"
               },
               {% endfor %}
           ]
       };

       // 2. UX
       const steps = [
           "Leyendo Archivo Maestro PEI...",
           "Analizando Manual de Convivencia...",
           "Procesando " + datosContexto.riesgos_criticos_detectados.length + " alertas de riesgo académico...",
           "Cruzando datos de convivencia con normativa...",
           "Generando informe rectoral..."
       ];

       let stepIndex = 0;
       const stepInterval = setInterval(() => {
           if (stepIndex < steps.length) {
               statusText.innerText = steps[stepIndex];
               stepIndex++;
           }
       }, 1200);

       try {
           const response = await fetch("{% url 'ai_engine' %}?action=analisis_global_bienestar", {
               method: "POST",
               headers: {
                   "Content-Type": "application/json",
                   "X-CSRFToken": "{{ csrf_token }}",
                   "X-Requested-With": "XMLHttpRequest"
               },
               body: JSON.stringify({
                   contexto_datos: datosContexto,
                   instruccion: "Genera un reporte de auditoría basado estrictamente en los arrays de datos suministrados (riesgos_criticos, alertas). Identifica los estudiantes con problemas y propón soluciones."
               })
           });

           const rawText = await response.text();
           clearInterval(stepInterval);

           let data;
           try {
                data = JSON.parse(rawText);
           } catch (e) {
                console.error("Respuesta no JSON:", rawText);
                throw new Error("El servidor devolvió un error HTML. Revisa consola.");
           }

           if (data.success) {
               contentDiv.innerHTML = marked.parse(data.content);
               loading.classList.add('d-none');
               results.classList.remove('d-none');
           } else {
               contentDiv.innerHTML = `<div class="alert alert-danger">Error IA: ${data.message}</div>`;
               loading.classList.add('d-none');
               results.classList.remove('d-none');
           }

       } catch (error) {
           clearInterval(stepInterval);
           contentDiv.innerHTML = `<div class="alert alert-warning">Error de conexión: ${error.message}</div>`;
           loading.classList.add('d-none');
           results.classList.remove('d-none');
       }
   }
</script>
{% endblock %}