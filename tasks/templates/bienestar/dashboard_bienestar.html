{% extends 'base.html' %}
{% load dict_filters %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid py-5 bg-light-subtle" style="max-width: 1800px;">
  
   <div class="row mb-5 align-items-center animate__animated animate__fadeInDown">
       <div class="col-lg-5 mb-3 mb-lg-0">
           <div class="d-flex align-items-center justify-content-center justify-content-lg-start">
               <div class="icon-box-xl bg-gradient-primary text-white rounded-circle shadow-lg me-4 d-flex align-items-center justify-content-center">
                   <i class="fas fa-chart-pie fa-3x"></i>
               </div>
               <div class="text-center text-lg-start">
                   <h6 class="text-uppercase text-secondary fw-bold ls-2 mb-1">Panel de Control</h6>
                   <h1 class="fw-bolder text-dark mb-0 display-5">Gesti√≥n & Bienestar</h1>
                   <p class="text-muted lead mb-0">
                       <span class="badge bg-soft-primary text-primary me-2">{{ user.perfil.get_rol_display }}</span>
                       Centro de Operaciones Institucional
                   </p>
               </div>
           </div>
       </div>
       
       <div class="col-lg-7">
           <div class="d-flex flex-wrap justify-content-center justify-content-lg-end gap-3 align-items-center">
                <a href="{% url 'reporte_consolidado' %}" class="btn btn-white border shadow-sm text-success fw-bold hover-scale px-4 py-2" title="Descargar S√°bana Excel">
                    <i class="fas fa-file-excel me-2"></i>S√°bana
                </a>

                <a href="{% url 'historial_global_observaciones' %}" class="btn btn-white border shadow-sm text-primary fw-bold hover-scale px-4 py-2" title="Ver Historial de Procesos">
                    <i class="fas fa-history me-2"></i>Historial
                </a>

                <a href="{% url 'ai_engine' %}?action=cumplimiento_pei" class="btn btn-white border shadow-sm text-purple fw-bold hover-scale px-4 py-2" title="Analizar PEI con IA">
                    <i class="fas fa-robot me-2"></i>Auditor√≠a IA
                </a>
                
                <a href="{% url 'dashboard_academico' %}" class="btn btn-warning shadow-lg text-dark fw-bold hover-scale px-4 py-2">
                    <i class="fas fa-brain me-2"></i>IA Acad√©mica
                </a>

                <a href="{% url 'dashboard_bienestar' %}" class="btn btn-primary shadow-lg hover-scale px-3 py-2" title="Recargar Datos">
                    <i class="fas fa-sync-alt"></i>
                </a>
           </div>
           
           <div class="text-center text-lg-end mt-3">
               <small class="text-muted fw-bold ls-1 text-uppercase">√öltima Actualizaci√≥n: <span class="text-dark">{% now "d M, Y - H:i" %}</span></small>
           </div>
       </div>
   </div>

   <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-5 animate__animated animate__fadeInUp">
       <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
           <div>
               <h4 class="fw-bold text-dark mb-1"><i class="fas fa-satellite-dish me-2 text-danger"></i>Radar Acad√©mico</h4>
               <p class="text-muted small mb-0">Visi√≥n panor√°mica del rendimiento escolar actual.</p>
           </div>
           <span class="badge bg-danger-subtle text-danger border border-danger-subtle px-3 py-2 rounded-pill fw-bold">
               <i class="fas fa-bell me-2"></i>Alertas Activas
           </span>
       </div>
       <div class="card-body p-4">
           <div class="row g-4">
               <div class="col-lg-3">
                   <div class="d-flex flex-column gap-3 h-100">
                       <div class="card bg-light border-0 p-3 shadow-sm h-100 d-flex justify-content-center align-items-center text-center">
                           <div>
                               <h6 class="text-uppercase text-muted fw-bold x-small mb-2">Materias Perdidas (Total)</h6>
                               <h2 class="display-4 fw-bold text-danger mb-0">{{ kpi.total_materias_perdidas|default:"0" }}</h2>
                               <small class="text-danger"><i class="fas fa-arrow-down me-1"></i>Cr√≠tico</small>
                           </div>
                       </div>
                       <div class="card bg-light border-0 p-3 shadow-sm h-100 d-flex justify-content-center align-items-center text-center">
                           <div>
                               <h6 class="text-uppercase text-muted fw-bold x-small mb-2">Promedio General</h6>
                               <h2 class="display-4 fw-bold text-info mb-0">{{ kpi.prom_global_acad|default:"0.0" }}</h2>
                               <div class="progress mt-2" style="height: 6px; width: 100px;">
                                   <div class="progress-bar bg-info" role="progressbar" style="width: {% widthratio kpi.prom_global_acad 5 100 %}%"></div>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>

               <div class="col-lg-5">
                   <div class="position-relative h-100 d-flex flex-column justify-content-center">
                       <h6 class="text-center text-secondary x-small fw-bold text-uppercase mb-3">Rendimiento por √Åreas del Conocimiento</h6>
                       <div style="height: 300px; width: 100%;">
                           <canvas id="radarChart"></canvas>
                       </div>
                   </div>
               </div>

               <div class="col-lg-4">
                   <h6 class="text-secondary x-small fw-bold text-uppercase mb-3">Estudiantes con Mayor Riesgo Acad√©mico</h6>
                   <div class="list-group shadow-sm rounded-3">
                       {% for riesgo in top_riesgo_academico|slice:":5" %}
                       <a href="{% url 'ver_observador' riesgo.estudiante.id %}" class="list-group-item list-group-item-action d-flex align-items-center p-3 border-0 border-bottom">
                           <div class="avatar-sm rounded-circle bg-danger-subtle text-danger d-flex align-items-center justify-content-center me-3 fw-bold">
                               {{ riesgo.estudiante.first_name|slice:":1" }}
                           </div>
                           <div class="flex-grow-1">
                               <h6 class="mb-0 fw-bold text-dark">{{ riesgo.estudiante.get_full_name }}</h6>
                               <small class="text-muted">{{ riesgo.curso.nombre }}</small>
                           </div>
                           <div class="text-end">
                               <span class="badge bg-danger rounded-pill">{{ riesgo.materias_perdidas }} Materias</span>
                           </div>
                       </a>
                       {% empty %}
                       <div class="text-center p-4 text-muted">
                           <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                           <p class="mb-0">Sin alertas cr√≠ticas por el momento.</p>
                       </div>
                       {% endfor %}
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="row mb-5 animate__animated animate__fadeIn">
       <div class="col-12 mb-4 d-flex align-items-center border-bottom pb-2">
           <h4 class="fw-bold text-dark mb-0"><i class="fas fa-folder-open me-2 text-secondary"></i>Documentaci√≥n Oficial</h4>
           <span class="badge bg-light text-muted ms-3 border">Archivos Rectores</span>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card h-100 border-0 shadow-sm hover-elevate card-doc pei-border">
               <div class="card-body">
                   <div class="d-flex justify-content-between align-items-center mb-3">
                       <h5 class="fw-bold mb-0 text-purple"><i class="fas fa-book-reader me-2"></i>PEI</h5>
                       {% if institucion.archivo_pei %}<span class="badge bg-success-subtle text-success">Activo</span>{% else %}<span class="badge bg-light text-muted">Vac√≠o</span>{% endif %}
                   </div>
                   <p class="text-muted small">Proyecto Educativo Institucional.</p>
                   
                   <div class="d-grid gap-2">
                       {% if institucion.archivo_pei %}
                           <a href="{{ institucion.archivo_pei.url }}" target="_blank" class="btn btn-sm btn-outline-purple"><i class="fas fa-eye me-1"></i> Ver PDF</a>
                       {% endif %}
                       
                       {% if user.perfil.rol in 'ADMINISTRADOR,COORD_ACADEMICO' %}
                           <button class="btn btn-sm btn-light text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#uploadPEI">
                               <i class="fas fa-upload me-1"></i> Actualizar
                           </button>
                           <div class="collapse mt-2" id="uploadPEI">
                               <form method="POST" enctype="multipart/form-data" class="p-2 bg-light rounded border">{% csrf_token %}
                                   <input type="file" name="pei_file" class="form-control form-control-sm mb-2" accept=".pdf" required>
                                   <button type="submit" class="btn btn-success btn-sm w-100">Guardar</button>
                               </form>
                           </div>
                       {% endif %}
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card h-100 border-0 shadow-sm hover-elevate card-doc manual-border">
               <div class="card-body">
                   <div class="d-flex justify-content-between align-items-center mb-3">
                       <h5 class="fw-bold mb-0 text-orange"><i class="fas fa-hands-helping me-2"></i>Manual</h5>
                       {% if institucion.archivo_manual_convivencia %}<span class="badge bg-success-subtle text-success">Activo</span>{% else %}<span class="badge bg-light text-muted">Vac√≠o</span>{% endif %}
                   </div>
                   <p class="text-muted small">Normas de convivencia escolar.</p>
                   
                   <div class="d-grid gap-2">
                       {% if institucion.archivo_manual_convivencia %}
                           <a href="{{ institucion.archivo_manual_convivencia.url }}" target="_blank" class="btn btn-sm btn-outline-orange"><i class="fas fa-eye me-1"></i> Ver PDF</a>
                       {% endif %}
                       
                       {% if user.perfil.rol in 'ADMINISTRADOR,COORD_CONVIVENCIA' %}
                           <button class="btn btn-sm btn-light text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#uploadManual">
                               <i class="fas fa-upload me-1"></i> Actualizar
                           </button>
                           <div class="collapse mt-2" id="uploadManual">
                               <form method="POST" enctype="multipart/form-data" class="p-2 bg-light rounded border">{% csrf_token %}
                                   <input type="file" name="manual_file" class="form-control form-control-sm mb-2" accept=".pdf" required>
                                   <button type="submit" class="btn btn-success btn-sm w-100">Guardar</button>
                               </form>
                           </div>
                       {% endif %}
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card h-100 border-0 shadow-sm hover-elevate card-doc proyectos-border">
               <div class="card-body">
                   <div class="d-flex justify-content-between align-items-center mb-3">
                       <h5 class="fw-bold mb-0 text-teal"><i class="fas fa-project-diagram me-2"></i>Proyectos</h5>
                       {% if institucion.archivo_proyectos %}<span class="badge bg-success-subtle text-success">Activo</span>{% else %}<span class="badge bg-light text-muted">Vac√≠o</span>{% endif %}
                   </div>
                   <p class="text-muted small">Transversales y planes de aula.</p>
                   
                   <div class="d-grid gap-2">
                       {% if institucion.archivo_proyectos %}
                           <a href="{{ institucion.archivo_proyectos.url }}" target="_blank" class="btn btn-sm btn-outline-teal"><i class="fas fa-eye me-1"></i> Ver PDF</a>
                       {% endif %}
                       
                       {% if user.perfil.rol in 'ADMINISTRADOR,COORD_ACADEMICO' %}
                           <button class="btn btn-sm btn-light text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#uploadProyectos">
                               <i class="fas fa-upload me-1"></i> Actualizar
                           </button>
                           <div class="collapse mt-2" id="uploadProyectos">
                               <form method="POST" enctype="multipart/form-data" class="p-2 bg-light rounded border">{% csrf_token %}
                                   <input type="file" name="proyectos_file" class="form-control form-control-sm mb-2" accept=".pdf" required>
                                   <button type="submit" class="btn btn-success btn-sm w-100">Guardar</button>
                               </form>
                           </div>
                       {% endif %}
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-6 col-lg-3 mb-4">
           <div class="card h-100 border-0 shadow-sm hover-elevate card-doc malla-border">
               <div class="card-body">
                   <div class="d-flex justify-content-between align-items-center mb-3">
                       <h5 class="fw-bold mb-0 text-primary"><i class="fas fa-sitemap me-2"></i>Malla</h5>
                       {% if institucion.archivo_malla_curricular %}<span class="badge bg-success-subtle text-success">Activo</span>{% else %}<span class="badge bg-light text-muted">Vac√≠o</span>{% endif %}
                   </div>
                   <p class="text-muted small">Estructura curricular por √°reas.</p>
                   
                   <div class="d-grid gap-2">
                       {% if institucion.archivo_malla_curricular %}
                           <a href="{{ institucion.archivo_malla_curricular.url }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye me-1"></i> Ver PDF</a>
                       {% endif %}
                       
                       {% if user.perfil.rol in 'ADMINISTRADOR,COORD_ACADEMICO' %}
                           <button class="btn btn-sm btn-light text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#uploadMalla">
                               <i class="fas fa-upload me-1"></i> Actualizar
                           </button>
                           <div class="collapse mt-2" id="uploadMalla">
                               <form method="POST" enctype="multipart/form-data" class="p-2 bg-light rounded border">{% csrf_token %}
                                   <input type="file" name="malla_file" class="form-control form-control-sm mb-2" accept=".pdf" required>
                                   <button type="submit" class="btn btn-success btn-sm w-100">Guardar</button>
                               </form>
                           </div>
                       {% endif %}
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="row g-4 mb-5 animate__animated animate__fadeIn">
       <div class="col-md-3">
           <div class="card border-0 shadow-sm h-100 bg-white overflow-hidden hover-elevate">
               <div class="card-body position-relative">
                   <div class="d-flex justify-content-between align-items-start">
                       <div>
                           <p class="text-uppercase fw-bold text-muted small mb-1">Poblaci√≥n</p>
                            <h2 class="fw-bold text-dark mb-0">{{ kpi.total_alumnos }}</h2>
                           <small class="text-success"><i class="fas fa-check-circle me-1"></i>Activos</small>
                       </div>
                       <div class="bg-soft-primary rounded p-3 text-primary">
                           <i class="fas fa-users fa-2x"></i>
                       </div>
                   </div>
                   <div class="progress mt-3" style="height: 4px;">
                       <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                    </div>
               </div>
           </div>
       </div>

       <div class="col-md-3">
           <div class="card border-0 shadow-sm h-100 bg-white overflow-hidden hover-elevate">
               <div class="card-body position-relative">
                   <div class="d-flex justify-content-between align-items-start">
                        <div>
                           <p class="text-uppercase fw-bold text-muted small mb-1">Prom. Acad√©mico</p>
                           <h2 class="fw-bold text-dark mb-0">{{ kpi.prom_global_acad }}</h2>
                           <small class="text-muted">Meta: > 4.0</small>
                       </div>
                       <div class="bg-soft-info rounded p-3 text-info">
                           <i class="fas fa-book-open fa-2x"></i>
                       </div>
                   </div>
                    <div class="progress mt-3" style="height: 4px;">
                       <div class="progress-bar bg-info" role="progressbar" style="width: {% widthratio kpi.prom_global_acad 5 100 %}%"></div>
                   </div>
               </div>
           </div>
       </div>

       <div class="col-md-3">
           <div class="card border-0 shadow-sm h-100 bg-white overflow-hidden hover-elevate">
                <div class="card-body position-relative">
                   <div class="d-flex justify-content-between align-items-start">
                       <div>
                           <p class="text-uppercase fw-bold text-muted small mb-1">Convivencia</p>
                           <h2 class="fw-bold text-dark mb-0">{{ kpi.prom_global_conv }}</h2>
                           <small class="text-muted">√çndice Global</small>
                       </div>
                       <div class="bg-soft-warning rounded p-3 text-warning">
                           <i class="fas fa-smile fa-2x"></i>
                        </div>
                   </div>
                   <div class="progress mt-3" style="height: 4px;">
                       <div class="progress-bar bg-warning" role="progressbar" style="width: {% widthratio kpi.prom_global_conv 5 100 %}%"></div>
                   </div>
               </div>
           </div>
       </div>

         <div class="col-md-3">
           <div class="card border-0 shadow-sm h-100 bg-white overflow-hidden hover-elevate">
               <div class="card-body position-relative">
                   <div class="d-flex justify-content-between align-items-start">
                       <div>
                           <p class="text-uppercase fw-bold text-muted small mb-1">Grupos</p>
                           <h2 class="fw-bold text-dark mb-0">{{ kpi.total_cursos }}</h2>
                           <small class="text-primary">Gestionados</small>
                       </div>
                        <div class="bg-soft-success rounded p-3 text-success">
                           <i class="fas fa-layer-group fa-2x"></i>
                       </div>
                   </div>
                   <div class="progress mt-3" style="height: 4px;">
                       <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                   </div>
               </div>
           </div>
        </div>
   </div>

   <div class="row mb-5 animate__animated animate__fadeInUp">
       <div class="col-lg-8 mb-4 mb-lg-0">
           <div class="card border-0 shadow-lg h-100" style="border-radius: 1rem;">
               <div class="card-header bg-white border-0 pt-4 px-4">
                   <h5 class="fw-bold text-dark"><i class="fas fa-chart-bar me-2 text-primary"></i>Comparativo Institucional</h5>
               </div>
                <div class="card-body p-4">
                   <div style="height: 350px;">
                       <canvas id="peiChart"></canvas>
                   </div>
               </div>
           </div>
       </div>
       
       <div class="col-lg-4">
            <div class="card border-0 shadow-lg h-100" style="border-radius: 1rem;">
               <div class="card-header bg-white border-0 pt-4 px-4 text-center">
                   <h5 class="fw-bold text-dark"><i class="fas fa-user-clock me-2 text-success"></i>Asistencia Hoy</h5>
               </div>
               <div class="card-body p-4 d-flex justify-content-center align-items-center">
                   <div style="height: 250px; width: 100%; position: relative;">
                       <canvas id="asistenciaChart"></canvas>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="row mb-5 animate__animated animate__fadeInUp">
       
       <div class="col-lg-6 mb-4 mb-lg-0">
           <div class="card border-0 shadow-lg h-100" style="border-radius: 1rem;">
               <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                   <div>
                       <h5 class="fw-bold text-danger"><i class="fas fa-user-clock me-2"></i>Alertas de Ausentismo</h5>
                       <p class="text-muted small mb-0">Estudiantes con mayor n√∫mero de fallas.</p>
                   </div>
                   <a href="{% url 'historial_asistencia' %}" class="btn btn-sm btn-outline-danger rounded-pill">
                       <i class="fas fa-list me-1"></i>Ver Todo
                   </a>
               </div>
               <div class="card-body p-0">
                   <div class="table-responsive">
                       <table class="table table-hover align-middle mb-0">
                           <thead class="bg-light">
                               <tr>
                                   <th class="ps-4">Estudiante</th>
                                   <th class="text-center">Fallas</th>
                                   <th class="text-end pe-4">Ver</th>
                               </tr>
                           </thead>
                           <tbody>
                               {% for alerta in top_fallas %}
                               <tr>
                                   <td class="ps-4">
                                       <div class="fw-bold text-dark">{{ alerta.estudiante__first_name }} {{ alerta.estudiante__last_name }}</div>
                                       <small class="text-muted">{{ alerta.curso__nombre }}</small>
                                   </td>
                                   <td class="text-center"><span class="badge bg-danger rounded-pill px-3">{{ alerta.total }}</span></td>
                                   <td class="text-end pe-4">
                                       <a href="{% url 'ver_observador' alerta.estudiante__id %}" class="btn btn-sm btn-light text-primary"><i class="fas fa-eye"></i></a>
                                   </td>
                               </tr>
                               {% empty %}
                               <tr><td colspan="3" class="text-center py-4 text-muted">Sin alertas cr√≠ticas de asistencia.</td></tr>
                               {% endfor %}
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </div>

       <div class="col-lg-6">
           <div class="card border-0 shadow-lg h-100" style="border-radius: 1rem;">
               <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                   <div>
                       <h5 class="fw-bold text-dark"><i class="fas fa-exclamation-circle me-2 text-warning"></i>Riesgo Convivencial</h5>
                       <p class="text-muted small mb-0">Promedio bajo en Convivencia (< 3.5).</p>
                   </div>
               </div>
               <div class="card-body p-0">
                   <div class="table-responsive">
                       <table class="table table-hover align-middle mb-0">
                           <thead class="bg-light">
                               <tr>
                                   <th class="ps-4">Estudiante</th>
                                   <th class="text-center">Nota</th>
                                   <th class="text-end pe-4">Ver</th>
                               </tr>
                           </thead>
                           <tbody>
                               {% for alerta in alertas_convivencia %}
                               <tr>
                                   <td class="ps-4">
                                       <div class="fw-bold text-dark">{{ alerta.estudiante__first_name }} {{ alerta.estudiante__last_name }}</div>
                                       <small class="text-muted">{{ alerta.materia__curso__nombre }}</small>
                                   </td>
                                   <td class="text-center">
                                       <span class="badge bg-warning text-dark border border-warning rounded-pill px-3">{{ alerta.nota_promedio|floatformat:1 }}</span>
                                   </td>
                                   <td class="text-end pe-4">
                                       <a href="{% url 'ver_observador' alerta.estudiante__id %}" class="btn btn-sm btn-light text-primary"><i class="fas fa-eye"></i></a>
                                   </td>
                               </tr>
                               {% empty %}
                               <tr><td colspan="3" class="text-center py-4 text-muted">¬°Excelente! Buen clima escolar.</td></tr>
                               {% endfor %}
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <div class="card border-0 shadow-sm mb-5 overflow-hidden animate__animated animate__fadeInUp" style="border-radius: 1rem; background-color: #f8f9fa;">
       <div class="card-body p-4 text-center">
           <h4 class="fw-bold mb-3 text-dark">B√∫squeda R√°pida</h4>
           <form method="GET" action="">
               <div class="input-group input-group-lg shadow-sm">
                   <span class="input-group-text bg-white border-0 ps-4"><i class="fas fa-search text-muted"></i></span>
                   <input type="text" name="q" class="form-control bg-white border-0"
                          placeholder="Nombre o documento del estudiante..."
                          value="{{ query|default:'' }}">
                    <button class="btn btn-primary px-5 fw-bold" type="submit">BUSCAR</button>
               </div>
           </form>
       </div>
   </div>

   {% if query %}
       <div class="mb-5 animate__animated animate__fadeIn">
           <h5 class="fw-bold text-secondary mb-3"><i class="fas fa-list me-2"></i>Resultados de B√∫squeda:</h5>
            {% if estudiantes %}
               <div class="row g-3">
                   {% for estudiante in estudiantes %}
                   <div class="col-md-6 col-lg-4">
                       <div class="card h-100 border-0 shadow-hover">
                           <div class="card-body d-flex align-items-center p-3">
                               <div class="avatar-circle me-3 bg-light text-primary d-flex align-items-center justify-content-center rounded-circle" style="width: 45px; height: 45px; font-weight: bold;">
                                   {{ estudiante.first_name|slice:":1" }}
                               </div>
                               <div class="flex-grow-1">
                                   <h6 class="fw-bold mb-0 text-dark">{{ estudiante.get_full_name }}</h6>
                                    <small class="text-muted">{{ estudiante.username }}</small>
                               </div>
                               <a href="{% url 'ver_observador' estudiante.id %}" class="btn btn-sm btn-primary rounded-circle">
                                   <i class="fas fa-arrow-right"></i>
                               </a>
                           </div>
                       </div>
                   </div>
                   {% endfor %}
                </div>
           {% else %}
               <div class="alert alert-warning border-0 shadow-sm">No se encontraron estudiantes con ese criterio.</div>
           {% endif %}
       </div>
   {% endif %}

   <div class="d-flex justify-content-between align-items-end mb-3">
       <h4 class="fw-bold text-dark mb-0"><i class="fas fa-chalkboard-teacher me-2 text-primary"></i>Gesti√≥n por Grupos</h4>
    </div>

   <div class="accordion shadow-sm rounded-3 overflow-hidden" id="accordionCursos">
       {% for item in vista_cursos %}
       <div class="accordion-item border-0 mb-2 shadow-sm" style="border-radius: 0.5rem; overflow: hidden;">
           <h2 class="accordion-header" id="heading{{ item.curso.id }}">
               <button class="accordion-button collapsed py-3 bg-white text-dark fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ item.curso.id }}" aria-expanded="false">
                   <div class="row w-100 align-items-center">
                       <div class="col-md-4 d-flex align-items-center">
                            <span class="badge bg-primary me-3">{{ item.curso.nombre }}</span>
                           <span class="small text-muted">{{ item.stats.alumnos }} Alumnos</span>
                       </div>
                       <div class="col-md-4 text-center d-none d-md-block">
                           <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Prom. Acad√©mico</small>
                           <div class="fw-bold text-info">{{ item.stats.acad }}</div>
                       </div>
                       <div class="col-md-3 text-center d-none d-md-block">
                           <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Prom. Convivencia</small>
                            <div class="fw-bold text-warning">{{ item.stats.conv }}</div>
                       </div>
                   </div>
               </button>
           </h2>
           <div id="collapse{{ item.curso.id }}" class="accordion-collapse collapse" data-bs-parent="#accordionCursos">
               <div class="accordion-body p-0">
                   
                   {% if item.top_10_academico %}
                   <div class="p-3 bg-light border-bottom">
                       <div class="card border-0 shadow-sm">
                           <div class="card-header bg-gradient-success text-white py-2 d-flex justify-content-between align-items-center">
                               <h6 class="mb-0 fw-bold"><i class="fas fa-trophy me-2 text-warning"></i>Top 10 Rendimiento</h6>
                               <small class="text-white-50">Orden por promedio</small>
                           </div>
                           <div class="card-body p-0">
                               <div class="table-responsive">
                                   <table class="table table-sm table-striped mb-0 small text-center align-middle">
                                       <thead class="text-secondary bg-white">
                                           <tr>
                                               <th style="width: 50px;">Pos</th>
                                               <th class="text-start ps-3">Estudiante</th>
                                               <th style="width: 100px;">Promedio</th>
                                           </tr>
                                       </thead>
                                       <tbody>
                                           {% for top_est in item.top_10_academico %}
                                           <tr>
                                               <td class="fw-bold">
                                                   {% if forloop.counter == 1 %}ü•á
                                                   {% elif forloop.counter == 2 %}ü•à
                                                   {% elif forloop.counter == 3 %}ü•â
                                                   {% else %}{{ forloop.counter }}
                                                   {% endif %}
                                               </td>
                                               <td class="text-start ps-3">{{ top_est.nombre }}</td>
                                               <td>
                                                   <span class="badge bg-success bg-opacity-75 rounded-pill">
                                                       {{ top_est.promedio }}
                                                   </span>
                                               </td>
                                           </tr>
                                           {% endfor %}
                                       </tbody>
                                   </table>
                               </div>
                           </div>
                       </div>
                   </div>
                   {% endif %}
                   <div class="table-responsive">
                       <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-muted small text-uppercase">
                               <tr>
                                   <th class="ps-4 py-3">Estudiante</th>
                                   {% for p in periodos %}
                                       <th class="text-center">P{{ forloop.counter }}</th>
                                   {% endfor %}
                                   <th class="text-end pe-4">Acci√≥n</th>
                               </tr>
                           </thead>
                            <tbody>
                               {% for obj_est in item.estudiantes %}
                               <tr>
                                   <td class="ps-4">
                                       <div class="d-flex align-items-center">
                                           <div class="avatar-xs rounded bg-light text-secondary d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px; font-size: 0.8rem; font-weight:bold;">
                                               {{ obj_est.obj.first_name|slice:":1" }}
                                           </div>
                                           <span class="fw-semibold text-dark small">{{ obj_est.obj.get_full_name }}</span>
                                        </div>
                                   </td>
                                  
                                   {% for p in periodos %}
                                       <td class="text-center">
                                           {% with nota=obj_est.notas|get_item:p.id %}
                                               {% if nota != "-" %}
                                                   <span class="badge {% if nota < 3.0 %}bg-danger-subtle text-danger{% elif nota >= 4.0 %}bg-success-subtle text-success{% else %}bg-warning-subtle text-warning{% endif %} rounded-pill">
                                                       {{ nota }}
                                                    </span>
                                               {% else %}
                                                   <span class="text-muted opacity-25 small">-</span>
                                               {% endif %}
                                           {% endwith %}
                                       </td>
                                   {% endfor %}

                                   <td class="text-end pe-4 d-flex gap-2 justify-content-end">
                                        <a href="{% url 'ai_engine' %}?action=analisis_convivencia&target_id={{ obj_est.obj.id }}" class="btn btn-sm btn-outline-purple rounded-pill shadow-sm" title="An√°lisis de Convivencia IA">
                                            <i class="fas fa-robot"></i>
                                        </a>
                                        <a href="{% url 'crear_observacion' obj_est.obj.id %}" class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                           <i class="fas fa-pen me-1"></i> Anotar
                                       </a>
                                   </td>
                               </tr>
                               {% endfor %}
                           </tbody>
                       </table>
                   </div>
                </div>
           </div>
       </div>
       {% empty %}
       <div class="p-5 text-center text-muted">
           <i class="fas fa-folder-open fa-3x mb-3 opacity-50"></i>
           <p>No hay cursos activos configurados.</p>
       </div>
       {% endfor %}
    </div>
</div>

<script>
   document.addEventListener('DOMContentLoaded', function() {
       
       // --- 1. GR√ÅFICO DE RADAR ACAD√âMICO (NUEVO) ---
       const ctxRadar = document.getElementById('radarChart');
       if (ctxRadar) {
           // Datos simulados (Debes pasar estos desde Django en kpi.radar_data)
           const radarData = {
               labels: ['Matem√°ticas', 'Lenguaje', 'Ciencias', 'Sociales', 'Ingl√©s', 'Tecnolog√≠a'],
               datasets: [{
                   label: 'Promedio Institucional',
                   data: [3.8, 4.2, 3.5, 4.0, 3.2, 4.5], // Reemplazar con datos reales
                   fill: true,
                   backgroundColor: 'rgba(54, 162, 235, 0.2)',
                   borderColor: 'rgb(54, 162, 235)',
                   pointBackgroundColor: 'rgb(54, 162, 235)',
                   pointBorderColor: '#fff',
                   pointHoverBackgroundColor: '#fff',
                   pointHoverBorderColor: 'rgb(54, 162, 235)'
               }]
           };

           new Chart(ctxRadar, {
               type: 'radar',
               data: radarData,
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   scales: {
                       r: {
                           angleLines: { display: false },
                           suggestedMin: 0,
                           suggestedMax: 5
                       }
                   },
                   plugins: { legend: { display: false } }
               }
           });
       }

       // --- 2. GR√ÅFICO COMPARATIVO POR CURSO (PEI) ---
       const ctx = document.getElementById('peiChart');
       if (ctx) {
           const labels = JSON.parse('{{ chart_data.labels|safe }}');
           const dataAcad = JSON.parse('{{ chart_data.acad|safe }}');
           const dataConv = JSON.parse('{{ chart_data.conv|safe }}');

           new Chart(ctx.getContext('2d'), {
               type: 'bar',
               data: {
                   labels: labels,
                   datasets: [
                       {
                            label: 'Rendimiento Acad√©mico',
                           data: dataAcad,
                           backgroundColor: 'rgba(13, 202, 240, 0.6)', 
                           borderColor: 'rgba(13, 202, 240, 1)',
                           borderWidth: 1,
                           borderRadius: 4
                       },
                       {
                           label: '√çndice de Convivencia',
                            data: dataConv,
                           backgroundColor: 'rgba(255, 193, 7, 0.6)', 
                           borderColor: 'rgba(255, 193, 7, 1)',
                           borderWidth: 1,
                           borderRadius: 4
                       }
                   ]
               },
               options: {
                    responsive: true,
                   maintainAspectRatio: false,
                   scales: {
                       y: { beginAtZero: true, max: 5, grid: { borderDash: [5, 5] } },
                       x: { grid: { display: false } }
                   },
                   plugins: { legend: { position: 'top' } }
               }
           });
       }

       // --- 3. GR√ÅFICO DE ASISTENCIA ---
       const ctxAsistencia = document.getElementById('asistenciaChart');
       if (ctxAsistencia) {
           const dataAsistencia = JSON.parse('{{ stats_asistencia|safe }}');
           
           new Chart(ctxAsistencia.getContext('2d'), {
               type: 'doughnut',
               data: {
                   labels: ['Asisti√≥', 'Falla', 'Excusa', 'Tarde'],
                   datasets: [{
                       data: dataAsistencia,
                       backgroundColor: [
                           '#198754', 
                           '#dc3545', 
                           '#0dcaf0', 
                           '#ffc107'
                       ],
                       borderWidth: 0,
                       hoverOffset: 6
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   plugins: {
                       legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } }
                   },
                   cutout: '70%'
               }
           });
       }
   });
</script>

<style>
   /* === ESTILOS PERSONALIZADOS (EDUTECH TIER 100) === */
   
   /* 1. Iconos Circulares Grandes */
   .icon-box-xl {
       width: 80px; height: 80px;
   }

   /* 2. Colores Soft (Fondo Pastel) */
   .bg-soft-primary { background-color: rgba(67, 97, 238, 0.15); }
   .bg-soft-info { background-color: rgba(13, 202, 240, 0.15); }
   .bg-soft-success { background-color: rgba(25, 135, 84, 0.15); }
   .bg-soft-warning { background-color: rgba(255, 193, 7, 0.15); }
   
   /* 3. Colores Documentos */
   .text-purple { color: #6610f2; }
   .btn-outline-purple { color: #6610f2; border-color: #6610f2; }
   .btn-outline-purple:hover { background-color: #6610f2; color: white; }
   .pei-border { border-top: 4px solid #6610f2 !important; }

   .text-orange { color: #fd7e14; }
   .btn-outline-orange { color: #fd7e14; border-color: #fd7e14; }
   .btn-outline-orange:hover { background-color: #fd7e14; color: white; }
   .manual-border { border-top: 4px solid #fd7e14 !important; }

   .text-teal { color: #20c997; }
   .btn-outline-teal { color: #20c997; border-color: #20c997; }
   .btn-outline-teal:hover { background-color: #20c997; color: white; }
   .proyectos-border { border-top: 4px solid #20c997 !important; }
   
   .malla-border { border-top: 4px solid #0d6efd !important; }
   .calendario-border { border-top: 4px solid #dc3545 !important; }

   /* 4. Efectos Hover */
   .hover-elevate { transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
   .hover-elevate:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important; }
   
   .hover-scale { transition: transform 0.2s; }
   .hover-scale:hover { transform: scale(1.05); }

   /* 5. Avatares */
   .avatar-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
   
   /* 6. Utilidades */
   .bg-success-subtle { background-color: #d1e7dd; }
   .bg-warning-subtle { background-color: #fff3cd; }
   .bg-danger-subtle { background-color: #f8d7da; }
   .bg-gradient-success { background: linear-gradient(135deg, #1cc88a, #13855c); }
   .accordion-button:not(.collapsed) { background-color: #f8f9fa; color: #333; }
   .accordion-button:focus { box-shadow: none; border-color: rgba(0,0,0,.1); }
</style>
{% endblock %}