{% extends "base.html" %}
{% load dict_filters %}
{% load static %}
{% block content %}
<div class="container-fluid py-4">
    <div class="card border-0 shadow-lg animate animated fadeInUp">
        <div class="card-header bg-primary text-white p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0 fw-bold"><i class="fas fa-chart-line me-3"></i> Sistema de Calificaciones</h2>
                    <p class="mb-0 fs-5">Curso: {{ curso.nombre }} | Materia: {{ materia.nombre }}</p>
                </div>
                <a href="{% url 'dashboard_docente' %}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-1"></i>Volver al Panel
                </a>
            </div>
        </div>
        <div class="card-body p-4">
            <form method="POST" id="notasForm">
                {% csrf_token %}
                <input type="hidden" name="logros_json_data" id="logros-json-data" value="{{ logros_por_periodo }}">

                <div class="mb-5 d-flex align-items-center">
                    <label for="periodoSelector" class="form-label h4 text-secondary mb-0 me-3"><i class="fas fa-calendar-alt me-2"></i>Selecciona un Periodo para editar: </label>
                    <select class="form-select form-select-lg w-auto" id="periodoSelector" name="periodo_id">
                        {% for periodo in periodos %}
                        <option value="{{ periodo.id }}">{{ periodo.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="card border-0 shadow-sm mb-5">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Actividades de la Semana</h5>
                        <button type="button" class="btn btn-sm btn-outline-light" id="btn-agregar-actividad"><i class="fas fa-plus me-1"></i>Agregar Actividad</button>
                    </div>
                    <div class="card-body">
                        <div id="lista-actividades">
                            {% for actividad in actividades_semanales %}
                            <div class="actividad-item p-3 mb-3 border rounded-3" data-id="{{ actividad.id }}">
                                <div class="actividad-info d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="fw-bold">{{ actividad.titulo }}</h6>
                                        <p class="small text-muted mb-2"><i class="fas fa-calendar-alt me-1"></i>Fechas: {{ actividad.fecha_inicio|date:"d M Y" }} - {{ actividad.fecha_fin|date:"d M Y" }}</p>
                                        <p class="mb-0">{{ actividad.descripcion }}</p>
                                    </div>
                                    <div class="actividad-acciones">
                                        <button type="button" class="btn btn-sm btn-outline-primary btn-editar-actividad"><i class="fas fa-edit"></i></button>
                                        <button type="button" class="btn btn-sm btn-outline-danger btn-borrar-actividad" data-id="{{ actividad.id }}"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <div class="actividad-form-edit mt-3" style="display:none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Titulo</label>
                                                <input type="text" class="form-control titulo-actividad-input" value="{{ actividad.titulo }}">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Fecha de inicio</label>
                                                <input type="date" class="form-control fecha-inicio-actividad-input" value="{{ actividad.fecha_inicio|date:'Y-m-d' }}">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Fecha de finalización</label>
                                                <input type="date" class="form-control fecha-fin-actividad-input" value="{{ actividad.fecha_fin|date:'Y-m-d' }}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Descripción</label>
                                        <textarea class="form-control descripcion-actividad-input" rows="3">{{ actividad.descripcion }}</textarea>
                                    </div>
                                    <div class="text-end">
                                        <button type="button" class="btn btn-sm btn-secondary btn-cancelar-edicion">Cancelar</button>
                                        <button type="button" class="btn btn-sm btn-primary btn-guardar-edicion">Guardar Edición</button>
                                    </div>
                                </div>
                                <input type="hidden" name="actividad_id[]" value="{{ actividad.id }}">
                                <input type="hidden" name="titulo_actividad[]" value="{{ actividad.titulo }}">
                                <input type="hidden" name="descripcion_actividad[]" value="{{ actividad.descripcion }}">
                                <input type="hidden" name="fecha_inicio_actividad[]" value="{{ actividad.fecha_inicio|date:'Y-m-d' }}">
                                <input type="hidden" name="fecha_fin_actividad[]" value="{{ actividad.fecha_fin|date:'Y-m-d' }}">
                            </div>
                            {% empty %}
                            <p class="text-muted mb-0">No hay actividades semanales registradas.</p>
                            {% endfor %}
                        </div>

                        <div id="plantilla-nueva-actividad" style="display: none;">
                            <div class="actividad-item p-3 mb-3 border rounded-3 new-activity-item">
                                <div class="actividad-form-new">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Titulo</label>
                                                <input type="text" class="form-control titulo-actividad-input" placeholder="Escribe un título...">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Fecha de inicio</label>
                                                <input type="date" class="form-control fecha-inicio-actividad-input">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Fecha de finalización</label>
                                                <input type="date" class="form-control fecha-fin-actividad-input">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Descripción</label>
                                        <textarea class="form-control descripcion-actividad-input" rows="3" placeholder="Describe la tarea..."></textarea>
                                    </div>
                                    <div class="text-end">
                                        <button type="button" class="btn btn-sm btn-secondary btn-cancelar-creacion">Cancelar</button>
                                        <button type="button" class="btn btn-sm btn-primary btn-guardar-creacion">Guardar Actividad</button>
                                    </div>
                                </div>
                                <input type="hidden" name="actividad_id[]" value="">
                                <input type="hidden" name="titulo_actividad[]" value="">
                                <input type="hidden" name="descripcion_actividad[]" value="">
                                <input type="hidden" name="fecha_inicio_actividad[]" value="">
                                <input type="hidden" name="fecha_fin_actividad[]" value="">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-5">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold"><i class="fas fa-trophy me-2"></i>Logros del Período</h5>
                        <button type="button" class="btn btn-sm btn-outline-dark" id="btn-agregar-logro"><i class="fas fa-plus me-1"></i>Agregar Logro</button>
                    </div>
                    <div class="card-body">
                        <div id="lista-logros">
                            <p class="text-muted mb-0">Selecciona un período para ver y editar los logros.</p>
                        </div>
                        <div id="plantilla-nueva-logro" style="display: none;">
                            <div class="logro-item p-3 mb-3 border rounded-3 new-logro-item">
                                <div class="logro-form">
                                    <div class="mb-3">
                                        <label class="form-label">Descripción del Logro</label>
                                        <textarea class="form-control descripcion-logro-input" rows="3" placeholder="Describe el logro..."></textarea>
                                    </div>
                                    <div class="text-end">
                                        <button type="button" class="btn btn-sm btn-secondary btn-cancelar-creacion-logro">Cancelar</button>
                                        <button type="button" class="btn btn-sm btn-primary btn-guardar-creacion-logro">Guardar Logro</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-striped">
                        <thead class="bg-primary text-white">
                            <tr>
                                <th class="align-middle text-center" rowspan="2">Estudiante</th>
                                <th class="text-center" colspan="6">Calificaciones y Comentarios por Periodo</th>
                                </tr>
                            <tr>
                                <th class="text-center bg-light-blue text-primary fw-bold">Nota 1</th>
                                <th class="text-center bg-light-blue text-primary fw-bold">Nota 2</th>
                                <th class="text-center bg-light-blue text-primary fw-bold">Nota 3</th>
                                <th class="text-center bg-light-blue text-primary fw-bold">Nota 4</th>
                                <th class="text-center bg-warning text-dark fw-bold">Promedio</th>
                                <th class="text-center bg-light-blue text-primary fw-bold">Comentario del Docente</th>
                            </tr>
                            </thead>
                        <tbody>
                            {% for matricula in estudiantes_matriculados %}
                            <tr class="align-middle">
                                <td class="fw-bold">
                                    <i class="fas fa-user-graduate me-2 text-primary"></i>
                                    <span data-estudiante-id="{{ matricula.estudiante.id }}">{{ matricula.estudiante.get_full_name|default:matricula.estudiante.username }}</span>
                                </td>
                                
                                {% for periodo in periodos %}
                                <td class="p-0 periodo-cell" data-periodo-id="{{ periodo.id }}" data-estudiante-id="{{ matricula.estudiante.id }}" style="display:none;">
                                    <input type="number" name="nota_{{ matricula.estudiante.id }}_{{ periodo.id }}_1" value="{{ notas_data|get_item:matricula.estudiante.id|get_item:'periodos'|get_item:periodo.id|get_item:1|default:"" }}" class="form-control form-control-sm nota-input" step="0.1" min="0.0" max="5.0" placeholder="0.0">
                                </td>
                                <td class="p-0 periodo-cell" data-periodo-id="{{ periodo.id }}" data-estudiante-id="{{ matricula.estudiante.id }}" style="display:none;">
                                    <input type="number" name="nota_{{ matricula.estudiante.id }}_{{ periodo.id }}_2" value="{{ notas_data|get_item:matricula.estudiante.id|get_item:'periodos'|get_item:periodo.id|get_item:2|default:"" }}" class="form-control form-control-sm nota-input" step="0.1" min="0.0" max="5.0" placeholder="0.0">
                                </td>
                                <td class="p-0 periodo-cell" data-periodo-id="{{ periodo.id }}" data-estudiante-id="{{ matricula.estudiante.id }}" style="display:none;">
                                    <input type="number" name="nota_{{ matricula.estudiante.id }}_{{ periodo.id }}_3" value="{{ notas_data|get_item:matricula.estudiante.id|get_item:'periodos'|get_item:periodo.id|get_item:3|default:"" }}" class="form-control form-control-sm nota-input" step="0.1" min="0.0" max="5.0" placeholder="0.0">
                                </td>
                                <td class="p-0 periodo-cell" data-periodo-id="{{ periodo.id }}" data-estudiante-id="{{ matricula.estudiante.id }}" style="display:none;">
                                    <input type="number" name="nota_{{ matricula.estudiante.id }}_{{ periodo.id }}_4" value="{{ notas_data|get_item:matricula.estudiante.id|get_item:'periodos'|get_item:periodo.id|get_item:4|default:"" }}" class="form-control form-control-sm nota-input" step="0.1" min="0.0" max="5.0" placeholder="0.0">
                                </td>
                                <td class="text-center fw-bold bg-warning-light p-0 periodo-cell" data-periodo-id="{{ periodo.id }}" data-estudiante-id="{{ matricula.estudiante.id }}" style="display:none;">
                                    <span id="promedio_{{ matricula.estudiante.id }}_{{ periodo.id }}">
                                        {% with nota_promedio=notas_data|get_item:matricula.estudiante.id|get_item:'periodos'|get_item:periodo.id|get_item:5 %}
                                        {% if nota_promedio %}{{ nota_promedio|floatformat:2 }}{% else %}-{% endif %}
                                        {% endwith %}
                                    </span>
                                </td>
                                
                                <td class="p-0 periodo-cell" data-periodo-id="{{ periodo.id }}" data-estudiante-id="{{ matricula.estudiante.id }}" style="display:none;">
                                    <textarea name="comentario_{{ matricula.estudiante.id }}_{{ periodo.id }}" class="form-control" placeholder="Escribe un comentario..." rows="2">{{ comentarios_data|get_item:matricula.estudiante.id|get_item:periodo.id|default:'' }}</textarea>
                                </td>
                                {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div id="floating-save-button" class="d-none fixed-bottom text-center p-3 bg-white border-top shadow-lg">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save me-2"></i>Guardar Cambios
                    </button>
                    <a href="{% url 'dashboard_docente' %}" class="btn btn-secondary btn-lg ms-2">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="logros-por-periodo-data" style="display: none;">{{ logros_por_periodo }}</div>

<div class="modal fade" id="confirmarBorrarModal" tabindex="-1" aria-labelledby="confirmarBorrarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmarBorrarModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar la actividad semanal?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirmar-borrar">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<style>
.form-select-lg { min-height: calc(2.5rem + 2px); font-size: 1.25rem; }
.bg-primary { background-color: #4361ee !important; }
.text-primary { color: #4361ee !important; }
.btn-outline-light { border-color: #fff; color: #fff; }
.btn-outline-light:hover { background-color: rgba(255, 255, 255, 0.15); }
.bg-warning-light { background-color: #fff3cd !important; }
.shadow-lg { box-shadow: 0 1rem 3rem rgba(0,0,0,.175) !important; }
body { background-color: #f0f2f5; font-family: 'Inter', sans-serif; }
.card { border-radius: 1rem; }
.card-header.bg-primary { background: linear-gradient(45deg,#4361ee,#4895ef) !important; border-radius: 1rem 1rem 0 0; }
.card-header.bg-success { background: linear-gradient(45deg,#28a745,#24c6af) !important; border-radius: .75rem .75rem 0 0; }
.table thead tr th { background: linear-gradient(45deg,#4361ee,#4895ef); color: white; border: none; }
.bg-light-blue { background-color: #e9f1ff !important; color: #3b5998 !important; font-weight: bold; }
.nota-input { width: 70px; text-align: center; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const periodoSelector = document.getElementById('periodoSelector');
    const floatingSaveButton = document.getElementById('floating-save-button');
    const notasForm = document.getElementById('notasForm');
    const listaActividades = document.getElementById('lista-actividades');
    const plantillaNuevaActividad = document.getElementById('plantilla-nueva-actividad');
    const btnAgregarActividad = document.getElementById('btn-agregar-actividad');
    const confirmarBorrarModal = new bootstrap.Modal(document.getElementById('confirmarBorrarModal'));
    let id_a_borrar = null;

    // Muestra/oculta los campos de notas según el período seleccionado
    function mostrarPeriodoNotas() {
        const periodoId = periodoSelector.value;
        document.querySelectorAll('.periodo-cell').forEach(c => {
            if (c.dataset.periodoId === periodoId) {
                c.style.display = "";
            } else {
                c.style.display = "none";
            }
        });
        
        // ======================================================
        // INICIO DE LA CORRECCIÓN 3: JavaScript
        // Se elimina la siguiente línea que mostraba
        // la celda de comentario incorrecta:
        // document.querySelectorAll('.comentario-cell').forEach(c => c.style.display = "");
        // ======================================================
    }

    // Calcula el promedio de las notas
    function calcularPromedio() {
        const periodoId = periodoSelector.value;
        document.querySelectorAll('tbody tr').forEach(fila => {
            const estudianteId = fila.querySelector('span[data-estudiante-id]').dataset.estudianteId;
            let promedio = 0;
            const pesos = {1:0.2,2:0.3,3:0.3,4:0.2};
            let completo = true;
            for (let i=1;i<=4;i++) {
                const input = fila.querySelector(`input[name="nota_${estudianteId}_${periodoId}_${i}"]`);
                if (input && input.value !== "") {
                    promedio += parseFloat(input.value) * pesos[i];
                } else { completo=false; }
            }
            const spanProm = fila.querySelector(`#promedio_${estudianteId}_${periodoId}`);
            spanProm.textContent = completo ? promedio.toFixed(2) : "-";
        });
    }

    // Muestra/oculta los botones de guardar
    function mostrarBotonGuardar() {
        floatingSaveButton.classList.remove('d-none');
    }

    // Lógica para actividades
    btnAgregarActividad.addEventListener('click', function() {
        const nuevaActividadHtml = plantillaNuevaActividad.querySelector('.new-activity-item').cloneNode(true);
        nuevaActividadHtml.style.display = '';
        listaActividades.appendChild(nuevaActividadHtml);
        
        // Asignar listeners a los nuevos botones
        const btnGuardar = nuevaActividadHtml.querySelector('.btn-guardar-creacion');
        const btnCancelar = nuevaActividadHtml.querySelector('.btn-cancelar-creacion');

        btnGuardar.addEventListener('click', function() {
            const titulo = nuevaActividadHtml.querySelector('.titulo-actividad-input').value;
            const descripcion = nuevaActividadHtml.querySelector('.descripcion-actividad-input').value;
            const fechaInicio = nuevaActividadHtml.querySelector('.fecha-inicio-actividad-input').value;
            const fechaFin = nuevaActividadHtml.querySelector('.fecha-fin-actividad-input').value;

            // Rellenar campos ocultos
            nuevaActividadHtml.querySelector('input[name="titulo_actividad[]"]').value = titulo;
            nuevaActividadHtml.querySelector('input[name="descripcion_actividad[]"]').value = descripcion;
            nuevaActividadHtml.querySelector('input[name="fecha_inicio_actividad[]"]').value = fechaInicio;
            nuevaActividadHtml.querySelector('input[name="fecha_fin_actividad[]"]').value = fechaFin;

            // Ocultar formulario de creación y mostrar info
            const infoDiv = document.createElement('div');
            infoDiv.classList.add('actividad-info', 'd-flex', 'justify-content-between', 'align-items-start');
            infoDiv.innerHTML = `
                <div>
                    <h6 class="fw-bold">${titulo}</h6>
                    <p class="small text-muted mb-2"><i class="fas fa-calendar-alt me-1"></i>Fechas: ${fechaInicio} - ${fechaFin}</p>
                    <p class="mb-0">${descripcion}</p>
                </div>
                <div class="actividad-acciones">
                    <button type="button" class="btn btn-sm btn-outline-danger btn-borrar-actividad"><i class="fas fa-trash"></i></button>
                </div>
            `;
            nuevaActividadHtml.innerHTML = infoDiv.outerHTML + `
                <input type="hidden" name="actividad_id[]" value="">
                <input type="hidden" name="titulo_actividad[]" value="${titulo}">
                <input type="hidden" name="descripcion_actividad[]" value="${descripcion}">
                <input type="hidden" name="fecha_inicio_actividad[]" value="${fechaInicio}">
                <input type="hidden" name="fecha_fin_actividad[]" value="${fechaFin}">
            `;
            mostrarBotonGuardar();
            // Re-bind listeners para el nuevo botón de borrar
            nuevaActividadHtml.querySelector('.btn-borrar-actividad').addEventListener('click', function() {
                // Como es una actividad nueva, simplemente se borra del DOM
                this.closest('.actividad-item').remove();
                mostrarBotonGuardar();
            });
        });

        btnCancelar.addEventListener('click', function() {
            nuevaActividadHtml.remove();
        });
    });

    // Lógica para el botón de borrar actividades existentes
    document.querySelectorAll('.btn-borrar-actividad').forEach(btn => {
        btn.addEventListener('click', function() {
            id_a_borrar = this.dataset.id;
            confirmarBorrarModal.show();
        });
    });
    
    // Confirma la eliminación de la actividad
    document.getElementById('btn-confirmar-borrar').addEventListener('click', function() {
        if (id_a_borrar) {
            const actividadItem = document.querySelector(`.actividad-item[data-id="${id_a_borrar}"]`);
            if (actividadItem) {
                // Reemplazar el input hidden con un valor negativo para indicar borrado
                actividadItem.querySelector('input[name="actividad_id[]"]').value = -id_a_borrar;
                actividadItem.style.display = 'none'; // Ocultar el elemento en lugar de eliminarlo
                confirmarBorrarModal.hide();
                mostrarBotonGuardar();
            }
        }
    });


    // Lógica para logros
    const btnAgregarLogro = document.getElementById('btn-agregar-logro');
    const listaLogros = document.getElementById('lista-logros');
    const plantillaNuevaLogro = document.getElementById('plantilla-nueva-logro');
    const logrosPorPeriodoData = JSON.parse(document.getElementById('logros-por-periodo-data').textContent);

    function renderizarLogros() {
        const periodoId = periodoSelector.value;
        const logrosDelPeriodo = logrosPorPeriodoData[periodoId] || [];
        listaLogros.innerHTML = '';
        if (logrosDelPeriodo.length === 0) {
            listaLogros.innerHTML = '<p class="text-muted mb-0">No hay logros registrados para este período.</p>';
        } else {
            logrosDelPeriodo.forEach(logro => {
                const logroItem = document.createElement('div');
                logroItem.classList.add('logro-item', 'p-3', 'mb-3', 'border', 'rounded-3');
                logroItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="mb-0">${logro.descripcion}</p>
                        <button type="button" class="btn btn-sm btn-outline-danger btn-borrar-logro" data-id="${logro.id}"><i class="fas fa-trash"></i></button>
                    </div>
                    <input type="hidden" name="logro_id[]" value="${logro.id}">
                    <input type="hidden" name="descripcion_logro[]" value="${logro.descripcion}">
                    <input type="hidden" name="periodo_id_logro[]" value="${logro.periodo_id}">
                `;
                listaLogros.appendChild(logroItem);
            });

            // Re-bind listeners a los nuevos botones de borrar logro
            document.querySelectorAll('.btn-borrar-logro').forEach(btn => {
                btn.addEventListener('click', function() {
                    const logroId = this.dataset.id;
                    const logroItem = this.closest('.logro-item');
                    
                    // Si el logro tiene un ID, lo marcamos para borrar en el JSON
                    if (logroId !== '0') {
                        const periodoId = periodoSelector.value;
                        const logrosDelPeriodo = logrosPorPeriodoData[periodoId];
                        if (logrosDelPeriodo) {
                            const index = logrosDelPeriodo.findIndex(l => l.id == logroId);
                            if (index !== -1) {
                                // Marcamos el logro con un ID negativo para indicar que debe ser borrado en el backend
                                logrosDelPeriodo[index].id = -logroId;
                            }
                        }
                    }

                    // Eliminamos el elemento del DOM
                    logroItem.remove();
                    
                    // Actualizamos el campo JSON
                    document.getElementById('logros-json-data').value = JSON.stringify(logrosPorPeriodoData);
                    mostrarBotonGuardar();

                    // Si no quedan logros, mostramos el mensaje por defecto
                    if (listaLogros.children.length === 0) {
                        listaLogros.innerHTML = '<p class="text-muted mb-0">No hay logros registrados para este período.</p>';
                    }
                });
            });
        }
    }

    btnAgregarLogro.addEventListener('click', function() {
        const periodoId = periodoSelector.value;
        const nuevaLogroHtml = plantillaNuevaLogro.querySelector('.new-logro-item').cloneNode(true);
        nuevaLogroHtml.style.display = '';
        listaLogros.appendChild(nuevaLogroHtml);

        const btnGuardar = nuevaLogroHtml.querySelector('.btn-guardar-creacion-logro');
        const btnCancelar = nuevaLogroHtml.querySelector('.btn-cancelar-creacion-logro');
        const logroInput = nuevaLogroHtml.querySelector('.descripcion-logro-input');
        
        btnGuardar.addEventListener('click', function() {
            const descripcion = logroInput.value;
            if (descripcion.trim() === '') {
                alert('El logro no puede estar vacío.');
                return;
            }

            // Añadir el nuevo logro al JSON de datos
            const periodoLogros = logrosPorPeriodoData[periodoId] || [];
            // Usamos id: 0 para indicar que es un nuevo logro
            periodoLogros.push({id: 0, descripcion: descripcion, periodo_id: parseInt(periodoId)});
            logrosPorPeriodoData[periodoId] = periodoLogros;

            // Volver a renderizar la lista de logros
            renderizarLogros();
            
            // Actualizar campo JSON
            document.getElementById('logros-json-data').value = JSON.stringify(logrosPorPeriodoData);

            mostrarBotonGuardar();
        });

        btnCancelar.addEventListener('click', function() {
            nuevaLogroHtml.remove();
        });
    });

    // Delegación de eventos para los botones de editar actividad
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-editar-actividad')) {
            const btn = e.target.closest('.btn-editar-actividad');
            const actividadItem = btn.closest('.actividad-item');
            const infoDiv = actividadItem.querySelector('.actividad-info');
            const formDiv = actividadItem.querySelector('.actividad-form-edit');
            const btnGuardarEdicion = formDiv.querySelector('.btn-guardar-edicion');
            const btnCancelarEdicion = formDiv.querySelector('.btn-cancelar-edicion');

            // Mostrar el formulario y ocultar la información
            infoDiv.style.display = 'none';
            formDiv.style.display = '';

            btnGuardarEdicion.onclick = function() {
                const titulo = formDiv.querySelector('.titulo-actividad-input').value;
                const descripcion = formDiv.querySelector('.descripcion-actividad-input').value;
                const fechaInicio = formDiv.querySelector('.fecha-inicio-actividad-input').value;
                const fechaFin = formDiv.querySelector('.fecha-fin-actividad-input').value;
                
                // Actualizar los campos hidden con los nuevos valores
                actividadItem.querySelector('input[name="titulo_actividad[]"]').value = titulo;
                actividadItem.querySelector('input[name="descripcion_actividad[]"]').value = descripcion;
                actividadItem.querySelector('input[name="fecha_inicio_actividad[]"]').value = fechaInicio;
                actividadItem.querySelector('input[name="fecha_fin_actividad[]"]').value = fechaFin;
                
                // Actualizar la vista de información
                infoDiv.querySelector('h6.fw-bold').textContent = titulo;
                infoDiv.querySelector('p.small').textContent = descripcion;
                infoDiv.querySelector('p.small.text-muted').textContent = `Fechas: ${fechaInicio} - ${fechaFin}`;

                // Ocultar el formulario y mostrar la información actualizada
                formDiv.style.display = 'none';
                infoDiv.style.display = 'flex';
                mostrarBotonGuardar();
            };

            btnCancelarEdicion.onclick = function() {
                // Ocultar el formulario y mostrar la información original
                formDiv.style.display = 'none';
                infoDiv.style.display = 'flex';
            };
        }
    });


    periodoSelector.addEventListener('change', function () {
        mostrarPeriodoNotas();
        calcularPromedio();
        renderizarLogros();
    });
    periodoSelector.dispatchEvent(new Event('change'));

    document.querySelectorAll('.nota-input').forEach(i => i.addEventListener('input', calcularPromedio));
    document.querySelectorAll('#notasForm input, #notasForm textarea').forEach(el => {
        el.addEventListener('input', () => floatingSaveButton.classList.remove('d-none'));
    });
});
</script>
{% endblock %}