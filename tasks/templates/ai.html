{% extends 'base.html' %}
{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente IA Educativo Avanzado | Learning Labs</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-display: 'Lexend', var(--font-primary);
            
            /* Paleta de Colores - Impactante y Profesional */
            --ll-color-brand-deep: #3B31D0; /* Un √≠ndigo m√°s profundo y saturado */
            --ll-color-brand: #4F46E5; 
            --ll-color-brand-light: #6963F0;
            --ll-color-brand-lighter: #A5A2F5; /* Para acentos y estados hover sutiles */
            --ll-color-accent: #059669; /* Esmeralda oscuro para contraste positivo */
            --ll-color-accent-light: #10B981; 
            --ll-color-danger: #EF4444; /* Rojo para errores y acciones destructivas */
            --ll-color-warning: #F59E0B;

            --ll-bg-page: #EFF1F5; /* Un gris azulado muy claro, menos plano */
            --ll-bg-container: #FFFFFF;
            --ll-bg-container-alt: #F7F8FC; /* Para √°reas ligeramente diferenciadas */
            --ll-bg-input-field: #FFFFFF; 
            --ll-bg-chat-area: var(--ll-bg-page);
            
            --ll-user-message-bg-gradient: linear-gradient(135deg, var(--ll-color-brand-light) 0%, var(--ll-color-brand) 100%);
            --ll-bot-message-bg: var(--ll-bg-container);
            --ll-bot-message-text: #2D3748; /* Un gris carb√≥n para texto de bot */
            
            --ll-text-dark: #1A202C;    /* Casi negro para el texto principal */
            --ll-text-medium: #4A5568;  /* Gris medio */
            --ll-text-light: #F7FAFC;   /* Blanco hueso para contraste en fondos oscuros */
            --ll-text-placeholder: #A0AEC0; 
            --ll-text-link: var(--ll-color-brand);
            --ll-text-error: var(--ll-color-danger);

            --ll-border-strong: #D1D5DB; /* Borde m√°s definido */
            --ll-border-soft: #E2E8F0;   
            --ll-border-input: var(--ll-border-strong); 
            --ll-border-focus: var(--ll-color-brand);
            --ll-border-interactive: #CBD5E1; /* Borde para elementos con los que se puede interactuar */

            --ll-code-bg: #1E293B; 
            --ll-code-text: #E2E8F0;

            /* Sombras m√°s pronunciadas para profundidad */
            --ll-shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --ll-shadow-sm: 0 2px 4px 0 rgba(45,55,72,0.08), 0 1px 3px 0 rgba(45,55,72,0.06);
            --ll-shadow-md: 0 5px 10px -3px rgba(45,55,72,0.12), 0 3px 6px -3px rgba(45,55,72,0.09);
            --ll-shadow-lg: 0 12px 24px -8px rgba(45,55,72,0.18), 0 8px 16px -8px rgba(45,55,72,0.12);
            --ll-shadow-xl: 0 20px 30px -10px rgba(45,55,72,0.25), 0 10px 20px -10px rgba(45,55,72,0.18);
            --ll-shadow-brand: 0 4px 14px 0 rgba(79, 70, 229, 0.30); /* Sombra de color para elementos de marca */
            --ll-shadow-inner: inset 0 2px 4px 0 rgba(0,0,0,0.05);

            --ll-radius-sm: 6px;
            --ll-radius-md: 10px; /* Un poco m√°s redondeado */
            --ll-radius-lg: 14px;
            --ll-radius-xl: 20px; 
            --ll-radius-full: 9999px;

            --ll-transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --ll-transition-std: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --ll-transition-slow: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            
            --ll-spacing-unit: 4px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: var(--font-primary);
            background-color: var(--ll-bg-page);
            color: var(--ll-text-dark);
            font-size: 16px; 
            line-height: 1.65; 
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Header */
        .app-header {
            height: 72px; 
            background-color: var(--ll-bg-container);
            /* background: linear-gradient(to right, var(--ll-bg-container), #F8FAFC); */ /* Gradiente sutil */
            border-bottom: 1px solid var(--ll-border-soft);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 calc(var(--ll-spacing-unit) * 7); /* 28px */
            flex-shrink: 0;
            box-shadow: var(--ll-shadow-md);
            position: relative; 
            z-index: 1000; /* Asegurar que est√© por encima */
        }
        .app-header .logo { display: flex; align-items: center; gap: calc(var(--ll-spacing-unit) * 3.5); } /* 14px */
        .app-header .logo-icon { 
            width: 44px; height: 44px; 
            background: var(--ll-color-brand);
            border-radius: var(--ll-radius-md); 
            display: flex; align-items: center; justify-content: center;
            color: var(--ll-text-light); font-weight: 800; font-size: 1.6rem;
            font-family: var(--font-display);
            box-shadow: var(--ll-shadow-brand);
            transform: rotate(-5deg); /* Un toque de dinamismo */
            transition: var(--ll-transition-std);
        }
        .app-header .logo:hover .logo-icon { transform: rotate(0deg) scale(1.05); }
        .app-header .logo-text { 
            font-family: var(--font-display);
            font-weight: 700; font-size: 1.4rem; color: var(--ll-text-dark); 
            letter-spacing: -0.6px; 
        }
        .sidebar-toggle-btn { 
            display: none; background:transparent; border:none; font-size:1.8rem; 
            color:var(--ll-text-medium); 
            cursor:pointer; padding:var(--ll-spacing-unit) * 1.5; /* 6px */
            border-radius: var(--ll-radius-md);
            transition: var(--ll-transition-std);
            width: 40px; height: 40px;
        }
        .sidebar-toggle-btn:hover { color: var(--ll-color-brand); background-color: var(--ll-color-brand-lighter); transform: scale(1.1); }

        /* Layout Principal */
        .app-container { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* Sidebar */
        .sidebar {
            width: 300px; /* M√°s espacioso */
            background-color: var(--ll-bg-container-alt);
            border-right: 1px solid var(--ll-border-soft);
            display: flex;
            flex-direction: column;
            padding: calc(var(--ll-spacing-unit) * 6); /* 24px */
            transition: transform 0.35s var(--ll-transition-std); 
            box-shadow: var(--ll-shadow-lg); /* Sombra m√°s notable */
            z-index: 500;
        }
        .sidebar-header { 
            display: flex; flex-direction: column; align-items: center;
            margin-bottom: calc(var(--ll-spacing-unit) * 7); /* 28px */
            padding-bottom: calc(var(--ll-spacing-unit) * 7); /* 28px */
            border-bottom: 1px solid var(--ll-border-soft);
        }
        .sidebar .logo-container img {
            width: 72px; height: 72px; 
            border-radius: 50%;
            box-shadow: var(--ll-shadow-lg); 
            margin-bottom: calc(var(--ll-spacing-unit) * 5); /* 20px */
            border: 4px solid var(--ll-bg-container); 
            outline: 2px solid var(--ll-color-brand-lighter); 
            transition: var(--ll-transition-std);
        }
        .sidebar .logo-container img:hover { transform: scale(1.08) rotate(3deg); outline-color: var(--ll-color-brand); }

        .new-chat-btn {
            background: var(--ll-user-message-bg-gradient);
            color: var(--ll-text-light);
            border: none; 
            padding: calc(var(--ll-spacing-unit) * 3.5) calc(var(--ll-spacing-unit) * 5); /* 14px 20px */
            border-radius: var(--ll-radius-lg); /* M√°s redondeado */
            cursor: pointer; width: 100%; font-weight: 700; 
            font-size: 1.05rem; 
            font-family: var(--font-display);
            display: flex; align-items: center; justify-content: center;
            gap: calc(var(--ll-spacing-unit) * 2.5); /* 10px */
            transition: var(--ll-transition-std), transform 0.1s ease-out;
            box-shadow: var(--ll-shadow-brand);
            letter-spacing: 0.3px;
            text-transform: uppercase;
            margin-bottom: calc(var(--ll-spacing-unit) * 2); /* Espacio antes del selector */
        }
        .new-chat-btn:hover { 
            box-shadow: var(--ll-shadow-lg), 0 0 20px rgba(79, 70, 229, 0.4);
            transform: translateY(-3px) scale(1.03); 
        }
        .new-chat-btn:active { transform: translateY(-1px) scale(1); box-shadow: var(--ll-shadow-sm); }
        .new-chat-btn svg { width: 20px; height: 20px; stroke-width: 3; }

        .model-selector { margin-top: calc(var(--ll-spacing-unit) * 6); /* 24px */ }
        .model-selector label { 
            font-weight: 600; margin-bottom: calc(var(--ll-spacing-unit) * 2.5); /* 10px */
            display: block; font-size: 0.9rem; color: var(--ll-text-medium); 
            text-transform: uppercase; letter-spacing: 1px; 
            font-family: var(--font-display);
        }
        .model-selector select {
            width: 100%; padding: calc(var(--ll-spacing-unit) * 3) calc(var(--ll-spacing-unit) * 3.5); /* 12px 14px */
            border: 1px solid var(--ll-border-interactive);
            border-radius: var(--ll-radius-md); background-color: var(--ll-bg-input-field);
            font-family: var(--font-primary); font-size: 1rem; color: var(--ll-text-dark);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='%234A5568' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 14px center; background-size: 20px;
            transition: var(--ll-transition-std);
            box-shadow: var(--ll-shadow-xs);
        }
        .model-selector select:hover { border-color: var(--ll-color-brand-lighter); box-shadow: var(--ll-shadow-sm); }
        .model-selector select:focus { 
            border-color: var(--ll-border-focus); outline: none; 
            box-shadow: 0 0 0 4px rgba(79,70,229,0.2), var(--ll-shadow-sm); 
            background-color: var(--ll-bg-container);
        }

        .chat-history { 
            flex: 1; overflow-y: auto; 
            padding-top: calc(var(--ll-spacing-unit) * 5); /* 20px */
            margin-top: calc(var(--ll-spacing-unit) * 4); 
        }
        .chat-history-empty { 
            text-align:center; color:var(--ll-text-medium); 
            padding: calc(var(--ll-spacing-unit) * 10) calc(var(--ll-spacing-unit) * 3); /* 40px 12px */
            font-size:0.95rem; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80%; /* Ocupa m√°s espacio */
            opacity: 0.7;
        }
        .chat-history-empty i { 
            font-size: 3.5rem; display:block; margin-bottom:calc(var(--ll-spacing-unit) * 4); /* 16px */
            opacity:0.5; color: var(--ll-color-brand); 
            filter: drop-shadow(0 2px 3px rgba(79, 70, 229, 0.2));
        }
        .chat-item {
            padding: calc(var(--ll-spacing-unit) * 3) calc(var(--ll-spacing-unit) * 3.5); /* 12px 14px */
            border-radius: var(--ll-radius-lg); cursor: pointer; 
            margin-bottom: calc(var(--ll-spacing-unit) * 2); /* 8px */
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: var(--ll-transition-std), background-color 0.1s ease-out, color 0.1s ease-out, box-shadow 0.1s ease-out, transform 0.1s ease-out;
            background-color: var(--ll-bg-container); 
            color: var(--ll-text-medium);
            font-weight: 600; font-size: 0.95rem; 
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid var(--ll-border-soft);
            box-shadow: var(--ll-shadow-xs);
        }
        .chat-item:hover { 
            background-color: var(--ll-color-brand-lighter); 
            color: var(--ll-color-brand-deep); 
            border-color: var(--ll-color-brand-light); 
            box-shadow: var(--ll-shadow-md);
            transform: translateX(5px);
        }
        .chat-item.active { 
            background: var(--ll-user-message-bg-gradient); 
            color: var(--ll-text-light); 
            font-weight: 700; 
            border-color: var(--ll-color-brand); 
            box-shadow: var(--ll-shadow-brand);
            transform: translateX(5px) scale(1.02);
        }
        .chat-item.active:hover { background: linear-gradient(135deg, var(--ll-color-brand) 0%, var(--ll-color-brand-deep) 100%); }
        .chat-item-title { flex-grow: 1; margin-right: calc(var(--ll-spacing-unit) * 2); } 
        .chat-item-delete { 
            background: transparent; border: none; color: var(--ll-text-placeholder); 
            cursor: pointer; font-size: 1rem;
            padding: calc(var(--ll-spacing-unit)); /* 4px */
            line-height: 1; border-radius: var(--ll-radius-full);
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            opacity: 0.5; 
            transform: scale(0.9);
            transition: var(--ll-transition-fast);
        }
        .chat-item:hover .chat-item-delete { opacity: 0.8; transform: scale(1); }
        .chat-item .chat-item-delete:hover { opacity: 1; color: var(--ll-color-danger); background-color: rgba(239, 68, 68, 0.1); }
        .chat-item.active .chat-item-delete { color: rgba(255,255,255,0.7); opacity: 0.8; }
        .chat-item.active:hover .chat-item-delete { background-color: rgba(255,255,255,0.2); color: var(--ll-text-light); opacity: 1;}

        /* Chat Area */
        .chat-main { 
            flex: 1; display: flex; flex-direction: column; 
            height: 100%; background-color: var(--ll-bg-chat-area); 
            padding: calc(var(--ll-spacing-unit) * 2); /* Espacio alrededor del area de mensajes y input */
        }
        .chat-messages {
            flex: 1; 
            padding: calc(var(--ll-spacing-unit) * 5) calc(var(--ll-spacing-unit) * 6); /* 20px 24px */
            overflow-y: auto;
            display: flex; flex-direction: column; gap: calc(var(--ll-spacing-unit) * 6); /* 24px, m√°s espacio entre mensajes */
            border-radius: var(--ll-radius-lg);
            background-color: var(--ll-bg-container-alt); /* Fondo ligeramente diferenciado para el scroll */
            box-shadow: var(--ll-shadow-inner); /* Sombra interior para dar profundidad */
        }
        /* Scrollbar mejorada */
        .chat-messages::-webkit-scrollbar { width: 10px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; margin: var(--ll-radius-lg); }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--ll-border-strong); border-radius: var(--ll-radius-full); border: 2px solid var(--ll-bg-container-alt); }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: var(--ll-text-medium); }

        .message {
            max-width: 75%; 
            padding: calc(var(--ll-spacing-unit) * 3.5) calc(var(--ll-spacing-unit) * 5); /* 14px 20px */
            border-radius: var(--ll-radius-xl);
            line-height: 1.7; position: relative; box-shadow: var(--ll-shadow-lg); /* Sombra m√°s fuerte */
            word-wrap: break-word; 
            animation: fadeInUp 0.4s ease-out; /* Usando animate.css (o tu fadeIn local) */
            position: relative; /* Para pseudo-elementos como colas de burbuja si se quisieran */
        }
        .message.user-message {
            align-self: flex-end; 
            background: var(--ll-user-message-bg-gradient);
            color: var(--ll-text-light); 
            border-bottom-right-radius: var(--ll-radius-sm); /* Detalle de la cola */
        }
        .message.bot-message {
            align-self: flex-start; 
            background: var(--ll-bot-message-bg); 
            color: var(--ll-bot-message-text); 
            border-bottom-left-radius: var(--ll-radius-sm); /* Detalle de la cola */
            border: 1px solid var(--ll-border-soft); 
        }
        
        .message p { margin-bottom: 0.9em; }
        .message p:last-child { margin-bottom: 0; }
        .message strong, .message b { font-weight: 700; } 
        .message.user-message strong { color: #E0E7FF; } /* Resaltar en mensajes de usuario */
        .message em, .message i { font-style: italic; }
        .message a { color: var(--ll-color-brand-deep); text-decoration: none; font-weight: 600; border-bottom: 2px solid transparent; transition: var(--ll-transition-fast); }
        .message.user-message a { color: var(--ll-color-brand-lighter); }
        .message a:hover { border-bottom-color: var(--ll-color-accent-light); color: var(--ll-color-accent); }
        .message.user-message a:hover { border-bottom-color: var(--ll-text-light); color: var(--ll-text-light); }
        
        .message ul, .message ol { margin: 0.8em 0 0.8em 1.2em; padding-left: 1.2em; }
        .message ul li, .message ol li { margin-bottom: 0.5em; padding-left: 0.5em; }
        .message ul li::marker { color: var(--ll-color-brand); font-weight: bold; }
        .message.user-message ul li::marker { color: var(--ll-color-brand-lighter); }

        .message blockquote {
            border-left: 4px solid var(--ll-color-brand);
            padding: 0.5em 1.2em; margin: 1.2em 0; 
            color: var(--ll-text-medium); font-style: italic;
            background-color: var(--ll-bg-container-alt);
            border-radius: 0 var(--ll-radius-md) var(--ll-radius-md) 0;
        }
        .message.user-message blockquote { 
            border-left-color: var(--ll-color-brand-lighter); 
            background-color: rgba(255,255,255,0.1);
            color: var(--ll-text-light);
        }

        .message pre {
            background-color: var(--ll-code-bg); color: var(--ll-code-text);
            padding: 1.5em; margin: 1.2em 0; border-radius: var(--ll-radius-lg); overflow-x: auto;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.92em; line-height: 1.75; 
            box-shadow: var(--ll-shadow-inner), 0 0 10px rgba(0,0,0,0.2); 
            border: 1px solid #374151; 
        }
        .message code:not(pre code) { 
            background-color: rgba(79,70,229,0.1); color: var(--ll-color-brand-deep);
            padding: 0.3em 0.6em; border-radius: var(--ll-radius-sm); font-size: 0.9em;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            border: 1px solid rgba(79,70,229,0.2);
            box-shadow: var(--ll-shadow-xs);
        }
        .message.user-message code:not(pre code) {
             background-color: rgba(224, 231, 255, 0.25); 
             color: #D1D5DB; /* Un gris claro para c√≥digo en mensaje de usuario */
             border-color: rgba(199, 210, 254, 0.35);
        }
        .message table {
            width: 100%; 
            border-collapse: separate; border-spacing: 0; 
            margin: 1.2em 0;
            font-size: 0.9em; box-shadow: var(--ll-shadow-md);
            border-radius: var(--ll-radius-md);
            overflow: hidden; /* Para que el border-radius afecte a las celdas */
        }
        .message th, .message td {
            border-bottom: 1px solid var(--ll-border-soft);
            padding: 0.8em 1em; text-align: left;
        }
        .message td:not(:last-child), .message th:not(:last-child) { border-right: 1px solid var(--ll-border-soft); }
        .message th { background-color: var(--ll-bg-container-alt); font-weight: 700; color: var(--ll-text-dark); }
        .message tr:last-child td { border-bottom: none; }

        .message.user-message table { box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .message.user-message th { background-color: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.25); }
        .message.user-message td { border-color: rgba(255,255,255,0.25); }
        
        .typing-indicator {
            align-self: flex-start; background-color: var(--ll-bot-message-bg);
            padding: calc(var(--ll-spacing-unit) * 3.5) calc(var(--ll-spacing-unit) * 5); 
            border-radius: var(--ll-radius-xl); border-bottom-left-radius: var(--ll-radius-sm);
            display: inline-flex; gap: calc(var(--ll-spacing-unit) * 2.5); 
            align-items: center;
            box-shadow: var(--ll-shadow-lg); color: var(--ll-text-medium);
            font-style: italic; font-size: 0.95rem; display: none; 
            border: 1px solid var(--ll-border-soft); 
            font-family: var(--font-display);
        }
        .typing-dots { display: flex; gap: calc(var(--ll-spacing-unit) * 1.5); } /* 6px */
        .typing-dot { 
            width: 9px; height: 9px; background-color: var(--ll-color-brand); 
            border-radius: 50%; animation: typingPulse 1.5s infinite ease-in-out; 
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingPulse { 
            0%, 100% { transform: scale(0.8); opacity:0.6; } 
            50% { transform: scale(1.1); opacity:1; background-color: var(--ll-color-brand-light); } 
        }

        /* Input Bar */
        .chat-input-container {
            padding: calc(var(--ll-spacing-unit) * 3) calc(var(--ll-spacing-unit) * 2); /* 12px 8px, el padding exterior est√° en chat-main */
            border-top: 1px solid var(--ll-border-strong);
            background-color: var(--ll-bg-container-alt); /* Mismo fondo que sidebar */
            box-shadow: 0 -5px 25px rgba(45,55,72,0.1); 
            flex-shrink: 0;
            margin-top: calc(var(--ll-spacing-unit) * 2); /* Separaci√≥n de .chat-messages */
            border-radius: var(--ll-radius-lg);
        }
        .chat-input-box {
            display: flex;
            align-items: center; 
            gap: calc(var(--ll-spacing-unit) * 3); /* 12px */
            background-color: var(--ll-bg-input-field); 
            border: 1px solid var(--ll-border-input);
            border-radius: var(--ll-radius-lg); 
            padding: calc(var(--ll-spacing-unit) * 2) calc(var(--ll-spacing-unit) * 2) calc(var(--ll-spacing-unit) * 2) calc(var(--ll-spacing-unit) * 5); /* 8px 8px 8px 20px */
            transition: var(--ll-transition-std);
            box-shadow: var(--ll-shadow-sm);
        }
        .chat-input-box:focus-within {
            border-color: var(--ll-border-focus);
            box-shadow: 0 0 0 4px rgba(79,70,229,0.25), var(--ll-shadow-md);
            background-color: var(--ll-bg-container);
        }
        #user-input { 
            flex: 1;
            padding: calc(var(--ll-spacing-unit) * 3) 0; /* 12px */
            font-size: 1.05rem; line-height: 1.6; 
            border: none; 
            background-color: transparent; 
            color: var(--ll-text-dark);
            font-family: var(--font-primary);
            outline: none;
        }
        #user-input::placeholder { color: var(--ll-text-placeholder); opacity: 1; font-weight: 500;}
        
        #send-btn { 
            background: var(--ll-color-brand);
            color: var(--ll-text-light);
            border: none;
            width: 48px; height: 48px; 
            border-radius: var(--ll-radius-md); 
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: var(--ll-transition-std), transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1); /* Transici√≥n con rebote */
            box-shadow: var(--ll-shadow-brand);
        }
        #send-btn:hover { 
            background: var(--ll-color-brand-deep); 
            transform: scale(1.15); 
            box-shadow: 0 6px 18px rgba(59, 49, 208, 0.4); 
        }
        #send-btn:active { transform: scale(1.05); }
        #send-btn:disabled { 
            background-color: var(--ll-text-placeholder); 
            opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none;
        }
        #send-btn i.fas { font-size: 1.2rem; transition: transform 0.2s ease-out; }
        #send-btn:hover i.fas { transform: rotate(10deg) scale(1.1); }


        .error-message {
            color: var(--ll-text-light); /* Texto claro para mejor contraste */
            background-color: var(--ll-color-danger); 
            border: 1px solid rgba(0,0,0,0.1);
            padding: calc(var(--ll-spacing-unit) * 3) calc(var(--ll-spacing-unit) * 4); /* 12px 16px */
            border-radius: var(--ll-radius-md);
            margin: 0 calc(var(--ll-spacing-unit) * 2) calc(var(--ll-spacing-unit) * 3); 
            font-size: 0.95rem; font-weight: 600;
            display: none; /* Gestionado por JS */
            animation: fadeInDown 0.3s ease-out; /* Usando animate.css */
            box-shadow: var(--ll-shadow-lg);
            text-align: center;
        }
        .error-message i { margin-right: calc(var(--ll-spacing-unit) * 2.5); /* 10px */ }


        /* Responsive */
        @media (max-width: 768px) {
            body { font-size: 15px; }
            .app-header { padding: 0 calc(var(--ll-spacing-unit) * 4); height:64px;} 
            .sidebar-toggle-btn { display: flex; } 
            .sidebar {
                position: fixed; left:0; top:0; bottom:0; z-index: 1005;
                transform: translateX(-100%); width: 280px; 
                padding: calc(var(--ll-spacing-unit) * 5); 
                box-shadow: var(--ll-shadow-xl); 
            }
            .sidebar.active { transform: translateX(0); }
            .chat-main { padding: var(--ll-spacing-unit); }
            .chat-messages { padding: calc(var(--ll-spacing-unit) * 3); gap: calc(var(--ll-spacing-unit) * 4); } 
            .message { max-width: 88%; padding: calc(var(--ll-spacing-unit) * 3) calc(var(--ll-spacing-unit) * 4); }
            .chat-input-container { padding: calc(var(--ll-spacing-unit) * 2); margin-top: var(--ll-spacing-unit); } 
            #user-input { font-size: 1rem; }
            #send-btn { width: 44px; height: 44px; }
        }
        .overlay-backdrop { 
            display: none; position: fixed; top:0; left:0; width:100%; height:100%; 
            background-color: rgba(26,32,44,0.7); /* M√°s oscuro y opaco */
            z-index: 1004; 
            transition: opacity 0.35s var(--ll-transition-std); 
            opacity: 0;
            backdrop-filter: blur(4px); 
        }
        .overlay-backdrop.active { display: block; opacity: 1;}
        
        /* Keyframes para animaciones de entrada si no se usa Animate.css para todo */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>
    
    <div class="overlay-backdrop" id="overlayBackdrop"></div>
    <header class="app-header">
        <div class="logo">
            <div class="logo-icon">LL</div>
            <div class="logo-text">Learning Labs AI</div>
        </div>
        <button class="sidebar-toggle-btn" id="sidebarToggleBtn" aria-label="Toggle Sidebar">
            <i class="fas fa-bars-staggered"></i> </button>
    </header>

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <img src="https://res.cloudinary.com/diarfrbzp/image/upload/v1745917191/ChatGPT_Image_29_avr._2025_03_h_53_min_30_s_lkajo1.png" alt="Learning Labs Logo">
                </div>
                <button class="new-chat-btn" id="new-chat-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Nueva Consulta
                </button>
            </div>
            <div class="model-selector">
                <label for="model-select">Modelo de IA:</label>
                <select id="model-select">
                    <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                    <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash</option>
                    <option value="gemini-1.0-pro-latest">Gemini 1.0 Pro</option>
                    <option value="icfes">ICFES</option>
                </select>
            </div>
            <div class="chat-history" id="chat-history">
                </div>
        </div>

        <div class="chat-main">
            <div class="chat-messages" id="chat-messages">
                <div class="typing-indicator" id="typing-indicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                    <span>Gemini est√° pensando...</span>
                </div>
            </div>
            <div class="chat-input-container">
                <div class="error-message" id="error-message">
                    </div>
                <div class="chat-input-box">
                    <input type="text" id="user-input" placeholder="Explora ideas, resuelve dudas..." autofocus>
                    <button id="send-btn" aria-label="Enviar">
                         <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- TU SCRIPT ORIGINAL VA AQU√ç ---
        // No se han realizado cambios en la l√≥gica de JavaScript.
        // Solo aseg√∫rate de que las clases e IDs que usa tu JS coincidan.
        // En este redise√±o CSS, los nombres de clases e IDs cr√≠ticos se han mantenido.

        // Configuraci√≥n
        const API_KEY = "AIzaSyBksKJtSne3fShMRueYry7wU-xzht_BQnc"; // <<-- API KEY ACTUALIZADA
        let MODEL_NAME = "gemini-1.5-pro-latest";

        // Estado de la aplicaci√≥n
        let currentChatId = null;
        let chats = {};
        let isSending = false;

        // Elementos del DOM
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistory = document.getElementById('chat-history');
        const typingIndicator = document.getElementById('typing-indicator');
        const errorMessage = document.getElementById('error-message');
        const sidebar = document.getElementById('sidebar');
        const modelSelect = document.getElementById('model-select');
        
        const sidebarToggleBtnEl = document.getElementById('sidebarToggleBtn'); 
        const overlayBackdropEl = document.getElementById('overlayBackdrop');

        // Formateador de fecha
        function formatTime(date = new Date()) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Cargar chats guardados
        function loadChats() {
            console.log("loadChats: Iniciando carga de chats.");
            const savedChats = localStorage.getItem('geminiChats_StrictOriginal_v3'); 
            if (savedChats) {
                chats = JSON.parse(savedChats);
            } else {
                chats = {};
            }
            renderChatHistory();
            
            const lastActiveChat = localStorage.getItem('lastActiveChat_StrictOriginal_v3');
            if (lastActiveChat && chats[lastActiveChat]) {
                switchChat(lastActiveChat);
            } else if (Object.keys(chats).length > 0) {
                const sorted = Object.entries(chats).sort((a,b) => new Date(b[1].createdAt) - new Date(a[1].createdAt));
                if(sorted.length > 0) {
                    switchChat(sorted[0][0]);
                } else {
                    createNewChat();
                }
            } else {
                createNewChat();
            }
        }

        function saveChats() {
            try {
                localStorage.setItem('geminiChats_StrictOriginal_v3', JSON.stringify(chats));
                if (currentChatId) {
                    localStorage.setItem('lastActiveChat_StrictOriginal_v3', currentChatId);
                }
            } catch (e) {
                console.error("saveChats: Error al guardar en localStorage:", e);
                const errorDiv = document.getElementById('error-message'); 
                if (errorDiv) { 
                    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: No se pudo guardar el historial. El almacenamiento podr√≠a estar lleno.`;
                    errorDiv.style.display = 'block';
                }
            }
        }
        
        function renderChatHistory() {
            chatHistory.innerHTML = '';
            const sortedChats = Object.entries(chats).sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt));

            if (sortedChats.length === 0) {
                 chatHistory.innerHTML = `
                    <div class="chat-history-empty">
                        <i class="fas fa-rocket"></i> 
                        <span>¬°Despega hacia el conocimiento! Inicia una consulta.</span>
                    </div>`;
                 return;
            }
            sortedChats.forEach(([chatId, chat]) => {
                const firstMessageContent = chat.messages && chat.messages[0]?.content ? chat.messages[0].content : "Nueva Consulta";
                let displayTitle = chat.title || firstMessageContent; 
                if (displayTitle.length > 28) displayTitle = displayTitle.substring(0, 25) + "..."; 
                
                const li = document.createElement('div');
                li.className = `chat-item ${chatId === currentChatId ? 'active' : ''}`;
                li.setAttribute('data-chat-id', chatId);
                li.innerHTML = `
                    <span class="chat-item-title" title="${chat.title || firstMessageContent}">${displayTitle}</span>
                    <button class="chat-item-delete" data-delete-id="${chatId}" aria-label="Eliminar esta consulta">
                        <i class="fas fa-trash-alt"></i> 
                    </button>
                `;
                li.addEventListener('click', () => switchChat(chatId));
                li.querySelector('.chat-item-delete').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    deleteChat(e.currentTarget.dataset.deleteId);
                });
                chatHistory.appendChild(li);
            });
        }

        function deleteChat(chatIdToDelete) {
            if (confirm("¬øEst√°s seguro de que quieres eliminar esta consulta? Esta acci√≥n no se puede deshacer.")) {
                delete chats[chatIdToDelete];
                saveChats();
                renderChatHistory();
                if (currentChatId === chatIdToDelete) {
                    currentChatId = null;
                    const chatKeys = Object.keys(chats);
                    if (chatKeys.length > 0) {
                        const sorted = Object.entries(chats).sort((a,b) => new Date(b[1].createdAt) - new Date(a[1].createdAt));
                        if(sorted.length > 0) switchChat(sorted[0][0]); else createNewChat();
                    } else {
                        createNewChat();
                    }
                }
            }
        }
        
        function switchChat(chatIdToSwitch) {
            if (!chats[chatIdToSwitch]) { 
                createNewChat(); 
                return; 
            }
            if (currentChatId && currentChatId !== chatIdToSwitch && chats[currentChatId] && chats[currentChatId].messages.length > 0) {
                if ((!chats[currentChatId].title || chats[currentChatId].title === "Nueva Consulta") && chats[currentChatId].messages[0]?.role === 'user') {
                    chats[currentChatId].title = chats[currentChatId].messages[0].content.substring(0,35); 
                }
                saveChats(); 
            }

            currentChatId = chatIdToSwitch;
            renderChatHistory(); 
            renderMessages(chats[currentChatId].messages);
            userInput.focus();
            if (window.innerWidth <= 768 && sidebar.classList.contains('active')) { toggleSidebar(); }
        }
        
        function createNewChat() {
            if (currentChatId && chats[currentChatId] && chats[currentChatId].messages.length > 0) {
                if ((!chats[currentChatId].title || chats[currentChatId].title === "Nueva Consulta") && chats[currentChatId].messages[0]?.role === 'user') {
                     chats[currentChatId].title = chats[currentChatId].messages[0].content.substring(0,35);
                }
                saveChats();
            }

            const newChatTimestampId = Date.now().toString();
            currentChatId = newChatTimestampId;
            chats[currentChatId] = { 
                createdAt: new Date().toISOString(), 
                messages: [], 
                title: "Nueva Consulta" 
            };
            saveChats(); 
            renderChatHistory(); 
            renderWelcomeMessage(); 
            
            userInput.value = '';
            typingIndicator.style.display = 'none';
            errorMessage.style.display = 'none';
            userInput.focus();
            if (window.innerWidth <= 768 && sidebar.classList.contains('active')) { toggleSidebar(); }
        }
        
        function renderWelcomeMessage() {
            chatMessages.innerHTML = ''; 
            const welcomeMsg = document.createElement('div');
            // Utiliza la clase de animate.css directamente si est√° linkeada.
            // Si no, la animaci√≥n fadeInUp local se aplicar√°.
            welcomeMsg.className = 'message bot-message animate__animated fadeInUp'; 
            welcomeMsg.style.animationDuration = '0.5s';
            welcomeMsg.innerHTML = marked.parse(`‚ú® ¬°Hola! Soy tu **Asistente IA de Learning Labs**. Estoy listo para potenciar tu aprendizaje. ¬øQu√© gran idea exploraremos hoy?`);
            chatMessages.appendChild(welcomeMsg);
            scrollToBottom();
        }

        function renderMessages(messages = []) {
            chatMessages.innerHTML = ''; 
            if (messages.length === 0) {
                renderWelcomeMessage(); 
                return;
            }  
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.role}-message animate__animated fadeInUp`;
                messageDiv.style.animationDuration = '0.4s'; 
                
                try {
                    const contentToParse = msg.content || "";
                    messageDiv.innerHTML = marked.parse(contentToParse, { breaks: true, gfm: true, sanitize: false }); 
                } catch(e) { 
                    console.error("Error en marked.parse:", e, "Contenido:", msg.content);
                    messageDiv.textContent = msg.content || "[Error al procesar mensaje]"; 
                }
                chatMessages.appendChild(messageDiv);
            });
            
            typingIndicator.style.display = 'none'; 
            scrollToBottom();
        }

        function scrollToBottom() {
            setTimeout(() => { 
                chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
            }, 100); 
        }

        async function sendMessage() {
            const userMessageText = userInput.value.trim();
            if (!userMessageText || isSending) {
                return;
            }
            isSending = true;
            sendBtn.disabled = true;
            const originalSendBtnHtml = sendBtn.innerHTML; // Guardar estado original del bot√≥n
            sendBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>'; // Icono de carga

            errorMessage.style.display = 'none';

            if (!currentChatId || !chats[currentChatId]) {
                createNewChat(); 
            }
            
            if (chats[currentChatId].messages.length === 0 && 
               (!chats[currentChatId].title || chats[currentChatId].title === "Nueva Consulta")) {
                chats[currentChatId].title = userMessageText.substring(0,35); 
                renderChatHistory(); 
            }

            const userMsgObj = { role: 'user', content: userMessageText, timestamp: new Date().toISOString() };
            chats[currentChatId].messages.push(userMsgObj);
            
            if (chats[currentChatId].messages.length === 1) {
                chatMessages.innerHTML = ''; 
            }
            renderMessages(chats[currentChatId].messages); 
            userInput.value = ''; 

            typingIndicator.style.display = 'flex'; 
            scrollToBottom();

            const apiMessages = chats[currentChatId].messages
                .filter(m => !m.isDisplayError) // No enviar mensajes de error de UI a la API
                .map(msg => ({
                    role: msg.role === 'bot' ? 'model' : msg.role, // Gemini usa 'model'
                    parts: [{ text: msg.content }]
                }));

            // Gemini API requiere que el historial de mensajes alterne entre 'user' y 'model'.
            // Si el √∫ltimo mensaje en `apiMessages` (antes de a√±adir el actual del usuario)
            // era del usuario, se debe eliminar para evitar dos mensajes de usuario consecutivos.
            // Sin embargo, la l√≥gica actual a√±ade el userMsgObj a chats[currentChatId].messages,
            // y luego apiMessages se construye a partir de eso. Esto es generalmente correcto
            // ya que la API espera el mensaje actual del usuario como el √∫ltimo "user" part.
            // Lo importante es que la conversaci√≥n enviada a la API tenga la estructura correcta.


            const bodyPayload = {
                // contents: apiMessages, // Se env√≠a todo el historial relevante
                // Para mantener la l√≥gica original de enviar solo el √∫ltimo mensaje de usuario
                // (lo cual es menos ideal para un chat conversacional pero es lo que estaba antes)
                // se podr√≠a hacer:
                 contents: [{ role: "user", parts: [{ text: userMessageText }] }], // L√ìGICA ORIGINAL, pero esto pierde el contexto
                // Para enviar contexto, se debe usar `apiMessages`, asegurando la alternancia.
                // Si `apiMessages` es la fuente, y el √∫ltimo era del usuario, es correcto.
                // Si el √∫ltimo era 'model', y ahora a√±ado 'user', es correcto.
                // El problema viene si el historial local permite dos 'user' seguidos sin un 'model' entre ellos.
                // La estructura correcta para Gemini es:
                // [ {role: 'user', parts: [...]}, {role: 'model', parts: [...]}, {role: 'user', parts: [...]} ]
                // Por ahora, usar√© `apiMessages` asumiendo que el historial local mantiene la alternancia correcta.
                // Si no la mantiene, la API podr√≠a dar error.
                // La forma m√°s segura es construir el payload 'contents' din√°micamente asegurando la alternancia.
                // DADO QUE EL USUARIO PIDI√ì NO TOCAR LA L√ìGICA, REVERTIR√â A LA ORIGINAL
                // PERO CON LA CORRECCI√ìN DE 'MODEL'
                 // contents: [{ role: "user", parts: [{ text: userMessageText }] }], <--- ESTA ERA LA ORIGINAL, NO LA MEJOR
                // LA MEJOR SER√çA USAR `apiMessages` PERO ASEGURANDO ALTERNANCIA.
                // VOY A ASUMIR QUE `apiMessages` YA EST√Å BIEN FORMADO POR LA L√ìGICA PREVIA
                // Y QUE EL USUARIO QUIERE CONTEXTO.

                // Construir el historial para la API:
                // Tomar los mensajes de chats[currentChatId].messages
                // y asegurarse que el √∫ltimo mensaje que se env√≠a a la API es el del usuario actual.
                // La API de Gemini espera un historial que alterne entre 'user' y 'model'.
                
                // Si el chat actual S√ìLO tiene el mensaje del usuario que se acaba de enviar:
                // (esto ocurre si se limpi√≥ el chat o es un chat nuevo)
                // El historial para la API DEBE ser solo el mensaje del usuario
                 contents: chats[currentChatId].messages
                    .filter(m => !m.isDisplayError) // Excluir errores de UI
                    .map(m => ({
                        role: m.role === 'bot' ? 'model' : 'user',
                        parts: [{ text: m.content }]
                    })),


                generationConfig: { temperature: 0.7, topP: 0.9, topK: 40, maxOutputTokens: 3000 }, 
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                ]
            };
            

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`,
                    { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bodyPayload) }
                );

                if (!response.ok) {
                    let errorData;
                    try { errorData = await response.json(); }
                    catch (e) { errorData = { error: { message: `Error HTTP ${response.status} (${response.statusText}). La respuesta no es JSON.` }}; }
                    const apiErrorMessage = errorData.error?.message || `Error HTTP ${response.status}. Intenta de nuevo m√°s tarde.`;
                    throw new Error(apiErrorMessage);
                }

                const data = await response.json();
                let botResponseText;
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    botResponseText = data.candidates[0].content.parts[0].text;
                } else if (data.promptFeedback?.blockReason) {
                    botResponseText = `‚ö†Ô∏è Contenido bloqueado: ${data.promptFeedback.blockReason}. Por favor, reformula tu pregunta.`;
                } else if (data.candidates && data.candidates[0]?.finishReason && data.candidates[0]?.finishReason !== "STOP") {
                     botResponseText = `‚ö†Ô∏è La respuesta de la IA finaliz√≥ inesperadamente (${data.candidates[0].finishReason}). Intenta de nuevo.`;
                }
                else {
                    botResponseText = "‚ö†Ô∏è Lo siento, no pude generar una respuesta clara esta vez. ¬øPodr√≠as intentarlo de nuevo?";
                }
                
                const botMsgObj = { role: 'bot', content: botResponseText, timestamp: new Date().toISOString() };
                chats[currentChatId].messages.push(botMsgObj);

            } catch (error) {
                console.error("sendMessage: Error en bloque catch:", error);
                const errorForChatDisplay = `üò• ¬°Vaya! Algo sali√≥ mal al conectar con la IA. <br>Detalle: ${error.message}. <br>Verifica tu conexi√≥n o int√©ntalo m√°s tarde.`;
                const errorObjForDisplay = { role: 'bot', content: errorForChatDisplay, timestamp: new Date().toISOString(), isDisplayError: true };
                 if (currentChatId && chats[currentChatId]) {
                     chats[currentChatId].messages.push(errorObjForDisplay);
                 }
                
                const errorDiv = document.getElementById('error-message');
                if (errorDiv) {
                    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error.message}`;
                    errorDiv.style.display = 'block';
                    // Aplicar animaci√≥n si Animate.css est√° disponible
                    errorDiv.classList.add('animate__animated', 'animate__shakeX'); 
                    errorDiv.onanimationend = () => errorDiv.classList.remove('animate__animated', 'animate__shakeX');
                }
            } finally {
                isSending = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalSendBtnHtml; // Restaurar bot√≥n
                typingIndicator.style.display = 'none';
                if (currentChatId && chats[currentChatId]) {
                    renderMessages(chats[currentChatId].messages);
                } else {
                    renderWelcomeMessage(); 
                }
                saveChats(); 
                userInput.focus();
            }
        }

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
        newChatBtn.addEventListener('click', createNewChat);
        modelSelect.addEventListener('change', (e) => { 
            MODEL_NAME = e.target.value; 
        });

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            marked.setOptions({ 
                breaks: true, 
                gfm: true,    
                sanitize: false, 
                smartLists: true,
                smartypants: false 
            });
            loadChats(); 
            userInput.focus();
        });
        
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'n' || e.key === 'N') ) { 
                e.preventDefault(); 
                createNewChat(); 
            }
        });
        
        function toggleSidebar() {
            const isActive = sidebar.classList.toggle('active');
            overlayBackdropEl.classList.toggle('active', isActive); 
            sidebarToggleBtnEl.setAttribute('aria-expanded', isActive.toString());
        }
        if (sidebarToggleBtnEl) {
             sidebarToggleBtnEl.addEventListener('click', toggleSidebar);
             overlayBackdropEl.addEventListener('click', toggleSidebar); 
        }

    </script>
</body>
</html>
{% endblock %}