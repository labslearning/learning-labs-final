<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Labs - Plataforma Educativa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Sistema de diseño educativo */
            --edu-primary: #4361ee;
            --edu-secondary: #3f37c9;
            --edu-accent: #4cc9f0;
            --edu-light: #f8f9fa;
            --edu-dark: #212529;
            --edu-success: #38b000;
            --edu-warning: #ff9e00;
            --edu-danger: #ef233c;
            --edu-text-primary: #2b2d42;
            --edu-text-secondary: #6c757d;
            --edu-bg-light: #f8f9fa;
            --edu-bg-dark: #343a40;
            --edu-border-radius: 12px;
            --edu-box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            --edu-transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body {
            font-family: 'Open Sans', sans-serif;
            color: var(--edu-text-primary);
            background-color: var(--edu-bg-light);
            line-height: 1.6;
            padding-top: 0;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--edu-dark);
        }

        /* ========== BARRA DE NAVEGACIÓN MEJORADA ========== */
        .navbar {
            background: linear-gradient(135deg, var(--edu-primary), var(--edu-secondary));
            padding: 0.8rem 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-family: 'Poppins', sans-serif;
            position: relative;
            z-index: 1000;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.8rem;
            color: white !important;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .navbar-brand img {
            height: 40px;
            width: auto;
        }

        .navbar-brand:hover {
            opacity: 0.9;
        }

        .nav-item {
            margin: 0 0.25rem;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            font-size: 0.95rem;
            padding: 0.75rem 1.25rem;
            border-radius: var(--edu-border-radius);
            transition: var(--edu-transition);
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link i {
            font-size: 1.1rem;
        }

        .nav-link:hover, .nav-link:focus {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2) !important;
            font-weight: 600;
            color: white !important;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 3px;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .nav-link:hover::after, .nav-link.active::after {
            width: 60%;
        }

        .navbar-toggler {
            border: none;
            padding: 0.5rem;
        }

        .navbar-toggler:focus {
            box-shadow: none;
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255, 255, 255, 0.9)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        @media (max-width: 991.98px) {
            .navbar-collapse {
                background-color: rgba(63, 55, 201, 0.98);
                margin-top: 1rem;
                border-radius: var(--edu-border-radius);
                padding: 1rem;
                box-shadow: var(--edu-box-shadow);
                backdrop-filter: blur(10px);
            }

            .nav-link {
                padding: 0.8rem 1rem;
                margin: 0.25rem 0;
            }

            .nav-link::after {
                display: none;
            }
        }

        /* ========== BOTONES EDUCATIVOS ========== */
        .btn-edu {
            border-radius: var(--edu-border-radius);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: var(--edu-transition);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: none;
            font-family: 'Poppins', sans-serif;
        }

        .btn-edu:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-edu-primary {
            background-color: var(--edu-primary);
            color: white;
        }

        .btn-edu-primary:hover {
            background-color: var(--edu-secondary);
            color: white;
        }

        .btn-edu-secondary {
            background-color: var(--edu-accent);
            color: var(--edu-dark);
        }

        .btn-edu-secondary:hover {
            background-color: #3ab7d8;
            color: var(--edu-dark);
        }

        /* ========== TARJETAS EDUCATIVAS ========== */
        .edu-card {
            border: none;
            border-radius: var(--edu-border-radius);
            box-shadow: var(--edu-box-shadow);
            transition: var(--edu-transition);
            overflow: hidden;
            background-color: white;
            margin-bottom: 1.5rem;
        }

        .edu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
        }

        .edu-card-header {
            background-color: var(--edu-primary);
            color: white;
            padding: 1.25rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        .edu-card-body {
            padding: 1.5rem;
        }

        /* ========== CHAT DE IA MEJORADO ========== */
        .ai-chat-button {
            position: fixed;
            right: 30px;
            bottom: 30px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--edu-primary), var(--edu-secondary));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(67, 97, 238, 0.3);
            z-index: 1050;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1.8rem;
            border: none;
        }

        .ai-chat-button:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 28px rgba(67, 97, 238, 0.4);
        }

        .ai-chat-container {
            font-family: 'Open Sans', sans-serif;
            position: fixed;
            right: 0;
            top: 0;
            width: 400px;
            max-width: 90%;
            height: 100%;
            background-color: white;
            border-radius: 0;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 1060;
            overflow: hidden;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .ai-chat-container.active {
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto;
        }

        .ai-chat-header {
            padding: 1.25rem;
            background: linear-gradient(135deg, var(--edu-primary), var(--edu-secondary));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .ai-chat-title {
            font-weight: 600;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .ai-chat-actions {
            display: flex;
            gap: 0.75rem;
        }

        .ai-chat-action {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.3rem;
            opacity: 0.8;
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-chat-action:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .ai-chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-color: #f5f7fb;
        }

        .ai-message {
            max-width: 85%;
            padding: 1rem 1.25rem;
            border-radius: 1.25rem;
            line-height: 1.6;
            animation: fadeIn 0.35s ease-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 0.75rem;
            position: relative;
        }

        .ai-message-icon {
            flex-shrink: 0;
            margin-top: 3px;
            color: var(--edu-primary);
        }

        .ai-message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--edu-primary), var(--edu-secondary));
            color: white;
            border-bottom-right-radius: 0.5rem;
        }

        .ai-message-bot {
            align-self: flex-start;
            background-color: white;
            color: var(--edu-text-primary);
            border: 1px solid #e1e8ed;
            border-bottom-left-radius: 0.5rem;
        }

        .ai-message-time {
            font-size: 0.7rem;
            color: var(--edu-text-secondary);
            opacity: 0.8;
            margin-top: 0.5rem;
            text-align: right;
        }

        .ai-chat-input-container {
            padding: 1.25rem;
            border-top: 1px solid #e1e8ed;
            background-color: white;
            position: relative;
            flex-shrink: 0;
        }

        .ai-chat-input {
            width: 100%;
            padding: 1rem 3.5rem 1rem 1.25rem;
            border: 1px solid #e1e8ed;
            border-radius: var(--edu-border-radius);
            resize: none;
            outline: none;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.95rem;
            min-height: 60px;
            max-height: 120px;
            line-height: 1.5;
            color: var(--edu-text-primary);
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
        }

        .ai-chat-input:focus {
            border-color: var(--edu-primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .ai-chat-send {
            position: absolute;
            right: 1.5rem;
            bottom: 1.5rem;
            background: linear-gradient(135deg, var(--edu-primary), var(--edu-secondary));
            color: white;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.1rem;
        }

        .ai-chat-send:hover {
            transform: scale(1.1);
        }

        .ai-typing-indicator {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            align-self: flex-start;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            background-color: white;
            border: 1px solid #e1e8ed;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            color: var(--edu-text-secondary);
            font-size: 0.85rem;
            font-style: italic;
        }

        .ai-typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--edu-text-secondary);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out both;
        }

        .ai-model-selector {
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            margin-left: 0.75rem;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            font-family: 'Open Sans', sans-serif;
            outline: none;
            transition: all 0.2s ease;
        }

        .ai-model-selector:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }

        .ai-model-selector option {
            background-color: white;
            color: var(--edu-text-primary);
        }

        @keyframes typingAnimation {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1.0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== MODAL DE VIDEO MEJORADO ========== */
        .video-modal {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(30, 35, 40, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            opacity: 0;
            transition: opacity 0.35s ease, visibility 0s linear 0.35s;
            pointer-events: none;
            visibility: hidden;
            backdrop-filter: blur(8px);
        }

        .video-modal.active {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
            transition: opacity 0.35s ease;
        }

        .video-modal-content-wrapper {
            background-color: white;
            border-radius: var(--edu-border-radius);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .video-modal.active .video-modal-content-wrapper {
            transform: scale(1);
        }

        .video-modal-header {
            padding: 1.25rem 1.5rem;
            background-color: var(--edu-primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-modal-header h5 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .video-modal-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0.25rem;
            line-height: 1;
            opacity: 0.8;
            transition: all 0.2s ease;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-modal-close:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .video-modal-body {
            flex: 1;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #222;
            overflow-y: auto;
            border-radius: 0 0 var(--edu-border-radius) var(--edu-border-radius);
        }

        .video-modal-body video {
            display: block;
            width: 100%;
            height: auto;
            max-height: calc(90vh - 130px);
            outline: none;
        }

        .video-error-display {
            padding: 2rem;
            text-align: center;
            color: var(--edu-text-secondary);
        }

        .video-error-display .error-icon {
            font-size: 3rem;
            color: var(--edu-danger);
            margin-bottom: 1rem;
        }

        .video-error-display h5 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--edu-text-primary);
            margin-bottom: 0.75rem;
        }

        .video-error-display p {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 0;
        }

        .video-modal-footer {
            padding: 1rem 1.5rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e1e8ed;
            text-align: right;
            border-radius: 0 0 var(--edu-border-radius) var(--edu-border-radius);
        }

        /* ========== EFECTOS ESPECIALES ========== */
        .edu-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
        }

        /* ========== RESPONSIVIDAD ADICIONAL ========== */
        @media (max-width: 768px) {
            .navbar {
                padding: 0.75rem 1.5rem;
            }
            
            .navbar-brand {
                font-size: 1.5rem;
            }
            
            .ai-chat-button {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
                right: 20px;
                bottom: 20px;
            }
            
            .nav-link {
                font-size: 0.9rem;
                padding: 0.6rem 0.8rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-atom"></i>
                <span>Learning Labs</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a href="/" class="nav-link"><i class="fas fa-home"></i> Inicio</a>
                    <a href="/ai" class="nav-link"><i class="fas fa-robot"></i> AI</a>
                    
                    {% if user.is_authenticated %}
                        {% if user.perfil.rol == 'DOCENTE' %}
                        <a href="{% url 'dashboard_docente' %}" class="nav-link">
                            <i class="fas fa-clipboard-list"></i> Notas
                        </a>
                        {% endif %}
                        
                        <a href="/english" class="nav-link"><i class="fas fa-language"></i> Inglés</a>
                        <a href="/english2" class="nav-link"><i class="fas fa-square-root-alt"></i> Matemáticas</a>
                        <a href="/english3" class="nav-link"><i class="fas fa-code"></i> Programación</a>
                        <a href="/english4" class="nav-link"><i class="fas fa-gamepad"></i> Juegos</a>
                        <a href="/forum" class="nav-link"><i class="fas fa-comments"></i> Foro</a>
                        
                        {% if user.perfil.rol == 'ESTUDIANTE' %}
                        <a href="{% url 'dashboard_estudiante' %}" class="nav-link">
                            <i class="fas fa-user-graduate"></i> Mi Panel
                        </a>
                        {% elif user.perfil.rol == 'DOCENTE' %}
                        <a href="{% url 'dashboard_docente' %}" class="nav-link">
                            <i class="fas fa-chalkboard-teacher"></i> Panel Docente
                        </a>
                        {% elif user.perfil.rol == 'ADMINISTRADOR' %}
                        <a href="{% url 'admin_dashboard' %}" class="nav-link">
                            <i class="fas fa-user-tie"></i> Admin
                        </a>
                        {% elif user.perfil.rol == 'ACUDIENTE' %} {# Añadido para acudiente #}
                        <a href="{% url 'dashboard_acudiente' %}" class="nav-link">
                             <i class="fas fa-user-shield"></i> Panel Acudiente
                        </a>
                        {% endif %}
                        
                        <a href="/logout" class="nav-link"><i class="fas fa-sign-out-alt"></i> Salir</a>
                    {% else %}
                        <a href="/signup" class="nav-link"><i class="fas fa-user-plus"></i> Registro</a>
                        <a href="/signin" class="nav-link"><i class="fas fa-sign-in-alt"></i> Ingresar</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    {# El contenido específico de cada página se inserta aquí #}
    {% block content %}
    {% endblock %}

    <button class="ai-chat-button edu-pulse" id="aiChatButton">
        <i class="fas fa-comment-dots"></i>
    </button>
    
    <div class="ai-chat-container" id="aiChatContainer">
        <div class="ai-chat-header">
            <div class="ai-chat-title">
                <i class="fas fa-robot"></i>
                <span>Asistente Educativo</span>
                <select class="ai-model-selector" id="aiModelSelector">
                    <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                    <option value="gemini-1.0-pro-latest">Gemini 1.0</option>
                </select>
            </div>
            <div class="ai-chat-actions">
                <button class="ai-chat-action" id="aiChatNewChat" title="Nueva conversación">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="ai-chat-action" id="aiChatClose" title="Cerrar chat">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            </div>
        <div class="ai-chat-input-container">
            <textarea class="ai-chat-input" id="aiChatInput" placeholder="Escribe tu pregunta educativa..."></textarea>
            <button class="ai-chat-send" id="aiChatSend" title="Enviar mensaje">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div class="video-modal" id="videoModal">
        <div class="video-modal-content-wrapper">
            <div class="video-modal-header">
                <h5><i class="fas fa-play-circle"></i> <span id="videoModalTitle">Clase Educativa</span></h5>
                <button class="video-modal-close" id="videoModalClose" title="Cerrar video">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="video-modal-body" id="videoModalBody">
                </div>
            <div class="video-modal-footer">
                <button class="btn btn-edu btn-edu-secondary" id="videoModalCloseBtn">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    {# --- ORDEN DE SCRIPT CORREGIDO --- #}
    
    {# 1. Cargar la biblioteca de Bootstrap PRIMERO #}
    {#    Esto define `window.bootstrap` para que otros scripts puedan usarlo. #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    {# 2. Cargar tu script personalizado DESPUÉS #}
    {#    Ahora este script se ejecutará y encontrará `window.bootstrap` ya definido. #}
    <script>
        // Configuración de Gemini y lógica del Chat AI y Modal (todo tu script personalizado)
        const API_KEY_CHAT = "AIzaSyCnJVShlWjEe428W0hD24Jzr9GVDeMsajQ"; // Considera mover esto a un lugar más seguro
        let currentAiModel = "gemini-1.5-pro-latest";
        let aiChatHistory = [];

        // Elementos del DOM del Chat AI
        const aiChatButtonEl = document.getElementById('aiChatButton');
        const aiChatContainerEl = document.getElementById('aiChatContainer');
        const aiChatCloseEl = document.getElementById('aiChatClose');
        const aiChatNewChatEl = document.getElementById('aiChatNewChat');
        const aiChatMessagesEl = document.getElementById('aiChatMessages');
        const aiChatInputEl = document.getElementById('aiChatInput');
        const aiChatSendEl = document.getElementById('aiChatSend');
        const aiModelSelectorEl = document.getElementById('aiModelSelector');

        // Elementos del DOM del Modal de Video
        const videoModalEl = document.getElementById('videoModal');
        const videoModalBodyEl = document.getElementById('videoModalBody');
        const videoModalTitleEl = document.getElementById('videoModalTitle');
        const videoModalCloseHeaderEl = document.getElementById('videoModalClose');
        const videoModalCloseFooterBtnEl = document.getElementById('videoModalCloseBtn');

        // Estado del chat
        let isAiChatOpen = false;
        let isAiSending = false;

        // --- Event Listeners ---
        function setupEventListeners() {
            console.log("Base.html: Setting up event listeners...");
            if (aiChatButtonEl) aiChatButtonEl.addEventListener('click', toggleAiChat);
            if (aiChatCloseEl) aiChatCloseEl.addEventListener('click', closeAiChat);
            if (aiChatNewChatEl) aiChatNewChatEl.addEventListener('click', newAiChat);
            if (aiChatSendEl) aiChatSendEl.addEventListener('click', sendAiMessage);
            if (aiModelSelectorEl) aiModelSelectorEl.addEventListener('change', updateAiModel);
            if (aiChatInputEl) {
                aiChatInputEl.addEventListener('keydown', handleChatInputKeydown);
                aiChatInputEl.addEventListener('input', autoResizeChatInput); // Añadido para auto-resize
            }

            if (videoModalCloseHeaderEl) videoModalCloseHeaderEl.addEventListener('click', closeVideoModal);
            if (videoModalCloseFooterBtnEl) videoModalCloseFooterBtnEl.addEventListener('click', closeVideoModal);

            // Escuchar tecla Escape para cerrar modal/chat
            document.addEventListener('keydown', handleGlobalKeydown);

             // Guardar historial al cerrar la ventana/pestaña
             window.addEventListener('beforeunload', saveAiChatHistory);
             console.log("Base.html: Event listeners setup complete.");
        }

        // --- Funciones del Chat AI ---
        function toggleAiChat() {
            console.log("Toggling AI Chat");
            isAiChatOpen = !isAiChatOpen;
            aiChatContainerEl.classList.toggle('active');
            if (isAiChatOpen && aiChatInputEl) aiChatInputEl.focus();
        }

        function closeAiChat() {
            console.log("Closing AI Chat");
            isAiChatOpen = false;
            aiChatContainerEl.classList.remove('active');
        }

        function newAiChat() {
            console.log("Starting new AI Chat");
            aiChatHistory = [];
            if (aiChatMessagesEl) {
                aiChatMessagesEl.innerHTML = "";
                addAiMessage('bot', '¡Hola! Soy tu asistente educativo. ¿En qué puedo ayudarte hoy?');
            }
            // Limpiar también el input
            if(aiChatInputEl) {
                aiChatInputEl.value = "";
                aiChatInputEl.style.height = 'auto';
            }
        }

        function updateAiModel() {
            currentAiModel = aiModelSelectorEl.value;
            console.log("AI Model changed to:", currentAiModel);
            addAiMessage('bot', `Modelo cambiado a: ${aiModelSelectorEl.options[aiModelSelectorEl.selectedIndex].text}`, true);
        }

        function addAiMessage(role, content, isSystem = false) {
            if (!aiChatMessagesEl) {
                console.error("aiChatMessagesEl not found");
                return;
            }
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ai-message-${role}`;

            let iconHtml = '';
            if (role === 'bot' && !isSystem) {
                iconHtml = `<span class="ai-message-icon"><i class="fas fa-robot"></i></span>`;
            } else if (isSystem) {
                 iconHtml = `<span class="ai-message-icon"><i class="fas fa-info-circle"></i></span>`;
            }

            // Usar 'marked' si está disponible, si no, texto plano
            let parsedContent = content;
            if (typeof marked !== 'undefined' && !isSystem) {
                try {
                    parsedContent = marked.parse(content);
                } catch (e) {
                    console.error("Error parsing markdown:", e, "Original content:", content);
                    // Dejar parsedContent como el texto original si hay error
                }
            } else if (typeof marked === 'undefined' && !isSystem){
                 console.warn("Marked library not found. Displaying raw bot response.");
            }


            messageDiv.innerHTML = `
                ${iconHtml}
                <div>
                    ${parsedContent}
                    <div class="ai-message-time">${formatChatTime()}</div>
                </div>
            `;

            aiChatMessagesEl.appendChild(messageDiv);
            scrollAiToBottom();

            if (!isSystem) {
                // Adaptado para historial compatible con la API (role: user/model, parts: [{text: content}])
                aiChatHistory.push({ role: role === 'user' ? 'user' : 'model', parts: [{ text: content }], timestamp: new Date().toISOString() }); 
            }
        }


        async function sendAiMessage() {
            if (!aiChatInputEl || !aiChatSendEl || !aiChatMessagesEl) return;
            const message = aiChatInputEl.value.trim();
            if (!message || isAiSending) return;

            console.log("Sending message to AI:", message);
            isAiSending = true;
            aiChatSendEl.disabled = true;
            aiChatSendEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            aiChatInputEl.disabled = true; // Deshabilitar input mientras envía

            // Añadir mensaje del usuario al historial y UI ANTES de la llamada API
            addAiMessage('user', message); // Esto ya añade al historial con el rol correcto 'user'
            aiChatInputEl.value = "";
            aiChatInputEl.style.height = 'auto'; // Resetear altura

            // Mostrar indicador de "pensando"
            const typingIndicatorEl = document.createElement('div');
            typingIndicatorEl.className = 'ai-typing-indicator';
            typingIndicatorEl.innerHTML = `
                <div class="ai-typing-dot" style="animation-delay: 0s;"></div>
                <div class="ai-typing-dot" style="animation-delay: .2s;"></div>
                <div class="ai-typing-dot" style="animation-delay: .4s;"></div>
                <span>Asistente está pensando...</span>
            `;
            aiChatMessagesEl.appendChild(typingIndicatorEl);
            scrollAiToBottom();

            // Preparar historial para la API (usando la versión actualizada de aiChatHistory)
            const apiHistory = aiChatHistory.slice(-21, -1).map(msg => ({ // Enviar hasta 20 mensajes anteriores (excluyendo el actual del user)
                role: msg.role, // 'user' o 'model' ya están correctos en el historial
                parts: msg.parts
            }));

            // El mensaje actual del usuario
             const currentUserMessage = { role: 'user', parts: [{ text: message }] };

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${currentAiModel}:generateContent?key=${API_KEY_CHAT}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            // Enviar el historial adaptado más el mensaje actual al final
                            contents: [...apiHistory, currentUserMessage], 
                            generationConfig: {
                                temperature: 0.7, topP: 0.9, topK: 40, maxOutputTokens: 2048
                            },
                            safetySettings: [ // Configuración de seguridad recomendada
                                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                            ]
                        })
                    }
                );

                // Quitar indicador SIEMPRE
                if(typingIndicatorEl && typingIndicatorEl.parentNode) {
                    typingIndicatorEl.remove();
                }

                if (!response.ok) {
                    const errorText = await response.text(); // Leer como texto para ver el error exacto
                    console.error("API Error Response Text:", errorText);
                    let errorMsg = `Error HTTP ${response.status}`;
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMsg = errorData.error?.message || errorMsg;
                    } catch(e) { /* Ignorar error de parseo si no es JSON */ }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                console.log("API Response Data:", data); // Log para ver la respuesta completa

                // Validar la estructura de la respuesta
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
                    const botResponse = data.candidates[0].content.parts[0].text;
                    addAiMessage('bot', botResponse); // Esto añade la respuesta del bot al historial
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                     const blockReason = data.promptFeedback.blockReason;
                     const safetyRatings = data.promptFeedback.safetyRatings ? JSON.stringify(data.promptFeedback.safetyRatings) : 'N/A';
                     console.warn(`Respuesta bloqueada por: ${blockReason}. Ratings: ${safetyRatings}`);
                     addAiMessage('bot', `Mi respuesta fue bloqueada debido a políticas de seguridad (${blockReason}). Por favor, reformula tu pregunta.`, true);
                     // No añadir mensaje bloqueado al historial persistente
                     aiChatHistory.pop(); // Quitar el mensaje del usuario que causó el bloqueo
                } else {
                    // Si no hay candidatos ni bloqueo claro, mostrar mensaje genérico
                    console.warn("Respuesta inesperada de la API:", data);
                    addAiMessage('bot', 'No se pudo obtener una respuesta clara del asistente en este momento.', true);
                     // No añadir respuesta inesperada al historial persistente
                     aiChatHistory.pop(); // Quitar el mensaje del usuario
                }

            } catch (error) {
                console.error('Error en sendAiMessage:', error); // Log detallado del error
                if(typingIndicatorEl && typingIndicatorEl.parentNode) typingIndicatorEl.remove(); // Asegurar quitar indicador en error
                addAiMessage('bot', `Lo siento, ocurrió un error al procesar tu solicitud: ${error.message}`, true);
                 // No añadir error al historial persistente
                 aiChatHistory.pop(); // Quitar el mensaje del usuario que causó el error
            } finally {
                isAiSending = false;
                aiChatSendEl.disabled = false;
                aiChatSendEl.innerHTML = `<i class="fas fa-paper-plane"></i>`;
                if (aiChatInputEl) {
                    aiChatInputEl.disabled = false; // Habilitar input de nuevo
                    aiChatInputEl.focus();
                }
            }
        }


        function scrollAiToBottom() {
            // Usar setTimeout para asegurar que el DOM se haya actualizado
            setTimeout(() => {
                if(aiChatMessagesEl) {
                    aiChatMessagesEl.scrollTop = aiChatMessagesEl.scrollHeight;
                }
            }, 50); // Un pequeño delay
        }

        function formatChatTime(dateString = null) {
             const date = dateString ? new Date(dateString) : new Date();
             // Verificar si la fecha es válida
             if (isNaN(date.getTime())) {
                return "--:--"; // Retornar placeholder si la fecha no es válida
             }
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }); // Formato AM/PM
        }

       function loadAiChatHistory() {
            console.log("Loading AI Chat History...");
            const savedHistory = localStorage.getItem('geminiAiChatHistory_v2');
            aiChatMessagesEl.innerHTML = ""; // Limpiar siempre al inicio

            if (savedHistory) {
                try {
                    let parsedHistory = JSON.parse(savedHistory);
                    // Asegurarse que es un array
                    if (!Array.isArray(parsedHistory)) {
                        throw new Error("Saved history is not an array.");
                    }
                    
                    aiChatHistory = parsedHistory; // Asignar al historial global
                    console.log(`Loaded ${aiChatHistory.length} messages from history.`);
                    
                    aiChatHistory.forEach(msg => {
                        // Re-validar estructura al cargar
                        if (!msg || !msg.role || !msg.parts || !msg.parts[0] || typeof msg.parts[0].text === 'undefined') {
                            console.warn("Skipping invalid message from history:", msg);
                            return; // Saltar mensaje inválido
                        }
                        const content = msg.parts[0].text;
                        const role = msg.role === 'user' ? 'user' : 'bot'; // Mapear rol API a rol UI
                        const timestamp = msg.timestamp || new Date().toISOString(); // Usar timestamp guardado o actual

                        const messageDiv = document.createElement('div');
                        messageDiv.className = `ai-message ai-message-${role}`;
                        let iconHtml = '';
                        if (role === 'bot') {
                            iconHtml = `<span class="ai-message-icon"><i class="fas fa-robot"></i></span>`;
                        }

                        let parsedContent = content;
                        if (typeof marked !== 'undefined' && role === 'bot') { // Solo parsear mensajes del bot
                            try {
                                parsedContent = marked.parse(content);
                            } catch (e) {
                                console.error("Error parsing markdown from history:", e, "Original content:", content);
                                // Mantener contenido original si falla el parseo
                            }
                        }

                        messageDiv.innerHTML = `
                            ${iconHtml}
                            <div>
                                ${parsedContent}
                                <div class="ai-message-time">${formatChatTime(timestamp)}</div>
                            </div>
                        `;
                        aiChatMessagesEl.appendChild(messageDiv);
                    });
                    scrollAiToBottom();
                } catch (e) {
                     console.error("Error parsing chat history from localStorage:", e);
                     localStorage.removeItem('geminiAiChatHistory_v2'); // Eliminar historial corrupto
                     aiChatHistory = []; // Resetear historial en memoria
                     addAiMessage('bot', 'Hubo un problema al cargar el historial. Iniciando nueva conversación.', true);
                }
            } else {
                console.log("No chat history found. Starting fresh.");
                addAiMessage('bot', '¡Hola! Soy tu asistente educativo. ¿En qué puedo ayudarte hoy?', false); // Mensaje inicial no es del sistema
            }
        }

        function saveAiChatHistory() {
             console.log("Saving AI Chat History...");
             try {
                 // Guardar solo mensajes válidos
                 const validHistory = aiChatHistory.filter(msg => msg && msg.role && msg.parts && msg.parts[0] && typeof msg.parts[0].text !== 'undefined');
                localStorage.setItem('geminiAiChatHistory_v2', JSON.stringify(validHistory));
                console.log(`Saved ${validHistory.length} valid messages.`);
             } catch (e) {
                 console.error("Error saving chat history to localStorage:", e);
                 // Considerar notificar al usuario si el localStorage está lleno o hay otro error
             }
        }


        // --- Funciones del Modal de Video ---
        function openVideoModal(videoUrl, videoTitle = "Clase Educativa") {
            if (!videoModalEl || !videoModalBodyEl || !videoModalTitleEl) {
                console.error("Error: Elementos del modal de video no encontrados.");
                return;
            }
            console.log(`Opening video modal for: ${videoTitle} (URL: ${videoUrl})`);

            videoModalTitleEl.textContent = videoTitle;
            videoModalBodyEl.innerHTML = ""; // Limpiar contenido anterior

            if (!videoUrl || videoUrl.trim() === '' || videoUrl.toUpperCase() === 'TU_URL_AQUI') {
                 console.warn("Video URL is missing or invalid.");
                const errorHtml = `
                    <div class="video-error-display">
                        <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <h5>Video No Disponible</h5>
                        <p>El contenido para "<strong>${videoTitle}</strong>" no está disponible en este momento.</p>
                    </div>`;
                videoModalBodyEl.innerHTML = errorHtml;
            } else {
                // Crear elemento de video
                const videoElement = document.createElement('video');
                videoElement.setAttribute('width', '100%');
                videoElement.setAttribute('controls', '');
                videoElement.setAttribute('autoplay', '');
                videoElement.setAttribute('playsinline', '');
                videoElement.style.display = 'block';
                videoElement.style.maxHeight = 'calc(90vh - 130px)'; // Ajustar según altura de header/footer
                videoElement.style.backgroundColor = '#000';

                const sourceElement = document.createElement('source');
                sourceElement.setAttribute('src', videoUrl);
                // Determinar tipo basado en extensión (simple)
                if (videoUrl.toLowerCase().endsWith('.mp4')) {
                    sourceElement.setAttribute('type', 'video/mp4');
                } else if (videoUrl.toLowerCase().endsWith('.webm')) {
                     sourceElement.setAttribute('type', 'video/webm');
                } else if (videoUrl.toLowerCase().endsWith('.ogv')) {
                     sourceElement.setAttribute('type', 'video/ogg');
                } // Añadir más tipos si es necesario
                else {
                     console.warn("Tipo de video desconocido para:", videoUrl, ". Intentando sin 'type'.");
                }

                videoElement.appendChild(sourceElement);
                videoElement.appendChild(document.createTextNode('Tu navegador no soporta la etiqueta de video.')); // Fallback text

                videoModalBodyEl.appendChild(videoElement);

                // Intentar reproducir (autoplay puede fallar)
                videoElement.play().catch(error => {
                    console.log("Autoplay fue prevenido por el navegador:", error);
                    // No es un error crítico, el usuario puede darle play manualmente
                });

                 // Manejo de errores de carga del video
                videoElement.addEventListener('error', (e) => {
                    console.error("Error al cargar el video:", videoUrl, e);
                    videoModalBodyEl.innerHTML = `
                        <div class="video-error-display">
                            <div class="error-icon"><i class="fas fa-times-circle"></i></div>
                            <h5>Error al Cargar Video</h5>
                            <p>No se pudo cargar el video desde la URL proporcionada.</p>
                        </div>`;
                });
            }

            videoModalEl.classList.add('active');
            document.body.style.overflow = 'hidden'; // Evitar scroll de fondo
        }


        function closeVideoModal() {
             console.log("Closing video modal.");
            const videoElement = videoModalBodyEl.querySelector('video');
            if (videoElement) {
                videoElement.pause();
                // Limpiar source para detener descarga
                while (videoElement.firstChild) {
                    videoElement.removeChild(videoElement.firstChild);
                }
                videoElement.load(); // Importante para liberar recursos
                // Opcional: Eliminar el elemento video completamente
                 videoElement.remove();
            }

            videoModalEl.classList.remove('active');
            document.body.style.overflow = ''; // Restaurar scroll

            // Limpiar contenido después de la transición para evitar flashes
            setTimeout(() => {
                if (videoModalBodyEl && !videoModalEl.classList.contains('active')) {
                    videoModalBodyEl.innerHTML = ""; // Limpiar body por si quedó algo
                }
            }, 350); // Coincidir con la duración de la transición CSS
        }


        // --- Handlers de Eventos Globales ---
        function handleChatInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevenir salto de línea
                sendAiMessage();
            }
            // El auto-resize se maneja con 'input'
        }

        function autoResizeChatInput() {
             // Ajustar altura del textarea
            this.style.height = 'auto'; // Resetear altura
            this.style.height = (this.scrollHeight) + 'px'; // Ajustar a contenido
        }

        function handleGlobalKeydown(event) {
            if (event.key === "Escape" || event.key === "Esc") {
                 console.log("Escape key pressed.");
                if (videoModalEl && videoModalEl.classList.contains('active')) {
                    console.log("Closing video modal via Escape key.");
                    closeVideoModal();
                } else if (aiChatContainerEl && aiChatContainerEl.classList.contains('active')) {
                     console.log("Closing AI chat via Escape key.");
                     closeAiChat();
                }
            }
        }

        // --- Inicialización al Cargar el DOM ---
        console.log("Base.html: Script principal iniciando...");
        if (document.readyState === 'loading') {
            // Esperar a que el DOM esté listo
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // Si el DOM ya está listo (raro, pero posible)
            initializeApp();
        }

        function initializeApp() {
            console.log("Base.html: DOMContentLoaded event fired. Running initializeApp().");
            setupEventListeners();

            // Cargar historial del chat AI si el contenedor existe
            if (aiChatContainerEl) {
                loadAiChatHistory();
            } else {
                 console.log("Chat AI container not found on this page.");
            }

            // Configurar Marked si está disponible
            if (typeof marked !== 'undefined') {
                 console.log("Marked library found. Setting options.");
                 marked.setOptions({
                    breaks: true, // Interpretar saltos de línea simples como <br>
                    gfm: true, // Habilitar GitHub Flavored Markdown
                    sanitize: false // ¡CUIDADO! Deshabilitar sanitización.
                });
            } else {
                 console.warn("Marked library is not loaded. AI responses will be shown as plain text.");
            }
            console.log("Base.html: initializeApp() complete.");
        }

    </script>

</body>
</html>