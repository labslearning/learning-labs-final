"""
Django settings for djangocrud project.

Generated by 'django-admin startproject' using Django 5.2.
"""
import os
import dj_database_url
from pathlib import Path
from decouple import config 

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# =========================================================
# üåç CONFIGURACI√ìN DE ENTORNO (RAILWAY vs LOCAL)
# =========================================================
# Definimos esto AL PRINCIPIO para evitar redefiniciones conflictivas
RAILWAY_ENVIRONMENT = config('RAILWAY_ENVIRONMENT', default='')

if RAILWAY_ENVIRONMENT:
    # Configuraci√≥n para Producci√≥n (Nube)
    DEBUG = False
    ALLOWED_HOSTS = ['*']
    CSRF_TRUSTED_ORIGINS = ['https://*.up.railway.app', 'https://web-production-707fc.up.railway.app']
else:
    # Configuraci√≥n para Local (Tu PC)
    DEBUG = True
    ALLOWED_HOSTS = ['*']
    CSRF_TRUSTED_ORIGINS = []

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = config('SECRET_KEY', default='django-insecure-g)e7^67qy$r*nsd+0iy!-vl=k1a9sgg3+!(wddt)h(j^r1j6%p')


# Application definition
INSTALLED_APPS = [
    # ‚ö° Channels debe estar al principio para manejar runserver correctamente
    'channels',
    
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # üõ†Ô∏è Utilidades de Frontend
    'django.contrib.humanize', 

    'tasks.apps.TasksConfig',
    'widget_tweaks',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    "whitenoise.middleware.WhiteNoiseMiddleware", # Para servir archivos est√°ticos
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    # Middleware for forcing password changes
    'tasks.middleware.ForcePasswordChangeMiddleware',
    # üõ°Ô∏è Middleware de Auditor√≠a y Seguridad
    'tasks.middleware.AuditMiddleware',
]

ROOT_URLCONF = 'djangocrud.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        # Path to templates directory
        'DIRS': [BASE_DIR / 'tasks' / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                
                # ===================================================================
                # üöë SOLUCI√ìN AL PROBLEMA DE FOTOS NEGRAS
                # ===================================================================
                'django.template.context_processors.media', # <--- ¬°ESTA L√çNEA FALTABA!
                # ===================================================================

                'tasks.context_processors.datos_globales_usuario', 
            ],
        },
    },
]

# Servidor WSGI (Tradicional)
WSGI_APPLICATION = 'djangocrud.wsgi.application'

# ===================================================================
# ‚ö° FASE III: CONFIGURACI√ìN ASGI Y CHANNELS
# ===================================================================
ASGI_APPLICATION = 'djangocrud.asgi.application'

# Configuraci√≥n de Capas de Canales (Channel Layers) - L√≥gica Unificada
REDIS_URL = config('REDIS_URL', default=None)

if REDIS_URL:
    CHANNEL_LAYERS = {
        "default": {
            "BACKEND": "channels_redis.core.RedisChannelLayer",
            "CONFIG": {"hosts": [REDIS_URL]},
        },
    }
else:
    CHANNEL_LAYERS = {
        "default": {
            "BACKEND": "channels.layers.InMemoryChannelLayer",
        }
    }


# ===================================================================
# üóÑÔ∏è BASE DE DATOS (L√≥gica Unificada)
# ===================================================================
DATABASE_URL = config('DATABASE_URL', default=None)

if DATABASE_URL:
    # Si estamos en Railway
    DATABASES = {
        'default': dj_database_url.config(default=DATABASE_URL, conn_max_age=1800)
    }
else:
    # Si estamos en Local
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.postgresql',
            'NAME': config('DB_NAME', default='learning_labs_db'),
            'USER': config('DB_USER', default='postgres'),
            'PASSWORD': config('DB_PASSWORD', default='password'),
            'HOST': config('DB_HOST', default='localhost'),
            'PORT': config('DB_PORT', default='5432'),
        }
    }


# High security password hashers (Argon2)
PASSWORD_HASHERS = [
    'django.contrib.auth.hashers.Argon2PasswordHasher',
    'django.contrib.auth.hashers.PBKDF2PasswordHasher',
    'django.contrib.auth.hashers.PBKDF2SHA1PasswordHasher',
    'django.contrib.auth.hashers.BCryptSHA256PasswordHasher',
]

# Password validation
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
        'OPTIONS': {
            'min_length': 8,
        }
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True


# ===================================================================
# ü©∫ CONFIGURACI√ìN DE ARCHIVOS EST√ÅTICOS Y MEDIA
# ===================================================================

STATIC_URL = 'static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

# Configuraci√≥n Media (Donde se suben las fotos)
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# ===================================================================


# Default primary key field type
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# Authentication paths
LOGIN_URL = '/signin/'
LOGIN_REDIRECT_URL = '/'
DEFAULT_TEMP_PASSWORD = '123456'


# ==============================================================
# CONFIGURACI√ìN DE INTELIGENCIA ARTIFICIAL (Fase 4)
# ==============================================================
# Llave configurada manualmente como solicitaste
DEEPSEEK_API_KEY = "sk-f4b636146a9147feb7c4e73e6e24d8f3"
AI_MODEL_NAME = "deepseek-chat"